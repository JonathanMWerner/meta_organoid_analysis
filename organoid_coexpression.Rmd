
Generating organoid co-expression networks

```{r}

library(Seurat)
library(reticulate)
library(knitr)
library(matrixStats)
library(data.table)
library(ggplot2)
library(MetaMarkers)
library(dplyr)
library(MetBrewer)
library(ComplexHeatmap)
library(circlize)

np <- import("numpy")
```



```{r}
get_celltype_ranked_markers = function(metamarkers, celltype, num_markers, metric = 'rank'){
  
  if(metric != 'rank'){
    celltype_data = filter(metamarkers, cell_type == celltype) %>% arrange(desc(!!as.name(metric)))
    return(celltype_data[1:num_markers, ])}
  else{
    return(filter(metamarkers, cell_type == celltype & rank <= num_markers))
  }
}
```


Fetal markers
```{r}

test_markers = list(
    fan_fu = read_markers("fan_fu_fetal_class_markers.csv.gz"), 
    poliodakis_1 = read_markers("poliodakis_batch1_fetal_class_markers.csv.gz"),
    poliodakis_2 = read_markers("poliodakis_batch2_fetal_class_markers.csv.gz"),
    GW14 = read_markers("areal_GW14_fetal_class_markers.csv.gz"),
    GW18_2 = read_markers("areal_GW18_2_fetal_class_markers.csv.gz"),
    GW19 = read_markers("areal_GW19_fetal_class_markers.csv.gz"),
    GW19_2 = read_markers("areal_GW19_2_fetal_class_markers.csv.gz"),
    GW20 = read_markers("areal_GW20_fetal_class_markers.csv.gz"),
    GW20_31 = read_markers("areal_GW20_31_fetal_class_markers.csv.gz"),
    GW20_34 = read_markers("areal_GW20_34_fetal_class_markers.csv.gz"),
    GW25 = read_markers("areal_GW25_fetal_class_markers.csv.gz"),
    linnarsson_GW5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW5_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW5-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_6_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-6_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_6_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-6_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_7 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-7_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_3 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_3_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_4 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_4_fetal_class_markers_v3.csv.gz"), 
    linnarsson_GW7 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW7_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW7_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW7-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_3 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8_3_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_point_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8-1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_point_5_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8-5_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_point_5_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8-5_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW9_point_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW9-2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW9_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW9-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW10 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW10_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW11_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW11-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW12 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW12_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW13 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW13_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW14 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW14_fetal_class_markers_v3.csv.gz")
    )

fetal_meta_markers = make_meta_markers(test_markers, detailed_stats = TRUE)

gaba_markers = get_celltype_ranked_markers(fetal_meta_markers, 'GABAergic',100, 'rank')
glut_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Glutamatergic',100, 'rank')
nProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Neural_Progenitor',100, 'rank')
nonN_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Non-neuronal',100, 'rank')
intProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Intermediate_Progenitor',100, 'rank')
divProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Dividing_Progenitor',100, 'rank')


#save metamarkers for later
export_meta_markers(fetal_meta_markers, "../data/metamarkers/fetal_meta_markers.csv", names(test_markers))
test_meta_markers = read_meta_markers("../data/metamarkers/fetal_meta_markers.csv.gz")
test_meta_markers
```


organoid dataset metadata
```{r}

load('../data/seurat_objs/all_data_just_meta_seurat.Rdata')
dim(all_sample_meta)

all_sample_meta

sum(as.numeric(all_sample_meta$num_cells_filt))
```


Now filter the networks to just include the go genes, same gene universe across all datasets/coexpression networks

```{r}
library(org.Hs.eg.db)
library(EGAD)
library(AnnotationDbi)

#GO database from GOSOURCEDATE: 2023-01-01, it's tied to the version of R. current version of R is 4.3.1
org.Hs.eg.db #running this will print out the GO database version information
go_table <- as.data.frame(org.Hs.egGO2ALLEGS) #gene mapping to the direct GO term and that term's children
go_table$gene_symbol = mapIds(org.Hs.eg.db, go_table$gene_id, "SYMBOL","ENTREZID") #Add gene symbol 
annotations <- make_annotations(go_table[,c("gene_symbol", "go_id")], unique(go_table$gene_symbol), unique(go_table$go_id))
dim(annotations)

go_genes = unique(go_table$gene_symbol)
length(go_genes)
go_terms = unique(go_table$go_id)
length(go_terms)
```



```{r}
source_python('python_coexpression.py')
```

```{r}
for(i in 1:nrow(all_sample_meta)){
 
  start = Sys.time()
  load(all_sample_meta$processed_seurat_path[[i]])
  dataset_genes = rownames(dataset)
  #Filter for the GO gene universe
  dataset_genes_in_go = dataset_genes[dataset_genes %in% go_genes]
  dataset_genes_missing_from_go = go_genes[! go_genes %in% dataset_genes]
  #Subset the gene expression for the genes present in GO
  dataset_gene_index = dataset_genes %in% dataset_genes_in_go
  exp_data = as.matrix(dataset@assays$RNA@data[dataset_gene_index, ])
  #Add zero counts for the missing GO genes
  go_missing = matrix(0, nrow = length(dataset_genes_missing_from_go), ncol = ncol(exp_data), 
                      dimnames = list(dataset_genes_missing_from_go, colnames(exp_data)))
  exp_data = rbind(exp_data, go_missing)
  r_genes = rownames(exp_data)

  #Get coexpression data
  test_py_exp = np$array(exp_data) #Turn R matrix into numpy array
  python_script_test = get_coexpression(test_py_exp, r_genes) #Python method for spearman correlations, coexpression
  corr_matrix = as.matrix(python_script_test) #Turn to matrix
  #Convert Nans to 0, these are genes with 0 expression in any cells
  corr_matrix[!is.finite(corr_matrix)] = 0
  
  file_name = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/%s_coexp.Rdata', all_sample_meta$sample_ids[i])
  save(corr_matrix, file = file_name)
  end = Sys.time()
  print(end - start)
  print(sprintf('Done getting coexpression from %i dataset...', i))
  
  #Rank the coexpression data
  #Rank everything, I want the minimum rank to be 1, so ties are minimum. Subtracting 1 sets the minimum rank to 0
  rank_corr = frank(c(corr_matrix), ties.method = 'min') - 1
  #Divide by max rank squeezes everything between 0 and 1
  norm_rank_corr = rank_corr / max(rank_corr)
  #Put back into a matrix
  rank_corr_matrix = matrix(norm_rank_corr, nrow = nrow(corr_matrix), ncol = ncol(corr_matrix), 
                            dimnames = list(rownames(corr_matrix), colnames(corr_matrix)))
  diag(rank_corr_matrix) = 1
  
  file_name = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata', all_sample_meta$sample_ids[i])
  save(rank_corr_matrix, file =file_name)
  end = Sys.time()
  print(end - start)
  print(sprintf('Done ranking coexpression from %i dataset...', i))  
  
}
```



#################
Pasca lab organoids, 3 untransplanted, 3 transplanted into rat brains

###############



```{r}
pasca_files = c('../data/seurat_objs/individual/non_trans_pasca_org_batch_1_seurat_processed.Rdata',
                '../data/seurat_objs/individual/non_trans_pasca_org_batch_2_seurat_processed.Rdata',
                '../data/seurat_objs/individual/non_trans_pasca_org_batch_3_seurat_processed.Rdata',
                '../data/seurat_objs/individual/trans_pasca_org_batch_1_seurat_processed.Rdata',
                '../data/seurat_objs/individual/trans_pasca_org_batch_2_seurat_processed.Rdata',
                '../data/seurat_objs/individual/trans_pasca_org_batch_3_seurat_processed.Rdata',
                '../data/seurat_objs/individual/non_trans_pasca_org_full_seurat_processed.Rdata',
                '../data/seurat_objs/individual/trans_pasca_org_full_seurat_processed.Rdata')

pasca_names = c('non_trans_pasca_org_batch_1', 'non_trans_pasca_org_batch_2', 'non_trans_pasca_org_batch_3',
                'trans_pasca_org_batch_1', 'trans_pasca_org_batch_2', 'trans_pasca_org_batch_3',
                'non_trans_pasca_org_full','trans_pasca_org_full')

for(i in 1:8){
 
  start = Sys.time()
  x = load(pasca_files[i])
  dataset = get(x)
  rm(x)
  dataset_genes = rownames(dataset)
  #Filter for the GO gene universe
  dataset_genes_in_go = dataset_genes[dataset_genes %in% go_genes]
  dataset_genes_missing_from_go = go_genes[! go_genes %in% dataset_genes]
  #Subset the gene expression for the genes present in GO
  dataset_gene_index = dataset_genes %in% dataset_genes_in_go
  exp_data = as.matrix(dataset@assays$RNA@data[dataset_gene_index, ])
  #Add zero counts for the missing GO genes
  go_missing = matrix(0, nrow = length(dataset_genes_missing_from_go), ncol = ncol(exp_data), 
                      dimnames = list(dataset_genes_missing_from_go, colnames(exp_data)))
  exp_data = rbind(exp_data, go_missing)
  r_genes = rownames(exp_data)

  #Get coexpression data
  test_py_exp = np$array(exp_data) #Turn R matrix into numpy array
  python_script_test = get_coexpression(test_py_exp, r_genes) #Python method for spearman correlations, coexpression
  corr_matrix = as.matrix(python_script_test) #Turn to matrix
  #Convert Nans to 0, these are genes with 0 expression in any cells
  corr_matrix[!is.finite(corr_matrix)] = 0
  
  file_name = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/%s_coexp.Rdata', pasca_names[i])
  save(corr_matrix, file = file_name)
  end = Sys.time()
  print(end - start)
  print(sprintf('Done getting coexpression from %i dataset...', i))
  
  #Rank the coexpression data
  #Rank everything, I want the minimum rank to be 1, so ties are minimum. Subtracting 1 sets the minimum rank to 0
  rank_corr = frank(c(corr_matrix), ties.method = 'min') - 1
  #Divide by max rank squeezes everything between 0 and 1
  norm_rank_corr = rank_corr / max(rank_corr)
  #Put back into a matrix
  rank_corr_matrix = matrix(norm_rank_corr, nrow = nrow(corr_matrix), ncol = ncol(corr_matrix), 
                            dimnames = list(rownames(corr_matrix), colnames(corr_matrix)))
  diag(rank_corr_matrix) = 1
  
  file_name = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata', pasca_names[i])
  save(rank_corr_matrix, file =file_name)
  end = Sys.time()
  print(end - start)
  print(sprintf('Done ranking coexpression from %i dataset...', i))  
  
}
```


```{r}

#Get colors
class_palette = met.brewer("Archambault", 20)
class_marker_palette = c('Fetal Non-neuronal marker' = class_palette[20], 'Fetal GABAergic marker' = class_palette[1], 
                         'Fetal Glutamatergic marker' = class_palette[14], 
                         'Fetal Neural Progenitor marker' = class_palette[4],
                         'Fetal Intermediate Progenitor marker' = class_palette[16],
                         'Fetal Dividing Progenitor marker' = class_palette[10],
                         'non-marker' = 'white')
  
```


```{r}
coexp_file = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/%s_coexp.Rdata',pasca_names[8])

load(coexp_file)

all_marker_genes = c(gaba_markers$gene, glut_markers$gene, nProg_markers$gene, nonN_markers$gene, intProg_markers$gene, divProg_markers$gene)

corr_matrix = corr_matrix[rownames(corr_matrix) %in% all_marker_genes, colnames(corr_matrix) %in% all_marker_genes ]
dim(corr_matrix)

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(corr_matrix))
fetal_marker_annot_vec[rownames(corr_matrix) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(corr_matrix) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(corr_matrix) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(corr_matrix) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(corr_matrix) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(corr_matrix) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

Sys.time()
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
h_map = Heatmap(corr_matrix, show_row_names = F, show_column_names = F, col = col_fun, name = 'spearman', column_title = 'organoid_coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T)
draw(h_map)

Sys.time()



```





check the variation of annotations across the organoid datasets. Annotations they come with, the amount left in each coexpression network when I filter out non-expressed genes
and the overlap of GO genes when I do both

```{r}
num_ori_missing_go = vector(mode = 'numeric', length = nrow(all_sample_meta))
num_filt_missing_go = vector(mode = 'numeric', length = nrow(all_sample_meta))
num_ori_vec = vector(mode = 'numeric', length = nrow(all_sample_meta))
num_filt_vec = vector(mode = 'numeric', length = nrow(all_sample_meta))

for(i in 1:nrow(all_sample_meta)){

  load(all_sample_meta$processed_seurat_path[i])
  #Original number of gene annotations
  num_ori_annot = nrow(dataset)
  ncells = ncol(dataset)
  #number of genes left after my filtering
  gene_index = rowSums(dataset@assays$RNA@data > 0) >= (ncells*.001)
  num_filt_annot = length(rownames(dataset)[gene_index])
  
  #Number of genes in each set in the go gene universe
  num_ori_missing_go[i] = length(go_genes) - sum(rownames(dataset) %in% go_genes)
  num_filt_missing_go[i] = length(go_genes) - sum(rownames(dataset)[gene_index] %in% go_genes)
  num_ori_vec[i] = num_ori_annot
  num_filt_vec[i] = num_filt_annot
  
  print(i)
}



hist(num_ori_vec)
hist(num_filt_vec)
hist(num_ori_missing_go)
hist(num_filt_missing_go)


```
check how many of the fetal metamarkers (also in go) are present in the original dataset's annotations and then how many are left out after filtering. 
These left out ones are going to be put back in as zeros during zero padding

```{r}

go_nProg = filter(nProg_markers, gene %in% go_genes )$gene
length(go_nProg)
go_divProg = filter(divProg_markers, gene %in% go_genes )$gene
length(go_divProg)
go_intProg = filter(intProg_markers, gene %in% go_genes )$gene
length(go_intProg)
go_gaba = filter(gaba_markers, gene %in% go_genes )$gene
length(go_gaba)
go_glut = filter(glut_markers, gene %in% go_genes )$gene
length(go_glut)
go_nonN = filter(nonN_markers, gene %in% go_genes )$gene
length(go_nonN)

missing_full_nProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_filt_nProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
nonExp_nProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_full_divProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_filt_divProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
nonExp_divProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_full_intProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_filt_intProg = vector(mode = 'numeric', length = nrow(all_sample_meta))
nonExp_intProg = vector(mode = 'numeric', length = nrow(all_sample_meta))

missing_full_gaba = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_filt_gaba = vector(mode = 'numeric', length = nrow(all_sample_meta))
nonExp_gaba = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_full_glut = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_filt_glut = vector(mode = 'numeric', length = nrow(all_sample_meta))
nonExp_glut = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_full_nonN = vector(mode = 'numeric', length = nrow(all_sample_meta))
missing_filt_nonN = vector(mode = 'numeric', length = nrow(all_sample_meta))
nonExp_nonN = vector(mode = 'numeric', length = nrow(all_sample_meta))

for(i in 1:nrow(all_sample_meta)){

  load(all_sample_meta$processed_seurat_path[i])
  ncells = ncol(dataset)
  gene_index = rowSums(dataset@assays$RNA@data > 0) >= (ncells*.001)
  
  #Number missing markers from full datasets annotations
  missing_full_nProg[i] = length(go_nProg) - sum(go_nProg %in% rownames(dataset))
  #number of markers missing after I filter for non expressed genes
  missing_filt_nProg[i] = length(go_nProg) - sum(go_nProg %in% rownames(dataset)[gene_index])
  #Number of marker genes not expressed
  nonExp_nProg[i] = missing_filt_nProg[i] - missing_full_nProg[i]
  
  #Number missing markers from full datasets annotations
  missing_full_divProg[i] = length(go_divProg) - sum(go_divProg %in% rownames(dataset))
  #number of markers missing after I filter for non expressed genes
  missing_filt_divProg[i] = length(go_divProg) - sum(go_divProg %in% rownames(dataset)[gene_index])
  #Number of marker genes not expressed
  nonExp_divProg[i] = missing_filt_divProg[i] - missing_full_divProg[i]

  #Number missing markers from full datasets annotations
  missing_full_intProg[i] = length(go_intProg) - sum(go_intProg %in% rownames(dataset))
  #number of markers missing after I filter for non expressed genes
  missing_filt_intProg[i] = length(go_intProg) - sum(go_intProg %in% rownames(dataset)[gene_index])
  #Number of marker genes not expressed
  nonExp_intProg[i] = missing_filt_intProg[i] - missing_full_intProg[i]
  
  #Number missing markers from full datasets annotations
  missing_full_gaba[i] = length(go_gaba) - sum(go_gaba %in% rownames(dataset))
  #number of markers missing after I filter for non expressed genes
  missing_filt_gaba[i] = length(go_gaba) - sum(go_gaba %in% rownames(dataset)[gene_index])
  #Number of marker genes not expressed
  nonExp_gaba[i] = missing_filt_gaba[i] - missing_full_gaba[i]
  
  #Number missing markers from full datasets annotations
  missing_full_glut[i] = length(go_glut) - sum(go_glut %in% rownames(dataset))
  #number of markers missing after I filter for non expressed genes
  missing_filt_glut[i] = length(go_glut) - sum(go_glut %in% rownames(dataset)[gene_index])
  #Number of marker genes not expressed
  nonExp_glut[i] = missing_filt_glut[i] - missing_full_glut[i]

  #Number missing markers from full datasets annotations
  missing_full_nonN[i] = length(go_nonN) - sum(go_nonN %in% rownames(dataset))
  #number of markers missing after I filter for non expressed genes
  missing_filt_nonN[i] = length(go_nonN) - sum(go_nonN %in% rownames(dataset)[gene_index])
  #Number of marker genes not expressed
  nonExp_nonN[i] = missing_filt_nonN[i] - missing_full_nonN[i]

  print(i)
  
  
}
  
  
```


```{r}

go_nProg = filter(nProg_markers, gene %in% go_genes )$gene
length(go_nProg)
go_divProg = filter(divProg_markers, gene %in% go_genes )$gene
length(go_divProg)
go_intProg = filter(intProg_markers, gene %in% go_genes )$gene
length(go_intProg)
go_gaba = filter(gaba_markers, gene %in% go_genes )$gene
length(go_gaba)
go_glut = filter(glut_markers, gene %in% go_genes )$gene
length(go_glut)
go_nonN = filter(nonN_markers, gene %in% go_genes )$gene
length(go_nonN)

```




```{r}

#Get colors
class_palette = met.brewer("Archambault", 20)
class_marker_palette = c('Fetal Non-neuronal marker' = class_palette[20], 'Fetal GABAergic marker' = class_palette[1], 
                         'Fetal Glutamatergic marker' = class_palette[14], 
                         'Fetal Neural Progenitor marker' = class_palette[4],
                         'Fetal Intermediate Progenitor marker' = class_palette[16],
                         'Fetal Dividing Progenitor marker' = class_palette[10],
                         'non-marker' = 'white')
  
```




```{r}
coexp_file = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/%s_coexp.Rdata',all_sample_meta$sample_ids[110])

load(coexp_file)

all_marker_genes = c(gaba_markers$gene, glut_markers$gene, nProg_markers$gene, nonN_markers$gene, intProg_markers$gene, divProg_markers$gene)

corr_matrix = corr_matrix[rownames(corr_matrix) %in% all_marker_genes, colnames(corr_matrix) %in% all_marker_genes ]
dim(corr_matrix)

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(corr_matrix))
fetal_marker_annot_vec[rownames(corr_matrix) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(corr_matrix) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(corr_matrix) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(corr_matrix) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(corr_matrix) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(corr_matrix) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

Sys.time()
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))
h_map = Heatmap(corr_matrix, show_row_names = F, show_column_names = F, col = col_fun, name = 'spearman', column_title = 'organoid_coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T)
draw(h_map)

Sys.time()



```

Check how many marker genes are in each network
can delete this

```{r}
num_glut = vector(mode = 'numeric', length = nrow(all_sample_meta) )
num_gaba = vector(mode = 'numeric', length = nrow(all_sample_meta) )
num_nProg = vector(mode = 'numeric', length = nrow(all_sample_meta) )
num_nonN = vector(mode = 'numeric', length = nrow(all_sample_meta) )

for(i in 1:nrow(all_sample_meta)){

  gc()
  coexp_file = sprintf('/home/werner/projects/meta_qc_organoid/data/coexpression/organoid/%s_coexp.Rdata',all_sample_meta$sample_ids[i])
  load(coexp_file)
  
  num_glut[i] = sum(rownames(corr_matrix) %in% glut_markers$gene)
  num_gaba[i] = sum(rownames(corr_matrix) %in% gaba_markers$gene)
  num_nProg[i] = sum(rownames(corr_matrix) %in% nProg_markers$gene)
  num_nonN[i] = sum(rownames(corr_matrix) %in% nonN_markers$gene)
  print(i)
  
}


org_num_markers_present_df = data.frame(dataset = all_sample_meta$sample_ids, num_glut = num_glut, num_gaba = num_gaba, num_nProg = num_nProg, num_nonN = num_nonN )
org_num_markers_present_df
```


```{r}
nrow(all_sample_meta)

```




Run Egad on each individual coexp network


```{r}
all_dataset_egad = vector(mode = 'list', length =nrow(all_sample_meta))
names(all_dataset_egad) = all_sample_meta$sample_ids[1:nrow(all_sample_meta)]

for(i in 1: nrow(all_sample_meta)){
  
  start = Sys.time()
  #Clear loose memory
  gc()
  
  #Load coexpression network
  coexp_file = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata',all_sample_meta$sample_ids[i])
  load(coexp_file)
  current_dataset = all_sample_meta$sample_ids[i]
  
  #Get all genes in the coexpression matrix
  genelist <- rownames(rank_corr_matrix)
  #GO term annotations
  annotations <- make_annotations(go_table[,c("gene_symbol", "go_id")], unique(go_table$gene_symbol), unique(go_table$go_id))
  #Get marker annotations
  annot_vec = c(as.numeric(genelist %in% gaba_markers$gene), as.numeric(genelist %in% glut_markers$gene),
                as.numeric(genelist %in% nonN_markers$gene),as.numeric(genelist %in% nProg_markers$gene),
                as.numeric(genelist %in% intProg_markers$gene),as.numeric(genelist %in% divProg_markers$gene))
  marker_annotations = matrix(annot_vec, nrow = length(genelist), ncol = 6, byrow = F, 
                              dimnames = list(genelist, c('gaba_markers','glut_markers','nonN_markers','nProg_markers', 'intProg_markers', 'divProg_markers')))
  
  # Run GBA 
  GO_groups_voted <- run_GBA(rank_corr_matrix, annotations, nfold = 3)
  #EGAD for the class marker genes
  marker_groups_voted <- run_GBA(rank_corr_matrix, marker_annotations, nfold = 3)
  
  #Get AUCs of all GO groups
  # neighbor voting AUROCs
  auc_GO_nv = GO_groups_voted[[1]][,1]
  # node degree AUCs
  auc_GO_nd = GO_groups_voted[[1]][,3]
  
  #Get AUCs of the marker groups
  # neighbor voting AUROCs
  auc_marker_nv = marker_groups_voted[[1]][,1]
  # node degree AUCs
  auc_marker_nd = marker_groups_voted[[1]][,3]
  
  #Get NA matrix for all the missing goterms for this dataset
  missing_go = go_terms[!go_terms %in% rownames(GO_groups_voted[[1]])]
  
  missing_matrix = matrix(data = NA, nrow = length(missing_go), ncol = 3, 
                          dimnames = list(missing_go, colnames(GO_groups_voted[[1]])))
  #Add and reorder so everything is consistent across datasets
  all_goterms = rbind(GO_groups_voted[[1]], missing_matrix)
  all_goterms  = all_goterms[match(go_terms, rownames(all_goterms)), ]
  
  #Add the marker results
  egad_results = rbind(all_goterms, marker_groups_voted[[1]])
  #colnames(egad_results) = paste(current_dataset,colnames(egad_results), sep = '_')
  
  #Add a column with the dataset name
  egad_results = cbind(egad_results, dataset = current_dataset)
  all_dataset_egad[[i]] = egad_results
  
  end = Sys.time()
  print(end - start)
  print(sprintf('Done with %i datasets...', i))
  
}
```


```{r}

test = do.call(rbind, all_dataset_egad)
test = as.data.frame(test)
test$goterms = rep(c(as.character(go_terms), 'gaba_markers','glut_markers','nonN_markers','nProg_markers','intProg_markers','divProg_markers'), length(all_dataset_egad))
test = reshape2::melt(test, id = c('goterms', 'dataset'))
test$value = as.numeric(test$value)
table(test$dataset)
test
```


Results on the ranked networks with just the go_genes
```{r}
organoid_egad_results = test
#save(organoid_egad_results, 
#     file = '/home/werner/projects/meta_qc_organoid/data/coexpression/organoid/organoid_egad_results_just_go_ranked.Rdata')

#save(organoid_egad_results, 
#     file = '/home/werner/projects/meta_qc_organoid/data/coexpression/organoid/organoid_egad_results_just_go_ranked_v2.Rdata')

#save(organoid_egad_results, 
#     file = '../data/coexpression/organoid/organoid_egad_results_ranked_10_12_22.Rdata')

#save(organoid_egad_results, 
#     file = '../data/coexpression/organoid/organoid_egad_results_ranked_1_16_23.Rdata')

save(organoid_egad_results, 
     file = '../data/coexpression/organoid/organoid_egad_results_ranked_8_17_23.Rdata')
```


load in the fetal egad performance as well, the unannotated fetal datasets too

```{r}

load('../data/coexpression/organoid/organoid_egad_results_ranked_8_17_23.Rdata')
load('../data/coexpression/fetal/fetal_egad_results_ranked_8_17_23.Rdata')
load('../data/coexpression/fetal/unannot_fetal_egad_results_ranked_8_17_23.Rdata')
```




get average performance across the goterms for the datasets

```{r}
#Grab all the fetal results
#all_fetal_egad_results = rbind(fetal_egad_results, unannot_fetal_egad_results)


avg_go_auc_organoids = filter(organoid_egad_results, !grepl('markers', goterms) & variable == 'auc') %>% group_by(dataset) %>% summarise(value = mean(value, na.rm = T))
avg_go_auc_organoids$goterms = rep('avg_goterm_auc',  nrow(avg_go_auc_organoids))
avg_go_auc_organoids$sample_label = rep('organoid',  nrow(avg_go_auc_organoids))

avg_go_auc_fetal = filter(fetal_egad_results, !grepl('markers', goterms) & variable == 'auc') %>% group_by(dataset) %>% summarise(value = mean(value, na.rm = T))
avg_go_auc_fetal$goterms = rep('avg_goterm_auc',  nrow(avg_go_auc_fetal))
avg_go_auc_fetal$sample_label = rep('fetal',  nrow(avg_go_auc_fetal))

avg_go_auc_unannot_fetal = filter(unannot_fetal_egad_results, !grepl('markers', goterms) & variable == 'auc') %>% group_by(dataset) %>% summarise(value = mean(value, na.rm = T))
avg_go_auc_unannot_fetal$goterms = rep('avg_goterm_auc',  nrow(avg_go_auc_unannot_fetal))
avg_go_auc_unannot_fetal$sample_label = rep('unannot_fetal',  nrow(avg_go_auc_unannot_fetal))

avg_go_all_datasets = rbind(avg_go_auc_organoids, avg_go_auc_fetal, avg_go_auc_unannot_fetal)
avg_go_all_datasets$goterms = factor(avg_go_all_datasets$goterms, levels = c('avg_goterm_auc','intProg_markers','gaba_markers','nonN_markers',
                                                                                     'glut_markers','nProg_markers','divProg_markers'))
avg_go_all_datasets

#All the marker set scores per dataset
marker_set_organoid_egad_scores = filter(organoid_egad_results, grepl('markers', goterms) & variable == 'auc')
marker_set_organoid_egad_scores$sample_label = rep('organoid', nrow(marker_set_organoid_egad_scores))

marker_set_fetal_egad_scores = filter(fetal_egad_results, grepl('markers', goterms) & variable == 'auc')
marker_set_fetal_egad_scores$sample_label = rep('fetal', nrow(marker_set_fetal_egad_scores))

marker_set_unannot_fetal_egad_scores = filter(unannot_fetal_egad_results, grepl('markers', goterms) & variable == 'auc')
marker_set_unannot_fetal_egad_scores$sample_label = rep('unannot_fetal', nrow(marker_set_unannot_fetal_egad_scores))

marker_set_all_datasets = rbind(marker_set_organoid_egad_scores, marker_set_fetal_egad_scores, marker_set_unannot_fetal_egad_scores)
marker_set_all_datasets$goterms = factor(marker_set_all_datasets$goterms, levels = c('avg_goterm_auc','intProg_markers','gaba_markers','nonN_markers',
                                                                                     'glut_markers','nProg_markers','divProg_markers'))
#Drop the variable column
marker_set_all_datasets = marker_set_all_datasets %>% mutate(variable = NULL)

#Merge the two to plot
comb_df = rbind(avg_go_all_datasets,marker_set_all_datasets)
comb_df

comb_df$sample_label = factor(comb_df$sample_label, levels = c('fetal','unannot_fetal','organoid'))

```

```{r}
egad_marker_palette = c(
                        'avg_goterm_auc' = 'grey50',
                        'intProg_markers' = class_palette[16],
                        'gaba_markers' = class_palette[1], 
                        'nonN_markers' = class_palette[20],
                        'glut_markers' = class_palette[14],
                        'nProg_markers' = class_palette[4],
                        'divProg_markers' = class_palette[10])

sample_palette = c('fetal'='black', 'unannot_fetal'='grey', 'organoid'='white')
alpha_values= c('organoid'=.75, 'fetal'=1, 'unannot_fetal'=1)

ggplot(comb_df, aes(x = goterms, y = value, fill = goterms, color = sample_label, alpha = sample_label )) + geom_boxplot() +
  geom_hline(yintercept = .5, linetype = 'dashed', color = 'red') +
  ylim(.4 ,1) + 
  scale_fill_manual(values = egad_marker_palette) + scale_color_manual(values = sample_palette) + scale_alpha_manual(values = alpha_values, guide = 'none')

```


Mean EGAD AUC across the marker sets

There are 14 organoid datasets that have a mean greater than the lowest scoring fetal dataset
```{r}

marker_set_all_datasets %>% group_by(dataset) %>% summarize(mean_coexp = mean(value)) %>% arrange(desc(mean_coexp))

```


Correlation of GABA and Glut performance across dataset

```{r}

gaba_org_auc = filter(marker_set_all_datasets, sample_label == 'organoid' & goterms == 'gaba_markers' )$value
glut_org_auc = filter(marker_set_all_datasets, sample_label == 'organoid' & goterms == 'glut_markers' )$value
nonN_org_auc = filter(marker_set_all_datasets, sample_label == 'organoid' & goterms == 'nonN_markers' )$value
nProg_org_auc = filter(marker_set_all_datasets, sample_label == 'organoid' & goterms == 'nProg_markers' )$value
intProg_org_auc = filter(marker_set_all_datasets, sample_label == 'organoid' & goterms == 'intProg_markers' )$value
divProg_org_auc = filter(marker_set_all_datasets, sample_label == 'organoid' & goterms == 'divProg_markers' )$value

par(pty = 's')
plot(glut_org_auc, gaba_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(glut_org_auc, nonN_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(glut_org_auc, nProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(glut_org_auc, intProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(glut_org_auc, divProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')

plot(gaba_org_auc, nonN_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(gaba_org_auc, nProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(gaba_org_auc, intProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(gaba_org_auc, divProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')


plot(nonN_org_auc, nProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(nonN_org_auc, intProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
plot(nonN_org_auc, divProg_org_auc, xlim = c(.3, 1), ylim = c(.3, 1))
abline(a = 0, b = 1, col = 'red')
```




compare the class type EGAD performance to the dataset metadata, expecting the GABA directed protocols to be top pperforming GABA datasets

```{r}

org_marker_perf = organoid_egad_results[grepl('marker', organoid_egad_results$goterms) & organoid_egad_results$variable == 'auc', ]
org_marker_perf

dataset_regions = unique(all_sample_meta$sample_region)
dataset_type = vector(mode = 'character', length = nrow(org_marker_perf))

for(region in dataset_regions){
  index = org_marker_perf$dataset %in% all_sample_meta$sample_ids[all_sample_meta$sample_region == region]
  dataset_type[index] = region
}


org_marker_perf$dataset_region = dataset_type
org_marker_perf

```
order on the median gaba score
```{r}
median_gaba_scores = filter(org_marker_perf, goterms == 'nProg_markers') %>% group_by(dataset_region) %>% 
  summarize(median_gaba = median(value)) %>% arrange(median_gaba)
median_gaba_scores

org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = median_gaba_scores$dataset_region )

org_marker_perf$goterms[org_marker_perf$goterms == 'intProg_markers'] = 'Fetal Intermediate Progenitor markers'
org_marker_perf$goterms[org_marker_perf$goterms == 'gaba_markers'] = 'Fetal GABAergic markers'
org_marker_perf$goterms[org_marker_perf$goterms == 'glut_markers'] = 'Fetal Glutamatergic markers'
org_marker_perf$goterms[org_marker_perf$goterms == 'nonN_markers'] = 'Fetal Non-neuronal markers'
org_marker_perf$goterms[org_marker_perf$goterms == 'nProg_markers'] = 'Fetal Neural Progenitor markers'
org_marker_perf$goterms[org_marker_perf$goterms == 'divProg_markers'] = 'Fetal Dividing Progenitor markers'

org_marker_perf$goterms = factor(org_marker_perf$goterms, levels = c('Fetal Dividing Progenitor markers','Fetal Neural Progenitor markers','Fetal Intermediate Progenitor markers',
                                                                     'Fetal GABAergic markers','Fetal Glutamatergic markers','Fetal Non-neuronal markers'))

```

```{r}


org_egad_marker_palette = c('Fetal Non-neuronal markers' = class_palette[20], 'Fetal GABAergic markers' = class_palette[1], 
                         'Fetal Glutamatergic markers' = class_palette[14], 
                         'Fetal Neural Progenitor markers' = class_palette[4],
                         'Fetal Intermediate Progenitor markers' = class_palette[16],
                         'Fetal Dividing Progenitor markers' = class_palette[10])

order_df = org_marker_perf %>% filter(goterms == 'Fetal GABAergic markers') %>% group_by(dataset_region) %>% summarize(median = median(value)) %>% arrange(desc(median))
org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = order_df$dataset_region)
ggplot(filter(org_marker_perf, goterms == 'Fetal GABAergic markers'), aes(x = dataset_region, y = value)) + 
  geom_boxplot(fill = org_egad_marker_palette['Fetal GABAergic markers']) +
  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') + ggtitle('GABAergic') + ylim(.3, 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
ggsave(filename = 'organoid_egad_gaba_by_region_v3.pdf', path = 'graphs/coexpression/',
       device = 'pdf', useDingbats = F,
       height = 5, width = 6)

order_df = org_marker_perf %>% filter(goterms == 'Fetal Glutamatergic markers') %>% group_by(dataset_region) %>% summarize(median = median(value)) %>% arrange(desc(median))
org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = order_df$dataset_region)
ggplot(filter(org_marker_perf, goterms == 'Fetal Glutamatergic markers'), aes(x = dataset_region, y = value)) + 
  geom_boxplot(fill = org_egad_marker_palette['Fetal Glutamatergic markers']) +
  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') + ggtitle('Glutamatergic') + ylim(.3, 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
ggsave(filename = 'organoid_egad_glut_by_region_v3.pdf', path = 'graphs/coexpression/',
       device = 'pdf', useDingbats = F,
       height = 5, width = 6)

order_df = org_marker_perf %>% filter(goterms == 'Fetal Non-neuronal markers') %>% group_by(dataset_region) %>% summarize(median = median(value)) %>% arrange(desc(median))
org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = order_df$dataset_region)
ggplot(filter(org_marker_perf, goterms == 'Fetal Non-neuronal markers'), aes(x = dataset_region, y = value)) + 
  geom_boxplot(fill = org_egad_marker_palette['Fetal Non-neuronal markers']) +
  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') + ggtitle('Non-neuronal') + ylim(.3, 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
ggsave(filename = 'organoid_egad_nonN_by_region_v3.pdf', path = 'graphs/coexpression/',
       device = 'pdf', useDingbats = F,
       height = 5, width = 6)

order_df = org_marker_perf %>% filter(goterms == 'Fetal Neural Progenitor markers') %>% group_by(dataset_region) %>% summarize(median = median(value)) %>% arrange(desc(median))
org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = order_df$dataset_region)
ggplot(filter(org_marker_perf, goterms == 'Fetal Neural Progenitor markers'), aes(x = dataset_region, y = value)) + 
  geom_boxplot(fill = org_egad_marker_palette['Fetal Neural Progenitor markers']) +
  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') + ggtitle('Neural Progenitor') + ylim(.3, 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
ggsave(filename = 'organoid_egad_nProg_by_region_v3.pdf', path = 'graphs/coexpression/',
       device = 'pdf', useDingbats = F,
       height = 5, width = 6)

order_df = org_marker_perf %>% filter(goterms == 'Fetal Dividing Progenitor markers') %>% group_by(dataset_region) %>% summarize(median = median(value)) %>% arrange(desc(median))
org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = order_df$dataset_region)
ggplot(filter(org_marker_perf, goterms == 'Fetal Dividing Progenitor markers'), aes(x = dataset_region, y = value)) + 
  geom_boxplot(fill = org_egad_marker_palette['Fetal Dividing Progenitor markers']) +
  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') + ggtitle('Dividing Progenitor') + ylim(.3, 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
ggsave(filename = 'organoid_egad_divProg_by_region_v3.pdf', path = 'graphs/coexpression/',
       device = 'pdf', useDingbats = F,
       height = 5, width = 6)

order_df = org_marker_perf %>% filter(goterms == 'Fetal Intermediate Progenitor markers') %>% group_by(dataset_region) %>% summarize(median = median(value)) %>% arrange(desc(median))
org_marker_perf$dataset_region = factor(org_marker_perf$dataset_region, levels = order_df$dataset_region)
ggplot(filter(org_marker_perf, goterms == 'Fetal Intermediate Progenitor markers'), aes(x = dataset_region, y = value)) + 
  geom_boxplot(fill = org_egad_marker_palette['Fetal Intermediate Progenitor markers']) +
  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') + ggtitle('Intermediate Progenitor') + ylim(.3, 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
ggsave(filename = 'organoid_egad_intProg_by_region_v3.pdf', path = 'graphs/coexpression/',
       device = 'pdf', useDingbats = F,
       height = 5, width = 6)


#ggplot(org_marker_perf, aes(x = dataset_region, y = value, fill = goterms)) + geom_boxplot()+ facet_wrap(~goterms) +
#  ylab('Organoid coexpression performance (AUC)') + xlab('Organoid protocol') +
#  scale_fill_manual(values = org_egad_marker_palette) +
#  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
#ggsave(filename = 'organoid_egad_fetal_markers_by_region.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/coexpression/',
#       device = 'pdf', useDingbats = F,
#       height = 8, width = 10)
```


Can I find anything consistent in the poor performing datasets? What are the top coexpressed goterms? Different from fetal?
Use the performance of the GLut markers to guage good/bad organoid datasets

```{r}
marker_set_all_datasets
table(organoid_egad_results$variable)
```
For getting the descriptions of the GO terms

```{r}
library(GO.db)
GO_descriptions = as.list(GOTERM)
#Example for how to get the description
Term(GO_descriptions[['GO:0000001']])
Term(GO_descriptions[[1]])


Term(GO_descriptions[[go_terms[5]]])
 organoid_egad_results
```



```{r}
#Get mean EGAD scores per GO term
summary_org_egad = organoid_egad_results %>% filter(variable == 'auc') %>% group_by(goterms) %>% 
  summarize(mean_auc = mean(value, na.rm = T), sd_auc = sd(value, na.rm = T), n = sum(!is.na(value))) %>% 
  arrange(desc(mean_auc))
#Add a GO term label
go_label = rep('GO_term', length = nrow(summary_org_egad))
go_label[!grepl('GO',summary_org_egad$goterms)] = 'celltype_marker_set'
summary_org_egad$go_label = go_label

#Just filter for the GO terms and grab the top 10
go_summary_org_egad = filter(summary_org_egad, go_label == 'GO_term')
go_mean = mean(go_summary_org_egad$mean_auc, na.rm = T)
go_summary_org_egad = arrange(go_summary_org_egad, desc(mean_auc))
go_summary_org_egad = go_summary_org_egad[1:10, ]    #Just grab the top 10

#Add Go term descriptions and plot
go_summary_org_egad$go_description = sapply(1:nrow(go_summary_org_egad), function(i) Term(GO_descriptions[[go_summary_org_egad$goterms[i]]]) )
go_summary_org_egad$go_description = factor(go_summary_org_egad$go_description, levels = go_summary_org_egad$go_description)
ggplot(go_summary_org_egad, aes(x = mean_auc, y = go_description) ) + geom_point(size = 2) + xlim(.5,1) +
  geom_errorbar(aes(xmin=mean_auc-sd_auc, xmax=mean_auc+sd_auc), width=.2, position=position_dodge(0.05)) +
  geom_vline(xintercept = go_mean, color = 'red', linetype = 'dashed', size = 1) +
  xlab('Mean EGAD AUROC') + ggtitle('Organoid EGAD AUROCs') + ylab('Top 10 GO terms') + scale_y_discrete(limits=rev)
ggsave(filename = 'organoid_top_EGAD_goterms_v3.pdf', path = 'graphs/coexpression', useDingbats = F, device = 'pdf', height = 6, width = 8)


#Fetal datasets

#Get mean EGAD scores per GO term
summary_fetal_egad = fetal_egad_results %>% filter(variable == 'auc') %>% group_by(goterms) %>% 
  summarize(mean_auc = mean(value, na.rm = T), sd_auc = sd(value, na.rm = T), n = sum(!is.na(value))) %>% 
  arrange(desc(mean_auc))
#Add a GO term label
go_label = rep('GO_term', length = nrow(summary_fetal_egad))
go_label[!grepl('GO',summary_fetal_egad$goterms)] = 'celltype_marker_set'
summary_fetal_egad$go_label = go_label

#Just filter for the GO terms and grab the top 10
go_summary_fetal_egad = filter(summary_fetal_egad, go_label == 'GO_term')
go_mean = mean(go_summary_fetal_egad$mean_auc, na.rm = T)
go_summary_fetal_egad = arrange(go_summary_fetal_egad, desc(mean_auc))
go_summary_fetal_egad = go_summary_fetal_egad[1:10, ]    #Just grab the top 10

#Add Go term descriptions and plot
go_summary_fetal_egad$go_description = sapply(1:nrow(go_summary_fetal_egad), function(i) Term(GO_descriptions[[go_summary_fetal_egad$goterms[i]]]) )
go_summary_fetal_egad$go_description = factor(go_summary_fetal_egad$go_description, levels = go_summary_fetal_egad$go_description)
ggplot(go_summary_fetal_egad, aes(x = mean_auc, y = go_description) ) + geom_point(size = 2) + xlim(.5,1) +
  geom_errorbar(aes(xmin=mean_auc-sd_auc, xmax=mean_auc+sd_auc), width=.2, position=position_dodge(0.05)) +
  geom_vline(xintercept = go_mean, color = 'red', linetype = 'dashed', size = 1) +
  xlab('Mean EGAD AUROC') + ggtitle('fetal EGAD AUROCs') + ylab('Top 10 GO terms') + scale_y_discrete(limits=rev)
ggsave(filename = 'fetal_top_EGAD_goterms_v3.pdf', path = 'graphs/coexpression', useDingbats = F, device = 'pdf', height = 6, width = 8)



#Unannotated fetal datasets

#Get mean EGAD scores per GO term
summary_unannot_fetal_egad = unannot_fetal_egad_results %>% filter(variable == 'auc') %>% group_by(goterms) %>% 
  summarize(mean_auc = mean(value, na.rm = T), sd_auc = sd(value, na.rm = T), n = sum(!is.na(value))) %>% 
  arrange(desc(mean_auc))
#Add a GO term label
go_label = rep('GO_term', length = nrow(summary_unannot_fetal_egad))
go_label[!grepl('GO',summary_unannot_fetal_egad$goterms)] = 'celltype_marker_set'
summary_unannot_fetal_egad$go_label = go_label

#Just filter for the GO terms and grab the top 10
go_summary_unannot_fetal_egad = filter(summary_unannot_fetal_egad, go_label == 'GO_term')
go_mean = mean(go_summary_unannot_fetal_egad$mean_auc, na.rm = T)
go_summary_unannot_fetal_egad = arrange(go_summary_unannot_fetal_egad, desc(mean_auc))
go_summary_unannot_fetal_egad = go_summary_unannot_fetal_egad[1:10, ]    #Just grab the top 10

#Add Go term descriptions and plot
go_summary_unannot_fetal_egad$go_description = sapply(1:nrow(go_summary_unannot_fetal_egad), function(i) Term(GO_descriptions[[go_summary_unannot_fetal_egad$goterms[i]]]) )
go_summary_unannot_fetal_egad$go_description = factor(go_summary_unannot_fetal_egad$go_description, levels = go_summary_unannot_fetal_egad$go_description)
ggplot(go_summary_unannot_fetal_egad, aes(x = mean_auc, y = go_description) ) + geom_point(size = 2) + xlim(.5,1) +
  geom_errorbar(aes(xmin=mean_auc-sd_auc, xmax=mean_auc+sd_auc), width=.2, position=position_dodge(0.05)) +
  geom_vline(xintercept = go_mean, color = 'red', linetype = 'dashed', size = 1) +
  xlab('Mean EGAD AUROC') + ggtitle('unannotated fetal EGAD AUROCs') + ylab('Top 10 GO terms') + scale_y_discrete(limits=rev)
ggsave(filename = 'unannot_fetal_top_EGAD_goterms_v3.pdf', path = 'graphs/coexpression', useDingbats = F, device = 'pdf', height = 6, width = 8)

```

```{r}
table(all_sample_meta$sample_ids == filter(marker_set_all_datasets, sample_label=='organoid' & goterms == 'glut_markers')$dataset)
all_sample_meta


just_glut_auc = filter(marker_set_all_datasets, sample_label=='organoid' & goterms == 'glut_markers')$value
just_gaba_auc = filter(marker_set_all_datasets, sample_label=='organoid' & goterms == 'gaba_markers')$value
just_nonN_auc = filter(marker_set_all_datasets, sample_label=='organoid' & goterms == 'nonN_markers')$value
just_nProg_auc = filter(marker_set_all_datasets, sample_label=='organoid' & goterms == 'nProg_markers')$value
test_df = data.frame(dataset = all_sample_meta$sample_ids, sample_condition = all_sample_meta$sample_condition, sample_region = all_sample_meta$sample_region,
                     glut_egad_auc =just_glut_auc, gaba_egad_auc =just_gaba_auc, nonN_egad_auc =just_nonN_auc, nProg_egad_auc =just_nProg_auc )

test_df %>% arrange(desc(glut_egad_auc))


```



#####################################

Aggregate the coexpression networks together
#####################################


Now when all the datasets have the same genes


```{r}

sum_rank_corr_genes = matrix(rep(0, length(go_genes)^2), nrow = length(go_genes), ncol = length(go_genes), dimnames = list(go_genes, go_genes))

for(i in 1:nrow(all_sample_meta)){
  gc()
  x = load(sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata', all_sample_meta$sample_ids[i]))
  rank_mat = get(x)
  rm(x)
  
  #Reorder to match the same gene order
  index = match(go_genes, rownames(rank_mat))
  rank_mat = rank_mat[index, index]

  sum_rank_corr_genes = sum_rank_corr_genes + rank_mat
  print(i)
}

agg_rank_mat = sum_rank_corr_genes / nrow(all_sample_meta)
#Set diagonal to 1
diag(agg_rank_mat) = 1
agg_rank_mat[1:10, 1:10]
```




Saving just go
```{r}
organoid_agg_rank_mat = agg_rank_mat

save(organoid_agg_rank_mat, file = '../data/coexpression/organoid/agg_organoid_coexp_network_8_17_23.Rdata')
```



The aggregated network just using go genes

```{r}
load('../data/coexpression/organoid/agg_organoid_coexp_network_8_17_23.Rdata')
dim(organoid_agg_rank_mat)

load('../data/coexpression/fetal/agg_fetal_coexp_network_8_17_23.Rdata')
dim(fetal_agg_rank_mat)

load('../data/coexpression/fetal/agg_unannot_fetal_coexp_network_8_17_23.Rdata')
dim(unannot_fetal_agg_rank_mat)
```




EGAD
```{r}
#Get all genes in the coexpression matrix
genelist <- rownames(organoid_agg_rank_mat)
#GO term annotations
annotations <- make_annotations(go_table[,c("gene_symbol", "go_id")], unique(go_table$gene_symbol), unique(go_table$go_id))
#Get marker annotations
annot_vec = c(as.numeric(genelist %in% gaba_markers$gene), as.numeric(genelist %in% glut_markers$gene),
              as.numeric(genelist %in% nonN_markers$gene),as.numeric(genelist %in% nProg_markers$gene),
              as.numeric(genelist %in% intProg_markers$gene) ,as.numeric(genelist %in% divProg_markers$gene) )
marker_annotations = matrix(annot_vec, nrow = length(genelist), ncol = 6, byrow = F, 
                            dimnames = list(genelist, c('gaba_markers','glut_markers','nonN_markers','nProg_markers','intProg_markers','divProg_markers')))

# Run GBA 
GO_groups_voted <- run_GBA(organoid_agg_rank_mat, annotations, nfold = 3)
#EGAD for the class marker genes
marker_groups_voted <- run_GBA(organoid_agg_rank_mat, marker_annotations, nfold = 3)

#Get AUCs of all GO groups
# neighbor voting AUROCs
auc_GO_nv = GO_groups_voted[[1]][,1]
# node degree AUCs
auc_GO_nd = GO_groups_voted[[1]][,3]

#Get AUCs of the marker groups
# neighbor voting AUROCs
auc_marker_nv = marker_groups_voted[[1]][,1]
# node degree AUCs
auc_marker_nd = marker_groups_voted[[1]][,3]

#Get NA matrix for all the missing goterms for this dataset
missing_go = go_terms[!go_terms %in% rownames(GO_groups_voted[[1]])]

missing_matrix = matrix(data = NA, nrow = length(missing_go), ncol = 3, 
                        dimnames = list(missing_go, colnames(GO_groups_voted[[1]])))
#Add and reorder so everything is consistent across datasets
all_goterms = rbind(GO_groups_voted[[1]], missing_matrix)
all_goterms  = all_goterms[match(go_terms, rownames(all_goterms)), ]

#Add the marker results
egad_results = rbind(all_goterms, marker_groups_voted[[1]])

organoid_agg_network_egad_results = egad_results
```

```{r}

save(organoid_agg_network_egad_results, file = '../data/coexpression/organoid/agg_organoid_egad_results_8_17_23.Rdata')
```



```{r}
load('../data/coexpression/organoid/agg_organoid_egad_results_8_17_23.Rdata')
load('../data/coexpression/fetal/agg_fetal_egad_results_8_17_23.Rdata')
load('../data/coexpression/fetal/agg_unannot_fetal_egad_results_8_17_23.Rdata')

```


```{r}

organoid_agg_network_egad_results[22834:22840,'auc' ]
fetal_agg_network_egad_results[22834:22840,'auc' ]
unannot_fetal_agg_network_egad_results[22834:22840,'auc' ]


hist(organoid_agg_network_egad_results[ ,'auc'], breaks = 64)
hist(fetal_agg_network_egad_results[ ,'auc'], breaks = 64)
hist(unannot_fetal_agg_network_egad_results[ ,'auc'], breaks = 64)


mean(organoid_agg_network_egad_results[ 1:22834,'auc'], na.rm = T)
mean(fetal_agg_network_egad_results[ 1:22834,'auc'], na.rm = T)
mean(unannot_fetal_agg_network_egad_results[ 1:22834,'auc'], na.rm = T)
```



```{r}
all_marker_genes = c(gaba_markers$gene, glut_markers$gene, nProg_markers$gene, nonN_markers$gene, intProg_markers$gene, divProg_markers$gene)


organoid_agg_marker = organoid_agg_rank_mat[rownames(organoid_agg_rank_mat) %in% all_marker_genes, colnames(organoid_agg_rank_mat) %in% all_marker_genes ]
dim(organoid_agg_marker)

fetal_agg_marker = fetal_agg_rank_mat[rownames(fetal_agg_rank_mat) %in% all_marker_genes, colnames(fetal_agg_rank_mat) %in% all_marker_genes ]
dim(fetal_agg_marker)

unannot_fetal_agg_marker = unannot_fetal_agg_rank_mat[rownames(unannot_fetal_agg_rank_mat) %in% all_marker_genes, colnames(unannot_fetal_agg_rank_mat) %in% all_marker_genes ]
dim(unannot_fetal_agg_marker)

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(organoid_agg_marker))
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
table(fetal_marker_annot_vec)

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated organoid coexpression network')

pdf(file = 'graphs/coexpression/agg_organoid_class_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()
draw(h_map)

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(fetal_agg_marker))
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
table(fetal_marker_annot_vec)

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(fetal_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated fetal coexpression network')
pdf(file = 'graphs/coexpression/agg_fetal_class_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()
draw(h_map)

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(unannot_fetal_agg_marker))
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
table(fetal_marker_annot_vec)

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)


col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(unannot_fetal_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T, 
        column_title = 'Aggregated unannotated fetal coexpression network')
pdf(file = 'graphs/coexpression/agg_unannot_fetal_class_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()
draw(h_map)
```


add the aggregate network performance to othe graph
Use the unannotated fetal aggregate for the graph, the annotated fetal aggregate is circular

```{r}
organoid_agg_network_egad_results = as.data.frame(organoid_agg_network_egad_results)
org_goterm_avg = colMeans(filter(organoid_agg_network_egad_results, !grepl('marker', rownames(organoid_agg_network_egad_results)) ), na.rm = T)

fetal_agg_network_egad_results = as.data.frame(fetal_agg_network_egad_results)
fetal_goterm_avg = colMeans(filter(fetal_agg_network_egad_results, !grepl('marker', rownames(fetal_agg_network_egad_results)) ), na.rm = T)

unannot_fetal_agg_network_egad_results = as.data.frame(unannot_fetal_agg_network_egad_results)
unannot_fetal_goterm_avg = colMeans(filter(unannot_fetal_agg_network_egad_results, !grepl('marker', rownames(unannot_fetal_agg_network_egad_results)) ), na.rm = T)

unannot_fetal_goterm_avg


org_marker_set = filter(organoid_agg_network_egad_results, grepl('marker', rownames(organoid_agg_network_egad_results)) )
fetal_marker_set = filter(fetal_agg_network_egad_results, grepl('marker', rownames(fetal_agg_network_egad_results)) )
unannot_fetal_marker_set = filter(unannot_fetal_agg_network_egad_results, grepl('marker', rownames(unannot_fetal_agg_network_egad_results)) )
unannot_fetal_marker_set

agg_network_auc = data.frame(goterms = rep(c('avg_goterm_auc','gaba_markers','glut_markers','nonN_markers','nProg_markers','intProg_markers','divProg_markers'), 3), 
                             sample_label = c(rep('organoid', 7), rep('fetal', 7), rep('unannot_fetal', 7)), 
                             value = rep(NA, 21))

agg_network_auc$value[agg_network_auc$goterms == 'avg_goterm_auc' & agg_network_auc$sample_label == 'organoid' ] = org_goterm_avg['auc'] 
agg_network_auc$value[agg_network_auc$goterms == 'avg_goterm_auc' & agg_network_auc$sample_label == 'fetal' ] = fetal_goterm_avg['auc'] 
agg_network_auc$value[agg_network_auc$goterms == 'avg_goterm_auc' & agg_network_auc$sample_label == 'unannot_fetal' ] = unannot_fetal_goterm_avg['auc'] 
agg_network_auc$value[grepl('markers',agg_network_auc$goterms)  & agg_network_auc$sample_label == 'organoid' ] = org_marker_set[ ,'auc']
agg_network_auc$value[grepl('markers',agg_network_auc$goterms)  & agg_network_auc$sample_label == 'fetal' ] = fetal_marker_set[ ,'auc']
agg_network_auc$value[grepl('markers',agg_network_auc$goterms)  & agg_network_auc$sample_label == 'unannot_fetal' ] = unannot_fetal_marker_set[ ,'auc']

agg_network_auc$goterms = factor(agg_network_auc$goterms, levels = c('avg_goterm_auc','intProg_markers','gaba_markers','nonN_markers',
                                                                                     'glut_markers','nProg_markers','divProg_markers'))
agg_network_auc$sample_label = factor(agg_network_auc$sample_label, levels = c('fetal','unannot_fetal','organoid'))
```

```{r}

egad_marker_palette = c('avg_goterm_auc' = 'grey50',
                        'intProg_markers' = class_palette[16],
                        'gaba_markers' = class_palette[1], 
                        'nonN_markers' = class_palette[20],
                        'glut_markers' = class_palette[14],
                        'nProg_markers' = class_palette[4],
                        'divProg_markers' = class_palette[10])

sample_palette = c('fetal'='black', 'unannot_fetal'='grey', 'organoid'='white')
alpha_values= c('fetal'=1, 'unannot_fetal'=1, 'organoid'=.6)

shape_values = c('fetal' = 23, 'unannot_fetal' = 24,'organoid' = 22  )
position_values = c( 'fetal' = position_nudge(x = -0.2), 'unannot_fetal' = position_nudge(x = -0.2),'organoid' = position_nudge(x = 0.2))  


ggplot(comb_df, aes(x = goterms, y = value, fill = goterms, color = sample_label, alpha = sample_label )) + geom_boxplot() +
  geom_hline(yintercept = .5, linetype = 'dashed', color = 'red') +
  geom_point(data = agg_network_auc, aes(x = goterms, y = value, shape = sample_label), 
             size = 2.5, color = 'black', show.legend = F, position = position_dodge(width = .75), alpha = 1) +
  ylim(.4 ,1) + ylab('EGAD auroc') +
  scale_fill_manual(values = egad_marker_palette) + scale_color_manual(values = sample_palette) + 
  scale_alpha_manual(values = alpha_values, guide = 'none') + scale_shape_manual(values = shape_values) +
  scale_x_discrete(guide = guide_axis(n.dodge=2))


#Just using the go genes in each dataset, and the unannotated fetal aggregate as the aggregate datapoint
ggsave(filename = 'egad_fetal_organoid_and_agg_networks_just_go_v3.pdf', path = 'graphs/coexpression/', device = 'pdf', 
       useDingbats = F, height = 5, width = 7)

```

```{r}
position_dodge(width=0.5)
```



grab examples of the best and worst performing organoid networks for each cell type 
need at least 5000 cells
```{r}
org_performances = filter(comb_df, sample_label == 'fetal' & goterms == 'glut_markers') %>% arrange(value)
index = match(org_performances$dataset, all_sample_meta$sample_ids)
org_performances$cell_num = all_sample_meta$num_cells_filt[index]
org_performances

#best_org_divProg = 'GSM5136271_5standardorgday120.csv'
#worst_org_divProg = 'GSM4769385'

#best_org_nProg = 'GSM4306933'
#worst_org_nProg = 'GSM5005488'

#best_org_intProg = 'GSE124299_PrimaryOrganoidAndPublishedCPM.txt'
#worst_org_intProg = 'GSM4996699_DGE7980.txt'

#best_org_glut = 'GSE98201'
#worst_org_glut = 'GSM5005488'


best_org_glut = 'GSE124299_PrimaryOrganoidAndPublishedCPM.txt'
worst_org_glut = 'GSM5221533'

worst_fetal_glut = 'poliodakis_batch1'
best_fetal_glut = 'GW20_31'
#best_org_gaba = 'GSE124299_PrimaryOrganoidAndPublishedCPM.txt'
#worst_org_gaba = 'GSM5289680_Raw_gene_counts_matrix.txt'

#best_org_nonN = 'GSE124299_PrimaryOrganoidAndPublishedCPM.txt'
#worst_org_nonN = 'GSM4094681_C1_150d_fseq12BC77_S2.deg.txt'

```



```{r}

#First get the set of non intersecting metaMarker gene sets
temp_divProgMarkers = divProg_markers$gene[!divProg_markers$gene %in% c(nProg_markers$gene, intProg_markers$gene, glut_markers$gene, gaba_markers$gene, nonN_markers$gene)]
temp_nProgMarkers = nProg_markers$gene[!nProg_markers$gene %in% c(divProg_markers$gene, intProg_markers$gene, glut_markers$gene, gaba_markers$gene, nonN_markers$gene)]
temp_intProgMarkers = intProg_markers$gene[!intProg_markers$gene %in% c(nProg_markers$gene, divProg_markers$gene, glut_markers$gene, gaba_markers$gene, nonN_markers$gene)]
temp_glutMarkers = glut_markers$gene[!glut_markers$gene %in% c(nProg_markers$gene, intProg_markers$gene, divProg_markers$gene, gaba_markers$gene, nonN_markers$gene)]
temp_gabaMarkers = gaba_markers$gene[!gaba_markers$gene %in% c(nProg_markers$gene, intProg_markers$gene, glut_markers$gene, divProg_markers$gene, nonN_markers$gene)]
temp_nonNMarkers = nonN_markers$gene[!nonN_markers$gene %in% c(nProg_markers$gene, intProg_markers$gene, glut_markers$gene, gaba_markers$gene, divProg_markers$gene)]
#Filter for the go genes
temp_all_marker_genes = c(temp_divProgMarkers, temp_nProgMarkers, temp_intProgMarkers, temp_glutMarkers, temp_gabaMarkers, temp_nonNMarkers)
temp_all_marker_genes = temp_all_marker_genes[temp_all_marker_genes %in% go_genes]
temp_all_marker_genes = temp_all_marker_genes[!duplicated(temp_all_marker_genes)]


#Load coexpression network
coexp_file = sprintf('../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_%s_coexp.Rdata',best_fetal_glut)
load(coexp_file)
#Flter for marker genes
fetal_agg_marker =rank_corr_matrix[rownames(rank_corr_matrix) %in% temp_all_marker_genes, colnames(rank_corr_matrix) %in% temp_all_marker_genes ]

#Reordering the genes by their average within marker set co-expression strength
divProg_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% divProg_markers$gene, colnames(fetal_agg_marker) %in% divProg_markers$gene], na.rm = T)
divProg_ord = names(divProg_means[order(divProg_means, decreasing = T)])
nProg_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% nProg_markers$gene, colnames(fetal_agg_marker) %in% nProg_markers$gene], na.rm = T)
nProg_ord = names(nProg_means[order(nProg_means, decreasing = T)])
intProg_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% intProg_markers$gene, colnames(fetal_agg_marker) %in% intProg_markers$gene], na.rm = T)
intProg_ord = names(intProg_means[order(intProg_means, decreasing = T)])
glut_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% glut_markers$gene, colnames(fetal_agg_marker) %in% glut_markers$gene], na.rm = T)
glut_ord = names(glut_means[order(glut_means, decreasing = T)])
gaba_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% gaba_markers$gene, colnames(fetal_agg_marker) %in% gaba_markers$gene], na.rm = T)
gaba_ord = names(gaba_means[order(gaba_means, decreasing = T)])
nonN_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% nonN_markers$gene, colnames(fetal_agg_marker) %in% nonN_markers$gene], na.rm = T)
nonN_ord = names(nonN_means[order(nonN_means, decreasing = T)])

temp_all_marker_genes = c(divProg_ord, nProg_ord, intProg_ord, glut_ord, gaba_ord, nonN_ord)

#Order the matrix to the marker gene order
row_index = match(temp_all_marker_genes, rownames(fetal_agg_marker))
col_index = match(temp_all_marker_genes, colnames(fetal_agg_marker))
fetal_agg_marker = fetal_agg_marker[row_index, col_index]

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(fetal_agg_marker))
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(fetal_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Ranked coexpression',
                cluster_rows = F, cluster_columns = F,
                top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = F, use_raster = T,
                column_title = 'Best glut fetal coexpression network')
draw(h_map)

pdf(file = 'graphs/coexpression/fetal_best_glut_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()

#Worst fetal glutamatergic dataset as a reference example

#Load coexpression network
coexp_file = sprintf('../data/coexpression/fetal/8_17_23_GO_coexp/ranked_%s_coexp.Rdata',worst_fetal_glut)
load(coexp_file)
#Flter for marker genes
fetal_agg_marker =rank_corr_matrix[rownames(rank_corr_matrix) %in% temp_all_marker_genes, colnames(rank_corr_matrix) %in% temp_all_marker_genes ]

#Reordering the genes by their average within marker set co-expression strength
divProg_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% divProg_markers$gene, colnames(fetal_agg_marker) %in% divProg_markers$gene], na.rm = T)
divProg_ord = names(divProg_means[order(divProg_means, decreasing = T)])
nProg_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% nProg_markers$gene, colnames(fetal_agg_marker) %in% nProg_markers$gene], na.rm = T)
nProg_ord = names(nProg_means[order(nProg_means, decreasing = T)])
intProg_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% intProg_markers$gene, colnames(fetal_agg_marker) %in% intProg_markers$gene], na.rm = T)
intProg_ord = names(intProg_means[order(intProg_means, decreasing = T)])
glut_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% glut_markers$gene, colnames(fetal_agg_marker) %in% glut_markers$gene], na.rm = T)
glut_ord = names(glut_means[order(glut_means, decreasing = T)])
gaba_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% gaba_markers$gene, colnames(fetal_agg_marker) %in% gaba_markers$gene], na.rm = T)
gaba_ord = names(gaba_means[order(gaba_means, decreasing = T)])
nonN_means = colMeans(fetal_agg_marker[rownames(fetal_agg_marker) %in% nonN_markers$gene, colnames(fetal_agg_marker) %in% nonN_markers$gene], na.rm = T)
nonN_ord = names(nonN_means[order(nonN_means, decreasing = T)])

temp_all_marker_genes = c(divProg_ord, nProg_ord, intProg_ord, glut_ord, gaba_ord, nonN_ord)

#Order the matrix to the marker gene order
row_index = match(temp_all_marker_genes, rownames(fetal_agg_marker))
col_index = match(temp_all_marker_genes, colnames(fetal_agg_marker))
fetal_agg_marker = fetal_agg_marker[row_index, col_index]

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(fetal_agg_marker))
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(fetal_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Ranked coexpression',
                cluster_rows = F, cluster_columns = F,
                top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = F, use_raster = T,
                column_title = 'Worst glut fetal coexpression network')
draw(h_map)

pdf(file = 'graphs/coexpression/fetal_worst_glut_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()

#Best organoid glutamatergic dataset

#Load coexpression network
coexp_file = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata',best_org_glut)
load(coexp_file)
#Flter for marker genes
organoid_agg_marker =rank_corr_matrix[rownames(rank_corr_matrix) %in% temp_all_marker_genes, colnames(rank_corr_matrix) %in% temp_all_marker_genes ]

#Reordering the genes by their average within marker set co-expression strength
divProg_means = colMeans(organoid_agg_marker[rownames(organoid_agg_marker) %in% divProg_markers$gene, colnames(organoid_agg_marker) %in% divProg_markers$gene], na.rm = T)
divProg_ord = names(divProg_means[order(divProg_means, decreasing = T)])
nProg_means = colMeans(organoid_agg_marker[rownames(organoid_agg_marker) %in% nProg_markers$gene, colnames(organoid_agg_marker) %in% nProg_markers$gene], na.rm = T)
nProg_ord = names(nProg_means[order(nProg_means, decreasing = T)])
intProg_means = colMeans(organoid_agg_marker[rownames(organoid_agg_marker) %in% intProg_markers$gene, colnames(organoid_agg_marker) %in% intProg_markers$gene], na.rm = T)
intProg_ord = names(intProg_means[order(intProg_means, decreasing = T)])
glut_means = colMeans(organoid_agg_marker[rownames(organoid_agg_marker) %in% glut_markers$gene, colnames(organoid_agg_marker) %in% glut_markers$gene], na.rm = T)
glut_ord = names(glut_means[order(glut_means, decreasing = T)])
gaba_means = colMeans(organoid_agg_marker[rownames(organoid_agg_marker) %in% gaba_markers$gene, colnames(organoid_agg_marker) %in% gaba_markers$gene], na.rm = T)
gaba_ord = names(gaba_means[order(gaba_means, decreasing = T)])
nonN_means = colMeans(organoid_agg_marker[rownames(organoid_agg_marker) %in% nonN_markers$gene, colnames(organoid_agg_marker) %in% nonN_markers$gene], na.rm = T)
nonN_ord = names(nonN_means[order(nonN_means, decreasing = T)])

temp_all_marker_genes = c(divProg_ord, nProg_ord, intProg_ord, glut_ord, gaba_ord, nonN_ord)

#Order the matrix to the marker gene order
row_index = match(temp_all_marker_genes, rownames(organoid_agg_marker))
col_index = match(temp_all_marker_genes, colnames(organoid_agg_marker))
organoid_agg_marker = organoid_agg_marker[row_index, col_index]

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(organoid_agg_marker))
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Ranked coexpression',
                cluster_rows = F, cluster_columns = F,
                top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = F, use_raster = T,
                column_title = 'Best glut organoid coexpression network')
draw(h_map)

pdf(file = 'graphs/coexpression/organoid_best_glut_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()


#Load coexpression network
coexp_file = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata',worst_org_glut)
load(coexp_file)

organoid_agg_marker_2 =rank_corr_matrix[rownames(rank_corr_matrix) %in% temp_all_marker_genes, colnames(rank_corr_matrix) %in% temp_all_marker_genes ]

#Reordering the genes by their average within marker set co-expression strength
divProg_means = colMeans(organoid_agg_marker_2[rownames(organoid_agg_marker_2) %in% divProg_markers$gene, colnames(organoid_agg_marker_2) %in% divProg_markers$gene], na.rm = T)
divProg_ord = names(divProg_means[order(divProg_means, decreasing = T)])
nProg_means = colMeans(organoid_agg_marker_2[rownames(organoid_agg_marker_2) %in% nProg_markers$gene, colnames(organoid_agg_marker_2) %in% nProg_markers$gene], na.rm = T)
nProg_ord = names(nProg_means[order(nProg_means, decreasing = T)])
intProg_means = colMeans(organoid_agg_marker_2[rownames(organoid_agg_marker_2) %in% intProg_markers$gene, colnames(organoid_agg_marker_2) %in% intProg_markers$gene], na.rm = T)
intProg_ord = names(intProg_means[order(intProg_means, decreasing = T)])
glut_means = colMeans(organoid_agg_marker_2[rownames(organoid_agg_marker_2) %in% glut_markers$gene, colnames(organoid_agg_marker_2) %in% glut_markers$gene], na.rm = T)
glut_ord = names(glut_means[order(glut_means, decreasing = T)])
gaba_means = colMeans(organoid_agg_marker_2[rownames(organoid_agg_marker_2) %in% gaba_markers$gene, colnames(organoid_agg_marker_2) %in% gaba_markers$gene], na.rm = T)
gaba_ord = names(gaba_means[order(gaba_means, decreasing = T)])
nonN_means = colMeans(organoid_agg_marker_2[rownames(organoid_agg_marker_2) %in% nonN_markers$gene, colnames(organoid_agg_marker_2) %in% nonN_markers$gene], na.rm = T)
nonN_ord = names(nonN_means[order(nonN_means, decreasing = T)])

temp_all_marker_genes = c(divProg_ord, nProg_ord, intProg_ord, glut_ord, gaba_ord, nonN_ord)

#Order the matrix to the marker gene order
row_index = match(temp_all_marker_genes, rownames(organoid_agg_marker_2))
col_index = match(temp_all_marker_genes, colnames(organoid_agg_marker_2))
organoid_agg_marker_2 = organoid_agg_marker_2[row_index, col_index]

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(organoid_agg_marker_2))
fetal_marker_annot_vec[rownames(organoid_agg_marker_2) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker_2) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker_2) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker_2) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker_2) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker_2) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 


top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(organoid_agg_marker_2, show_row_names = F, show_column_names = F, col = col_fun, name = 'Ranked coexpression',
                cluster_rows = F, cluster_columns = F,
                top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = F, use_raster = T,
                column_title = 'Worst glut organoid coexpression network')
draw(h_map)

pdf(file = 'graphs/coexpression/organoid_worst_glut_marker_coexp_heatmap_v3.pdf', width = 8, height = 6, useDingbats = F)
draw(h_map)
dev.off()


```
Make pie charts of the co-expressed clusters for the best/worst glutamatergic examples
For the main figure
Showing in the best organoid, glutamatergic genes make up the cluster
In the worst example, there's a cluster of a bunch of genes

```{r}

#Load coexpression network
coexp_file = sprintf('../data/coexpression/organoid/10_12_22_GO_coexp/ranked_%s_coexp.Rdata',best_org_glut)
load(coexp_file)
#Flter for marker genes
organoid_agg_marker =rank_corr_matrix[rownames(rank_corr_matrix) %in% all_marker_genes, colnames(rank_corr_matrix) %in% all_marker_genes ]


#Cluster
#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(organoid_agg_marker))
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
h_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated organoid coexpression network')

#Get the column dendrogram and cut it to get clusters
num_clusts = 6
h_map = draw(h_map)
col_dend = column_dend(h_map)
clusters = cutree(as.hclust(col_dend), k = num_clusts)
#Plot again to verify the cluster/gene composition
h_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_columns = 'ward.D2',
        split = clusters,
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated organoid coexpression network')
draw(h_map)

#Neuronal/Glut cluster is cluster 7

#Vizualize  piechart
cluster_genes = names(clusters[clusters == 7])
cell_marker_label = c('Fetal Glutamatergic marker', 'Fetal GABAergic marker', 'Fetal Non-neuronal marker', 
                      'Fetal Dividing Progenitor marker', 'Fetal Intermediate Progenitor marker', 'Fetal Neural Progenitor marker')
intersect_vec = c(sum(cluster_genes %in% go_glut), sum(cluster_genes %in% go_gaba), sum(cluster_genes %in% go_nonN),
                  sum(cluster_genes %in% go_divProg), sum(cluster_genes %in% go_intProg), sum(cluster_genes %in% go_nProg)) 
cluster_pie_df = data.frame(fetal_marker = cell_marker_label, cluster_makeup = intersect_vec)

# Basic piechart
ggplot(cluster_pie_df, aes(x="", y=cluster_makeup, fill=fetal_marker)) +
geom_bar(stat="identity", width=1, color="white") +
coord_polar("y", start=0) + theme_void() +
scale_fill_manual(values = class_marker_palette)
ggsave(filename = 'graphs/coexpression/organoid_best_glut_marker_piechart_v2.pdf', device = 'pdf', useDingbats = F,
       height = 4, width = 4)

```


```{r}
#Load coexpression network
coexp_file = sprintf('../data/coexpression/organoid/10_12_22_GO_coexp/ranked_%s_coexp.Rdata',worst_org_glut)
load(coexp_file)
#Flter for marker genes
organoid_agg_marker =rank_corr_matrix[rownames(rank_corr_matrix) %in% all_marker_genes, colnames(rank_corr_matrix) %in% all_marker_genes ]


#Cluster
#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(organoid_agg_marker))
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))

h_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2', 
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated organoid coexpression network')

#Get the column dendrogram and cut it to get clusters
num_clusts = 3
h_map = draw(h_map)
col_dend = column_dend(h_map)
clusters = cutree(as.hclust(col_dend), k = num_clusts)
#Plot again to verify the cluster/gene composition
h_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_columns = 'ward.D2',
        split = clusters,
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated organoid coexpression network')
draw(h_map)

#bad co-expression cluster is cluster 1

#Vizualize  piechart
cluster_genes = names(clusters[clusters == 1])
cell_marker_label = c('Fetal Glutamatergic marker', 'Fetal GABAergic marker', 'Fetal Non-neuronal marker', 
                      'Fetal Dividing Progenitor marker', 'Fetal Intermediate Progenitor marker', 'Fetal Neural Progenitor marker')
intersect_vec = c(sum(cluster_genes %in% go_glut), sum(cluster_genes %in% go_gaba), sum(cluster_genes %in% go_nonN),
                  sum(cluster_genes %in% go_divProg), sum(cluster_genes %in% go_intProg), sum(cluster_genes %in% go_nProg)) 
cluster_pie_df = data.frame(fetal_marker = cell_marker_label, cluster_makeup = intersect_vec)

# Basic piechart
ggplot(cluster_pie_df, aes(x="", y=cluster_makeup, fill=fetal_marker)) +
geom_bar(stat="identity", width=1, color="white") +
coord_polar("y", start=0) + theme_void() +
scale_fill_manual(values = class_marker_palette)
ggsave(filename = 'graphs/coexpression/organoid_worst_glut_marker_piechart_v2.pdf', device = 'pdf', useDingbats = F,
       height = 4, width = 4)

```



#######################################
Get adjusted Rands index to compare the clustering across networks

Get the subset of marker genes for the 6 cell-types from the network
K-means cluster with k = 6
Extract cluster-gene ID
Compare to the real clustering using adjusted Rands Index, just the cell-type labels for the marker genes

Start with the aggregated fetal and organoid networks to test it out
Then can get the stat on every co-expression network, fetal and organoid
########################################



Test out k means clustering on the aggregated fetal and organoid networks


```{r}
all_marker_genes = c(go_gaba, go_glut, go_nProg, go_nonN, go_intProg, go_divProg)
all_marker_genes = unique(all_marker_genes)

#Vector with the theoretical clustering, just cell-type groupings of the markers
real_clust = rep(0, length = length(all_marker_genes))
real_clust[all_marker_genes %in% go_gaba] = 1
real_clust[all_marker_genes %in% go_glut] = 2
real_clust[all_marker_genes %in% go_nProg] = 3
real_clust[all_marker_genes %in% go_nonN] = 4
real_clust[all_marker_genes %in% go_intProg] = 5
real_clust[all_marker_genes %in% go_divProg] = 6

#Reorder the co-expression marker subsets to all have the same ordering. Doesn't impact the clustering, just matches so we can compare clustering to the theoretical clusters
organoid_agg_marker = organoid_agg_rank_mat[rownames(organoid_agg_rank_mat) %in% all_marker_genes, colnames(organoid_agg_rank_mat) %in% all_marker_genes ]
index = match(all_marker_genes, rownames(organoid_agg_marker))
organoid_agg_marker = organoid_agg_marker[index, index]

fetal_agg_marker = fetal_agg_rank_mat[rownames(fetal_agg_rank_mat) %in% all_marker_genes, colnames(fetal_agg_rank_mat) %in% all_marker_genes ]
index = match(all_marker_genes, rownames(fetal_agg_marker))
fetal_agg_marker = fetal_agg_marker[index, index]

unannot_fetal_agg_marker = unannot_fetal_agg_rank_mat[rownames(unannot_fetal_agg_rank_mat) %in% all_marker_genes, colnames(unannot_fetal_agg_rank_mat) %in% all_marker_genes ]
index = match(all_marker_genes, rownames(unannot_fetal_agg_marker))
unannot_fetal_agg_marker = unannot_fetal_agg_marker[index, index]

#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(organoid_agg_marker))
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(organoid_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

col_fun = colorRamp2(c( 0,.5, 1), c("blue","white", "red"))
org_map = Heatmap(organoid_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
                clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
                clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2',
                row_km = 6, column_km = 6, row_km_repeats = 100, column_km_repeats = 100,
                top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
                column_title = 'Aggregated organoid coexpression network')
#Make the heatmap and get the row cluster IDs
org_map = draw(org_map)
org_clusters = row_order(org_map)


#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(unannot_fetal_agg_marker))
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(unannot_fetal_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

un_fetal_map = Heatmap(unannot_fetal_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
                       clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
                       clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2',
                       row_km = 6, column_km = 6, row_km_repeats = 100, column_km_repeats = 100,
                       top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T, 
                       column_title = 'Aggregated unannotated fetal coexpression network')

un_fetal_map = draw(un_fetal_map)
un_fetal_clusters = row_order(un_fetal_map)


#Get marker annotations
fetal_marker_annot_vec = rep('non-marker', length = nrow(fetal_agg_marker))
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% intProg_markers$gene] = 'Fetal Intermediate Progenitor marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% gaba_markers$gene] = 'Fetal GABAergic marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% glut_markers$gene] = 'Fetal Glutamatergic marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nProg_markers$gene] = 'Fetal Neural Progenitor marker' 
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% nonN_markers$gene] = 'Fetal Non-neuronal marker'
fetal_marker_annot_vec[rownames(fetal_agg_marker) %in% divProg_markers$gene] = 'Fetal Dividing Progenitor marker'

top_ha = HeatmapAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette))
row_ha = rowAnnotation(fetal_marker = fetal_marker_annot_vec, 
                       col = list(fetal_marker = class_marker_palette), show_legend = F)

fetal_map = Heatmap(fetal_agg_marker, show_row_names = F, show_column_names = F, col = col_fun, name = 'Aggregate coexpression',
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2',
        row_km = 6, column_km = 6, row_km_repeats = 100, column_km_repeats = 100,
        top_annotation = top_ha, left_annotation = row_ha, show_row_dend = F, show_column_dend = T, use_raster = T,
        column_title = 'Aggregated fetal coexpression network')

fetal_map = draw(fetal_map)
fetal_clusters = row_order(fetal_map)

```




```{r}
library(fossil)
```


```{r}



#Take in a list of cluster IDs with the total number of elements in the clustering
#Output a vector of cluster IDs for the clustered elements in the order before their clustering
get_cluster_ids = function(cluster_list, vec_length){
  
  clustering = rep(0, length = vec_length)
  for(i in 1:length(cluster_list)){ clustering[cluster_list[[i]]] = i }
  
  return(clustering)
}


test_org_clust = get_cluster_ids(org_clusters, max(unlist(org_clusters)))
test_fetal_clust = get_cluster_ids(fetal_clusters, max(unlist(fetal_clusters)))
test_un_fetal_clust = get_cluster_ids(un_fetal_clusters, max(unlist(un_fetal_clusters)))



rand.index(real_clust, test_fetal_clust)
adj.rand.index(real_clust, test_fetal_clust)

rand.index(real_clust, test_un_fetal_clust)
adj.rand.index(real_clust, test_un_fetal_clust)

rand.index(real_clust, test_org_clust)
adj.rand.index(real_clust, test_org_clust)





```

```{r}

#Take in a list of cluster IDs with the total number of elements in the clustering
#Output a vector of cluster IDs for the clustered elements in the order before their clustering
get_cluster_ids = function(cluster_list, vec_length){
  
  clustering = rep(0, length = vec_length)
  for(i in 1:length(cluster_list)){ clustering[cluster_list[[i]]] = i }
  
  return(clustering)
}

get_rands_index = function(coexp_file_path, all_marker_genes, real_clust, adjusted = TRUE){
  
  x = load(coexp_file_path)
  rank_corr_matrix = get(x)
  rm(x)
  
  #Reorder the co-expression marker subsets to all have the same ordering. Doesn't impact the clustering, just matches so we can compare clustering to the theoretical clusters
  rank_corr_matrix = rank_corr_matrix[rownames(rank_corr_matrix) %in% all_marker_genes, colnames(rank_corr_matrix) %in% all_marker_genes ]
  index = match(all_marker_genes, rownames(rank_corr_matrix))
  rank_corr_matrix = rank_corr_matrix[index, index]
  
  #Cluster and get the dendrogram splits, easiest to just use Heatmap function
  coexp_map = Heatmap(rank_corr_matrix,
        clustering_distance_rows = function(m) as.dist(1-m), clustering_distance_columns = function(m) as.dist(1-m),
        clustering_method_rows = 'ward.D2', clustering_method_columns = 'ward.D2',
        row_km = 6, column_km = 6, row_km_repeats = 100, column_km_repeats = 100)

  #Sends a warning, only relevant if doing random seed clustering like kmeans
  coexp_clusters = suppressWarnings(row_order(coexp_map))
  #Get a vector of cluster IDs
  test_clust = get_cluster_ids(coexp_clusters, max(unlist(coexp_clusters)))
  #Compute the adjusted Rands Index stat against the theoretical clusters
  
  if(adjusted){rands_index = adj.rand.index(real_clust, test_clust)
  }else{rands_index = rand.index(real_clust, test_clust)}
  
  return(rands_index)
  
}


```




```{r}

coexp_file = '../data/coexpression/fetal/agg_unannot_fetal_coexp_network_8_17_23.Rdata'

test_org_rands = get_rands_index(coexp_file, all_marker_genes, real_clust)
test_org_rands

```


Go through all the coexpression networks, fetal, organoid, aggregated, and get the rands index

```{r}

ranked_fetal_coexp_paths = c( '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_fan_fu_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_poliodakis_batch1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_poliodakis_batch2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW14_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW18_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW19_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW19_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_31_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_34_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW25_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW5_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW5-5_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-6_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-6_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-7_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_3_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_4_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW7_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW7-5_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_3_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-5_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-5_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW9-2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW9-5_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW10_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW11-5_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW12_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW13_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW14_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_shi_wang_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_yu_sun_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_yu_sun_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_yu_sun_3_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_yu_sun_4_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_trevino_greenleaf_1_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_trevino_greenleaf_2_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_trevino_greenleaf_3_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_trevino_greenleaf_4_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_zhou_lu_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_areal_GW16_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_areal_GW18_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_areal_GW22_coexp.Rdata',
                 '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_areal_GW22T_coexp.Rdata')

aggregate_coexp_paths = c('../data/coexpression/fetal/agg_fetal_coexp_network_8_17_23.Rdata',
                          '../data/coexpression/fetal/agg_unannot_fetal_coexp_network_8_17_23.Rdata',
                          '../data/coexpression/organoid/agg_organoid_coexp_network_8_17_23.Rdata')

org_coexp_paths = vector(mode = 'character', length = nrow(all_sample_meta))
for(i in 1:nrow(all_sample_meta)){
  org_coexp_paths[i] = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata',all_sample_meta$sample_ids[i])
}


all_coexp_paths = c(aggregate_coexp_paths, ranked_fetal_coexp_paths, org_coexp_paths)
length(all_coexp_paths)

```



```{r}

all_marker_genes = c(go_gaba, go_glut, go_nProg, go_nonN, go_intProg, go_divProg)
all_marker_genes = unique(all_marker_genes)

#Vector with the theoretical clustering, just cell-type groupings of the markers
real_clust = rep(0, length = length(all_marker_genes))
real_clust[all_marker_genes %in% go_gaba] = 1
real_clust[all_marker_genes %in% go_glut] = 2
real_clust[all_marker_genes %in% go_nProg] = 3
real_clust[all_marker_genes %in% go_nonN] = 4
real_clust[all_marker_genes %in% go_intProg] = 5
real_clust[all_marker_genes %in% go_divProg] = 6


#Get a dataframe of the adjusted and non-adjusted Rands Index for all the co-expression networks
rands_index_vec = vector(mode = 'numeric', length = length(all_coexp_paths))
adj_rands_index_vec = vector(mode = 'numeric', length = length(all_coexp_paths))

for(file in 1:length(all_coexp_paths)){
  start = Sys.time()
  rands_index_vec[file] = get_rands_index(all_coexp_paths[file], all_marker_genes, real_clust, adjusted = F)
  adj_rands_index_vec[file] = get_rands_index(all_coexp_paths[file], all_marker_genes, real_clust, adjusted = T)
  end = Sys.time()
  print(sprintf('Done with %i datasets...', file))
  print(end - start)
}

```


```{r}
dataset_names = c('aggregated_fetal','unannot_aggregated_fetal','aggregated_org',
                  'fan_fu', 'polio_batch1', 'polio_batch2', 'GW14_2', 'GW18_2', 'GW19', 'GW19_2','GW20','GW20_31','GW20_34','GW25',
                  'GW5','GW5-5','GW6_1','GW6_2','GW6-6_1','GW6-6_2','GW6-7','GW6-9_1','GW6-9_2','GW6-9_3','GW6-9_4','GW7','GW7-5','GW8_1','GW8_2','GW8_3','GW8-1','GW8-5_1',
                  'GW8-5_2','GW9-2','GW9-5','GW10','GW11-5','GW12','GW13','GW14_1',
                  'shi_wang','yu_sun_1','yu_sun_2','yu_sun_3','yu_sun_4', 'trevino_1','trevino_2','trevino_3','trevino_4','zhou_lu','GW16','GW18','GW22','GW22T',
                  all_sample_meta$sample_ids)

fetal_org_vec = c('aggregated','aggregated','aggregated', rep('fetal', length = 37), rep('unannot_fetal', length = 14), rep('organoid', length = nrow(all_sample_meta)))

rand_index_df = data.frame(dataset = dataset_names, fetal_annotation = fetal_org_vec, rands_index = rands_index_vec, adjusted_rands_index = adj_rands_index_vec )
rand_index_df$fetal_annotation = factor(rand_index_df$fetal_annotation, levels = c('aggregated','fetal','unannot_fetal','organoid'))


just_agg_df = filter(rand_index_df, fetal_annotation == 'aggregated' )
just_agg_df$fetal_annotation = c('fetal', 'unannot_fetal', 'organoid')
just_agg_df$fetal_annotation = factor(just_agg_df$fetal_annotation , levels = c('fetal','unannot_fetal','organoid'))
```


```{r}
shape_values = c('fetal' = 23, 'unannot_fetal' = 24 ,'organoid' = 22  )

ggplot(filter(rand_index_df, fetal_annotation != 'aggregated'), aes(x = fetal_annotation, y = rands_index)) + geom_boxplot() + ylim(0,1) +
  geom_point(data = just_agg_df, aes(shape = fetal_annotation), size = 3, alpha = 1, fill = 'black') +
  scale_shape_manual(values = shape_values) + ggtitle("Rand's index")
ggsave(filename = 'rands_index_boxplots_v3.pdf', path = 'graphs/coexpression', device = 'pdf', useDingbats = F, height = 4, width = 4)

ggplot(filter(rand_index_df, fetal_annotation != 'aggregated'), aes(x = fetal_annotation, y = adjusted_rands_index)) + geom_boxplot() + ylim(0,1) +
  geom_point(data = just_agg_df, aes(shape = fetal_annotation), size = 3, alpha = 1, fill = 'black') +
  scale_shape_manual(values = shape_values) + ggtitle("Adjusted Rand's index")
ggsave(filename = 'adjusted_rands_index_boxplots_v3.pdf', path = 'graphs/coexpression', device = 'pdf', useDingbats = F, height = 4, width = 4)
```

```{r}

save(rand_index_df, file = '../data/coexpression/rands_index_clustering_df_v3.Rdata')

```


```{r}
load('../data/coexpression/rands_index_clustering_df_v3.Rdata')
rand_index_df %>% arrange(desc(adjusted_rands_index))
```

```{r}

rand_index_df %>% group_by(fetal_annotation) %>% summarize(median = median(adjusted_rands_index))

rand_index_df %>% filter(fetal_annotation == 'aggregated')
```



number of organoid individual datasets that perform better than the worst performing fetal dataset

```{r}
#zhou_lu, then yu_sun_3 is the weakest fetal dataset
filter(rand_index_df, fetal_annotation == 'fetal') %>% arrange(adjusted_rands_index)


fetal_min = rand_index_df$adjusted_rands_index[rand_index_df$dataset== 'GW6_2']
fetal_min


just_org = filter(rand_index_df, fetal_annotation == 'organoid')
table(just_org$adjusted_rands_index >= fetal_min)

```










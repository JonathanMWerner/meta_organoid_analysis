
The organoid atlas from the arlotta lab with celltype annotations





```{r}
library(Seurat)
library(data.table)
library(ggplot2)
library(MetaMarkers)
library(dplyr)
library(MetBrewer)
library(parallel)
```

Original data from the Arlotta lab
Load it in and match the preprocessing steps from the rest of the analysis
Save an integrated object and then save individual objects for each dataset.
```{r}
org_23days = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/23d_harmonizedObj_060421.rds')
org_1month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1mo_harmonizedObj_111520_final.rds')
org_1.5month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1.5mo_harmonizedObj_060421.rds')
org_2month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/2mo_harmonizedObj_060421.rds')
org_3month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds')
org_4month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/4mo_harm_060421.rds')
org_5month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/5mo_harmonizedObj_060421_3.rds')
org_6month = readRDS('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds')

```

Class color palette
```{r}

#Get colors
class_palette = met.brewer("Archambault", 20)
class_marker_palette = c('Fetal Non-neuronal marker' = class_palette[20], 'Fetal GABAergic marker' = class_palette[1], 
                         'Fetal Glutamatergic marker' = class_palette[14], 
                         'Fetal Neural Progenitor marker' = class_palette[4],
                         'Fetal Intermediate Progenitor marker' = class_palette[16],
                         'Fetal Dividing Progenitor marker' = class_palette[10],
                         'non-marker' = 'white')

fetal_class_palette =  c('Non-neuronal' = class_palette[20], 'GABAergic' = class_palette[1], 
                         'Glutamatergic' = class_palette[14], 
                         'Neural_Progenitor' = class_palette[4],
                         'Intermediate_Progenitor' = class_palette[16],
                         'Dividing_Progenitor' = class_palette[10],
                         'other' = 'grey')


```



Combine all the metadata to get the full list of celltype annotations, ask the Arlotta lab for help grouping them into class annotations
3month_org was doing something weird, but is included in the annotations below
```{r}

all_annotations = c(org_23days$FinalName, org_1month$FinalName, org_1.5month$FinalName, org_2month$FinalName, 
                    org_4month$FinalName, org_5month$FinalName, org_6month$FinalName)

table(all_annotations)


```
Grouping the celltypes by class

```{r}

organoid_nProg_celltypes = c('aRG','oRG','oRG II', 'Subcortical progenitors', 'IN progenitors')
organoid_intProg_celltypes = c('IP')
organoid_nonN_celltypes = c('Astroglia','oRG/Astroglia','Glial precursors','Mesenchyme')
organoid_glut_celltypes = c('CFuPN','CPN','FOXG1- EMX1- neurons','Newborn CFuPN','Newborn CPN','Newborn DL PN','Newborn PN','PN',
                            'Subcortical neuronal precursors','Subcortical neurons','Preplate/Subplate')
organoid_gaba_celltypes = c('Immature IN','Subcortical interneurons')
organoid_other_celltypes = c('Unknown','Cajal Retzius','Cortical hem','Neural crest','Neural placode',
                             'Pre-delaminating neural crest')

```



For the organoid data, filter out the cells in accordance to the previous filtering on the other datasets

And renormalize with CPM
Save separately to keep the original data and the newly processed data

```{r}

org_23days[[]]
table(org_3month$dataset)
```


```{r}

org_23days = subset(org_23days, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_23days)
org_23days = NormalizeData(org_23days, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_23days = FindVariableFeatures(org_23days, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_23days)
org_23days = ScaleData(org_23days , features = all.genes, verbose = F)
org_23days = RunPCA(org_23days, features = VariableFeatures(object = org_23days), verbose = F)
org_23days = RunUMAP(org_23days, dims = 1:20, verbose = F)

DimPlot(org_23days, reduction = 'umap')
DimPlot(org_23days, reduction = 'umap', group.by = 'Phase')
DimPlot(org_23days, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_23days, reduction = 'umap', group.by = 'dataset')
```
Process each batch separately
```{r}
#Filter genes
org_23days = subset(org_23days, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_23days)

# split the dataset into a list of seurat oobbjects by batch
org_23days.list <- SplitObject(org_23days, split.by = "dataset")
# normalize and process each dataset independently
org_23days.list <- lapply(X = org_23days.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_23days.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_23days.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_23days.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_23days.list)){

  class_vec = org_23days.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_23days.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_23days.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_23days.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_23days_batch%i_processed.Rdata',i)
  dataset = org_23days.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_23days.list, dataset)
gc()
```


Integrate the batches

```{r}
#Trying batch correction on the library
org_23days$dataset = factor(org_23days$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_23days.list <- SplitObject(org_23days, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_23days.list <- lapply(X = org_23days.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_23days.list)
org_23days.anchors <- FindIntegrationAnchors(object.list = org_23days.list, anchor.features = features)

# this command creates an 'integrated' data assay
org_23days <- IntegrateData(anchorset = org_23days.anchors, features.to.integrate = rownames(org_23days@assays$RNA) )
DefaultAssay(org_23days) <- "integrated"

all.genes <- rownames(org_23days)
org_23days = ScaleData(org_23days , features = all.genes, verbose = F)
org_23days = RunPCA(org_23days, features = VariableFeatures(object = org_23days), verbose = F)
org_23days = RunUMAP(org_23days, dims = 1:20, verbose = F)


DimPlot(org_23days, reduction = 'umap')
DimPlot(org_23days, reduction = 'umap', group.by = 'Phase')
DimPlot(org_23days, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_23days, reduction = 'umap', group.by = 'dataset')
```

Group the celltype names into class level annotations
```{r}


class_vec = org_23days$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_23days$labeled_classes = class_vec
DimPlot(org_23days, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```
save and clear up memory
```{r}
save(org_23days, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_23days_processed.Rdata')
rm(org_23days.anchors, org_23days.list)
gc()
```


1 month organoid

```{r}
table(org_1month$dataset)
org_1month = subset(org_1month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_1month)
org_1month = NormalizeData(org_1month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_1month = FindVariableFeatures(org_1month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_1month)
org_1month = ScaleData(org_1month , features = all.genes, verbose = F)
org_1month = RunPCA(org_1month, features = VariableFeatures(object = org_1month), verbose = F)
org_1month = RunUMAP(org_1month, dims = 1:20, verbose = F)

DimPlot(org_1month, reduction = 'umap')
DimPlot(org_1month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_1month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_1month, reduction = 'umap', group.by = 'dataset')
```
Process each batch separately
```{r}
#Filter genes
org_1month = subset(org_1month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_1month)

# split the dataset into a list of seurat oobbjects by batch
org_1month.list <- SplitObject(org_1month, split.by = "dataset")
# normalize and process each dataset independently
org_1month.list <- lapply(X = org_1month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_1month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_1month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_1month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_1month.list)){

  class_vec = org_1month.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_1month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_1month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_1month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1month_batch%i_processed.Rdata',i)
  dataset = org_1month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_1month.list, dataset)
gc()
```




Integrate the batches

```{r}
#Trying batch correction on the library
org_1month$dataset = factor(org_1month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_1month.list <- SplitObject(org_1month, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_1month.list <- lapply(X = org_1month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_1month.list)
org_1month.anchors <- FindIntegrationAnchors(object.list = org_1month.list, anchor.features = features)
# this command creates an 'integrated' data assay
org_1month <- IntegrateData(anchorset = org_1month.anchors)
DefaultAssay(org_1month) <- "integrated"

all.genes <- rownames(org_1month)
org_1month = ScaleData(org_1month , features = all.genes, verbose = F)
org_1month = RunPCA(org_1month, features = VariableFeatures(object = org_1month), verbose = F)
org_1month = RunUMAP(org_1month, dims = 1:20, verbose = F)


DimPlot(org_1month, reduction = 'umap')
DimPlot(org_1month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_1month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_1month, reduction = 'umap', group.by = 'dataset')
```
Group the celltype names into class level annotations
```{r}


class_vec = org_1month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_1month$labeled_classes = class_vec
DimPlot(org_1month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```


```{r}
save(org_1month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1month_processed.Rdata')
rm(org_1month.anchors, org_1month.list)
gc()
```

1.5 month organoid
doesnt really look like it needs integration

```{r}

org_1.5month = subset(org_1.5month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_1.5month)
org_1.5month = NormalizeData(org_1.5month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_1.5month = FindVariableFeatures(org_1.5month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_1.5month)
org_1.5month = ScaleData(org_1.5month , features = all.genes, verbose = F)
org_1.5month = RunPCA(org_1.5month, features = VariableFeatures(object = org_1.5month), verbose = F)
org_1.5month = RunUMAP(org_1.5month, dims = 1:20, verbose = F)

DimPlot(org_1.5month, reduction = 'umap')
DimPlot(org_1.5month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_1.5month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_1.5month, reduction = 'umap', group.by = 'dataset')
```

Group the celltype names into class level annotations
```{r}


class_vec = org_1.5month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_1.5month$labeled_classes = class_vec
DimPlot(org_1.5month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

save(org_1.5month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1_5month_processed.Rdata')

```

Process each batch separately
```{r}
#Filter genes
org_1.5month = subset(org_1.5month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_1.5month)

# split the dataset into a list of seurat oobbjects by batch
org_1.5month.list <- SplitObject(org_1.5month, split.by = "dataset")
# normalize and process each dataset independently
org_1.5month.list <- lapply(X = org_1.5month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_1.5month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_1.5month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_1.5month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_1.5month.list)){

  class_vec = org_1.5month.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_1.5month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_1.5month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_1.5month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1_5month_batch%i_processed.Rdata',i)
  dataset = org_1.5month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_1.5month.list, dataset)
gc()
```





2month organoid

```{r}

org_2month = subset(org_2month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_2month)
org_2month = NormalizeData(org_2month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_2month = FindVariableFeatures(org_2month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_2month)
org_2month = ScaleData(org_2month , features = all.genes, verbose = F)
org_2month = RunPCA(org_2month, features = VariableFeatures(object = org_2month), verbose = F)
org_2month = RunUMAP(org_2month, dims = 1:20, verbose = F)


DimPlot(org_2month, reduction = 'umap')
DimPlot(org_2month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_2month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_2month, reduction = 'umap', group.by = 'dataset')
```
Process each batch separately
```{r}
#Filter genes
org_2month = subset(org_2month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_2month)

# split the dataset into a list of seurat oobbjects by batch
org_2month.list <- SplitObject(org_2month, split.by = "dataset")
# normalize and process each dataset independently
org_2month.list <- lapply(X = org_2month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_2month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_2month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_2month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_2month.list)){

  class_vec = org_2month.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_2month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_2month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_2month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_2month_batch%i_processed.Rdata',i)
  dataset = org_2month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_2month.list, dataset)
gc()
```



Integrate the batches

```{r}
#Trying batch correction on the library
org_2month$dataset = factor(org_2month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_2month.list <- SplitObject(org_2month, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_2month.list <- lapply(X = org_2month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_2month.list)
org_2month.anchors <- FindIntegrationAnchors(object.list = org_2month.list, anchor.features = features)
# this command creates an 'integrated' data assay
org_2month <- IntegrateData(anchorset = org_2month.anchors)
DefaultAssay(org_2month) <- "integrated"

all.genes <- rownames(org_2month)
org_2month = ScaleData(org_2month , features = all.genes, verbose = F)
org_2month = RunPCA(org_2month, features = VariableFeatures(object = org_2month), verbose = F)
org_2month = RunUMAP(org_2month, dims = 1:20, verbose = F)


DimPlot(org_2month, reduction = 'umap')
DimPlot(org_2month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_2month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_2month, reduction = 'umap', group.by = 'dataset')
```


Group the celltype names into class level annotations
```{r}

class_vec = org_2month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_2month$labeled_classes = class_vec
DimPlot(org_2month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```

```{r}
save(org_2month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_2month_processed.Rdata')
rm(org_2month.anchors, org_2month.list)
gc()
```


3month organoid

```{r}

org_3month = subset(org_3month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_3month)
org_3month = NormalizeData(org_3month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_3month = FindVariableFeatures(org_3month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_3month)
org_3month = ScaleData(org_3month , features = all.genes, verbose = F)
org_3month = RunPCA(org_3month, features = VariableFeatures(object = org_3month), verbose = F)
org_3month = RunUMAP(org_3month, dims = 1:20, verbose = F)


DimPlot(org_3month, reduction = 'umap')
DimPlot(org_3month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_3month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_3month, reduction = 'umap', group.by = 'dataset')

```
Process each batch separately
```{r}
#Filter genes
org_3month = subset(org_3month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_3month)
table(org_3month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_3month.list <- SplitObject(org_3month, split.by = "dataset")
# normalize and process each dataset independently
org_3month.list <- lapply(X = org_3month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_3month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_3month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_3month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_3month.list)){
  
  class_vec = as.character(org_3month.list[[i]]$FinalName)
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_3month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_3month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_3month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch%i_processed.Rdata',i)
  dataset = org_3month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_3month.list, dataset)
gc()
```


Integrate the batches

```{r}
#Trying batch correction on the library
org_3month$dataset = factor(org_3month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_3month.list <- SplitObject(org_3month, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_3month.list <- lapply(X = org_3month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_3month.list)
org_3month.anchors <- FindIntegrationAnchors(object.list = org_3month.list, anchor.features = features)
# this command creates an 'integrated' data assay
org_3month <- IntegrateData(anchorset = org_3month.anchors)
DefaultAssay(org_3month) <- "integrated"

all.genes <- rownames(org_3month)
org_3month = ScaleData(org_3month , features = all.genes, verbose = F)
org_3month = RunPCA(org_3month, features = VariableFeatures(object = org_3month), verbose = F)
org_3month = RunUMAP(org_3month, dims = 1:20, verbose = F)


DimPlot(org_3month, reduction = 'umap')
DimPlot(org_3month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_3month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_3month, reduction = 'umap', group.by = 'dataset')
```
 

Group the celltype names into class level annotations 
```{r}

class_vec = org_3month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_3month$labeled_classes = class_vec
DimPlot(org_3month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```

```{r}
save(org_3month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_processed.Rdata')
rm(org_3month.anchors, org_3month.list)
gc()
```






4month organoid

```{r}

org_4month = subset(org_4month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_4month)
org_4month = NormalizeData(org_4month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_4month = FindVariableFeatures(org_4month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_4month)
org_4month = ScaleData(org_4month , features = all.genes, verbose = F)
org_4month = RunPCA(org_4month, features = VariableFeatures(object = org_4month), verbose = F)
org_4month = RunUMAP(org_4month, dims = 1:20, verbose = F)


DimPlot(org_4month, reduction = 'umap')
DimPlot(org_4month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_4month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_4month, reduction = 'umap', group.by = 'dataset')
```

Process each batch separately
```{r}
#Filter genes
org_4month = subset(org_4month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_4month)

# split the dataset into a list of seurat oobbjects by batch
org_4month.list <- SplitObject(org_4month, split.by = "dataset")
# normalize and process each dataset independently
org_4month.list <- lapply(X = org_4month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_4month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_4month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_4month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_4month.list)){

  class_vec = org_4month.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_4month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_4month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_4month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_4month_batch%i_processed.Rdata',i)
  dataset = org_4month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_4month.list, dataset)
gc()
```


Integrate the batches

```{r}
#Trying batch correction on the library
org_4month$dataset = factor(org_4month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_4month.list <- SplitObject(org_4month, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_4month.list <- lapply(X = org_4month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_4month.list)
org_4month.anchors <- FindIntegrationAnchors(object.list = org_4month.list, anchor.features = features)
# this command creates an 'integrated' data assay
org_4month <- IntegrateData(anchorset = org_4month.anchors)
DefaultAssay(org_4month) <- "integrated"

all.genes <- rownames(org_4month)
org_4month = ScaleData(org_4month , features = all.genes, verbose = F)
org_4month = RunPCA(org_4month, features = VariableFeatures(object = org_4month), verbose = F)
org_4month = RunUMAP(org_4month, dims = 1:20, verbose = F)


DimPlot(org_4month, reduction = 'umap')
DimPlot(org_4month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_4month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_4month, reduction = 'umap', group.by = 'dataset')
```


Group the celltype names into class level annotations
```{r}

class_vec = org_4month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_4month$labeled_classes = class_vec
DimPlot(org_4month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```

```{r}
save(org_4month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_4month_processed.Rdata')
rm(org_4month.anchors, org_4month.list)
gc()
```




5month organoid

```{r}

org_5month = subset(org_5month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_5month)
org_5month = NormalizeData(org_5month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_5month = FindVariableFeatures(org_5month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_5month)
org_5month = ScaleData(org_5month , features = all.genes, verbose = F)
org_5month = RunPCA(org_5month, features = VariableFeatures(object = org_5month), verbose = F)
org_5month = RunUMAP(org_5month, dims = 1:20, verbose = F)


DimPlot(org_5month, reduction = 'umap')
DimPlot(org_5month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_5month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_5month, reduction = 'umap', group.by = 'dataset')
```
Process each batch separately
```{r}
#Filter genes
org_5month = subset(org_5month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_5month)

# split the dataset into a list of seurat oobbjects by batch
org_5month.list <- SplitObject(org_5month, split.by = "dataset")
# normalize and process each dataset independently
org_5month.list <- lapply(X = org_5month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_5month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_5month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_5month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_5month.list)){

  class_vec = org_5month.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_5month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_5month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_5month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_5month_batch%i_processed.Rdata',i)
  dataset = org_5month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_5month.list, dataset)
gc()
```



Integrate the batches

```{r}
#Trying batch correction on the library
org_5month$dataset = factor(org_5month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_5month.list <- SplitObject(org_5month, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_5month.list <- lapply(X = org_5month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_5month.list)
org_5month.anchors <- FindIntegrationAnchors(object.list = org_5month.list, anchor.features = features)
# this command creates an 'integrated' data assay
org_5month <- IntegrateData(anchorset = org_5month.anchors)
DefaultAssay(org_5month) <- "integrated"

all.genes <- rownames(org_5month)
org_5month = ScaleData(org_5month , features = all.genes, verbose = F)
org_5month = RunPCA(org_5month, features = VariableFeatures(object = org_5month), verbose = F)
org_5month = RunUMAP(org_5month, dims = 1:20, verbose = F)


DimPlot(org_5month, reduction = 'umap')
DimPlot(org_5month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_5month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_5month, reduction = 'umap', group.by = 'dataset')
```


Group the celltype names into class level annotations
```{r}

class_vec = org_5month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_5month$labeled_classes = class_vec
DimPlot(org_5month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```

```{r}
save(org_5month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_5month_processed.Rdata')
rm(org_5month.anchors, org_5month.list)
gc()
```



6 month organoid

```{r}

org_6month = subset(org_6month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
ncol(org_6month)
org_6month = NormalizeData(org_6month, verbose = F, normalization.method = 'RC', scale.factor = 1e6)
org_6month = FindVariableFeatures(org_6month, selection.method = "vst", nfeatures = 2000, verbose = F)
all.genes <- rownames(org_6month)
org_6month = ScaleData(org_6month , features = all.genes, verbose = F)
org_6month = RunPCA(org_6month, features = VariableFeatures(object = org_6month), verbose = F)
org_6month = RunUMAP(org_6month, dims = 1:20, verbose = F)


DimPlot(org_6month, reduction = 'umap')
DimPlot(org_6month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_6month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_6month, reduction = 'umap', group.by = 'dataset')
```

Process each batch separately
```{r}
#Filter genes
org_6month = subset(org_6month, subset = percent.mito < 50 & nFeature_RNA >=200 & nFeature_RNA <=6000 )
all.genes <- rownames(org_6month)
table(org_6month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_6month.list <- SplitObject(org_6month, split.by = "dataset")
# normalize and process each dataset independently
org_6month.list <- lapply(X = org_6month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
    x <- ScaleData(x , features = all.genes, verbose = F)
    x <- RunPCA(x, features = VariableFeatures(object = x), verbose = F)
    x <- RunUMAP(x, dims = 1:20, verbose = F)
})


lapply(X = org_6month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'dataset')
})
lapply(X = org_6month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'Phase')
})
lapply(X = org_6month.list, FUN = function(x) {
  DimPlot(x, reduction = 'umap', group.by = 'FinalName')
})

#Add class annotations and save each individual batch
for(i in 1:length(org_6month.list)){

  class_vec = org_6month.list[[i]]$FinalName
  class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
  class_vec[class_vec %in% organoid_intProg_celltypes] = 'Intermediate_Progenitor'
  class_vec[class_vec %in% c('Neural_Progenitor','Intermediate_Progenitor') & org_6month.list[[i]]$Phase %in% c('S','G2M') ] = 'Dividing_Progenitor'
  class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
  class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
  class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
  class_vec[class_vec %in% organoid_other_celltypes] = 'other'
  org_6month.list[[i]]$labeled_classes = class_vec
  print(DimPlot(org_6month.list[[i]], group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette))

  file_name = sprintf('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch%i_processed.Rdata',i)
  dataset = org_6month.list[[i]]
  save(dataset, file = file_name)
}

#Free up memory
rm(org_6month.list, dataset)
gc()
```

Integrate the batches

```{r}
#Trying batch correction on the library
org_6month$dataset = factor(org_6month$dataset)
# split the dataset into a list of seurat oobbjects by batch
org_6month.list <- SplitObject(org_6month, split.by = "dataset")

# normalize and identify variable features for each dataset independently
org_6month.list <- lapply(X = org_6month.list, FUN = function(x) {
    x <- NormalizeData(x, normalization.method = 'RC', scale.factor = 1e6, verbose = F)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = F)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = org_6month.list)
org_6month.anchors <- FindIntegrationAnchors(object.list = org_6month.list, anchor.features = features)
# this command creates an 'integrated' data assay
org_6month <- IntegrateData(anchorset = org_6month.anchors)
DefaultAssay(org_6month) <- "integrated"

all.genes <- rownames(org_6month)
org_6month = ScaleData(org_6month , features = all.genes, verbose = F)
org_6month = RunPCA(org_6month, features = VariableFeatures(object = org_6month), verbose = F)
org_6month = RunUMAP(org_6month, dims = 1:20, verbose = F)


DimPlot(org_6month, reduction = 'umap')
DimPlot(org_6month, reduction = 'umap', group.by = 'Phase')
DimPlot(org_6month, reduction = 'umap', group.by = 'FinalName')
DimPlot(org_6month, reduction = 'umap', group.by = 'dataset')
```


Group the celltype names into class level annotations
```{r}

class_vec = org_6month$FinalName

class_vec[class_vec %in% organoid_nProg_celltypes] = 'Neural_Progenitor'
class_vec[class_vec %in% organoid_nonN_celltypes] = 'Non-neuronal'
class_vec[class_vec %in% organoid_glut_celltypes] = 'Glutamatergic'
class_vec[class_vec %in% organoid_gaba_celltypes] = 'GABAergic'
class_vec[class_vec %in% organoid_other_celltypes] = 'other'

table(class_vec)

org_6month$labeled_classes = class_vec
DimPlot(org_6month, group.by = 'labeled_classes') + scale_color_manual(values = fetal_class_palette)

```

```{r}
save(org_6month, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_processed.Rdata')
rm(org_6month.anchors, org_6month.list)
gc()
```


```{r}
rm(org_6month.anchors, org_6month.list, org_5month.anchors, org_5month.list, org_4month.anchors, org_4month.list, org_3month.anchors, org_3month.list, org_1.5month, org_1month, org_2month, org_3month, org_4month, org_5month, org_6month, org_23days)
gc()

```


Load in all the processed datasets and take a look at the Fetal metamarkers

```{r}
#raw data

raw_org_atlas_paths = list('/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/23d_harmonizedObj_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/23d_harmonizedObj_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1mo_harmonizedObj_111520_final.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1mo_harmonizedObj_111520_final.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1mo_harmonizedObj_111520_final.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1mo_harmonizedObj_111520_final.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1.5mo_harmonizedObj_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/1.5mo_harmonizedObj_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/2mo_harmonizedObj_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/2mo_harmonizedObj_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/3mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/4mo_harm_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/4mo_harm_060421.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/5mo_harmonizedObj_060421_3.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/5mo_harmonizedObj_060421_3.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds',
                        '/home/werner/projects/meta_qc_organoid/datasets/arlotta_organoid_atlas/6mo_harm_111120.rds')


#Processed data
org_atlas_paths = list('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_23days_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_23days_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1month_batch3_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1month_batch4_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1_5month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_1_5month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_2month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_2month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch3_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch4_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch5_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_3month_batch6_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_4month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_4month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_5month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_5month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch1_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch2_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch3_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch4_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch5_processed.Rdata',
                       '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/arlotta_org_6month_batch6_processed.Rdata')

org_atlas_names = c('org_23days_batch1','org_23days_batch2',
                    'org_1month_batch1','org_1month_batch2','org_1month_batch3','org_1month_batch4',
                    'org_1_5month_batch1','org_1_5month_batch2',
                    'org_2month_batch1','org_2month_batch2',
                    'org_3month_batch1','org_3month_batch2','org_3month_batch3','org_3month_batch4','org_3month_batch5','org_3month_batch6',
                    'org_4month_batch1','org_4month_batch2',
                    'org_5month_batch1','org_5month_batch2',
                    'org_6month_batch1','org_6month_batch2','org_6month_batch3','org_6month_batch4','org_6month_batch5','org_6month_batch6')

```



Fetal MetaMarkers

```{r}
get_celltype_ranked_markers = function(metamarkers, celltype, num_markers, metric = 'rank'){
  
  if(metric != 'rank'){
    celltype_data = filter(metamarkers, cell_type == celltype) %>% arrange(desc(!!as.name(metric)))
    return(celltype_data[1:num_markers, ])}
  else{
    return(filter(metamarkers, cell_type == celltype & rank <= num_markers))
  }
}
```

```{r}
test_markers = list(
    fan_fu = read_markers("fan_fu_fetal_class_markers.csv.gz"), 
    poliodakis_1 = read_markers("poliodakis_batch1_fetal_class_markers.csv.gz"),
    poliodakis_2 = read_markers("poliodakis_batch2_fetal_class_markers.csv.gz"),
    GW14 = read_markers("areal_GW14_fetal_class_markers.csv.gz"),
    GW18_2 = read_markers("areal_GW18_2_fetal_class_markers.csv.gz"),
    GW19 = read_markers("areal_GW19_fetal_class_markers.csv.gz"),
    GW20 = read_markers("areal_GW20_fetal_class_markers.csv.gz"),
    GW20_31 = read_markers("areal_GW20_31_fetal_class_markers.csv.gz"),
    GW20_34 = read_markers("areal_GW20_34_fetal_class_markers.csv.gz"),
    GW25 = read_markers("areal_GW25_fetal_class_markers.csv.gz")
)
fetal_meta_markers = make_meta_markers(test_markers, detailed_stats = TRUE)

gaba_markers = get_celltype_ranked_markers(fetal_meta_markers, 'GABAergic',100, 'rank')
glut_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Glutamatergic',100, 'rank')
nProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Neural_Progenitor',100, 'rank')
intProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Intermediate_Progenitor',100, 'rank')
divProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Dividing_Progenitor',100, 'rank')
nonN_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Non-neuronal',100, 'rank')
```


```{r}

org_23days[[]]

```


```{r}
nrow(org_23days[[]])
table(org_23days$dataset)
table(org_23days$FinalName)
```


```{r}

for(i in 1:length(org_atlas_paths)){

  x = load(org_atlas_paths[[i]])
  dataset = get(x)
  rm(x)
  gc()
  
  gaba_agg_vec = rowSums(FetchData(dataset, gaba_markers$gene))
  glut_agg_vec = rowSums(FetchData(dataset, glut_markers$gene))
  nonN_agg_vec = rowSums(FetchData(dataset, nonN_markers$gene))
  nProg_agg_vec = rowSums(FetchData(dataset, nProg_markers$gene))
  intProg_agg_vec = rowSums(FetchData(dataset, intProg_markers$gene))
  divProg_agg_vec = rowSums(FetchData(dataset, divProg_markers$gene))
  
  dataset$fetal_gaba_agg_markers = gaba_agg_vec
  dataset$fetal_glut_agg_markers = glut_agg_vec
  dataset$fetal_nonN_agg_markers = nonN_agg_vec
  dataset$fetal_nProg_agg_markers = nProg_agg_vec
  dataset$fetal_intProg_agg_markers = intProg_agg_vec
  dataset$fetal_divProg_agg_markers = divProg_agg_vec
  
  print(DimPlot(dataset, group.by = 'FinalName') + ggtitle(org_atlas_names[i]))
  print(FeaturePlot(dataset, features = 'fetal_gaba_agg_markers')+ ggtitle(sprintf('%s: fetal_gaba_agg_markers', org_atlas_names[i])))
  print(FeaturePlot(dataset, features = 'fetal_glut_agg_markers')+ ggtitle(sprintf('%s: fetal_glut_agg_markers', org_atlas_names[i])))
  print(FeaturePlot(dataset, features = 'fetal_nonN_agg_markers')+ ggtitle(sprintf('%s: fetal_nonN_agg_markers', org_atlas_names[i])))
  print(FeaturePlot(dataset, features = 'fetal_nProg_agg_markers')+ ggtitle(sprintf('%s: fetal_nProg_agg_markers', org_atlas_names[i])))
  print(FeaturePlot(dataset, features = 'fetal_intProg_agg_markers')+ ggtitle(sprintf('%s: fetal_intProg_agg_markers', org_atlas_names[i])))
  print(FeaturePlot(dataset, features = 'fetal_divProg_agg_markers')+ ggtitle(sprintf('%s: fetal_divProg_agg_markers', org_atlas_names[i])))
}
```




Add data to the organoid sample metadata


organoid dataset metadata
```{r}

load('/home/werner/projects/meta_qc_organoid/data/seurat_objs/all_data_just_meta_seurat.Rdata')
```

```{r}

#Ignoring dataset 97
all_sample_meta = all_sample_meta[c(1:96, 98:99), ]
all_sample_meta
```

arlotta atlas organoid metadata

```{r}

for(i in 1:length(org_atlas_paths)){

  load(org_atlas_paths[[i]])
  
  sample_name = org_atlas_names[i]
  num_features = nrow(dataset)
  num_cells_filt = ncol(dataset)
  sample_path = raw_org_atlas_paths[[i]]
  unprocessed_sample_path = raw_org_atlas_paths[[i]]
  processed_sample_path = org_atlas_paths[[i]]
  
  metadata = c(i, sample_name, 'normal', 'normal', NA, num_features, 'raw', 'dorsal_patterned_forebrain', '10X',sample_path, 'seurat_obj', unprocessed_sample_path,
    processed_sample_path, num_cells_filt)
  
  all_sample_meta = rbind(all_sample_meta, metadata)


}


all_sample_meta

```
```{r}
sum(as.numeric(all_sample_meta$num_cells_filt))

```


Save the metadata
```{r}

save(all_sample_meta ,file ='/home/werner/projects/meta_qc_organoid/data/seurat_objs/all_data_just_meta_seurat.Rdata')
```
























Getting time series analysis using the annotated arlotta organoid dataset

Celltype prediction AUCs using individual fetal dataset markers, see if there is a trend across time points. Show the AUC using the full list of MetaMarkers


Conservation of Coexpression AUC using the individual fetal datasets as references, see if there is a trend across time points



```{r}
library(Seurat)
library(data.table)
library(ggplot2)
library(MetaMarkers)
library(dplyr)
library(MetBrewer)
library(tidyr)
library(tibble)
library(parallel)
library(viridis)
library(ComplexHeatmap)
library(circlize)
```



```{r}
class_palette = met.brewer("Archambault", 20)
class_palette

fetal_class_palette = c('Non-neuronal' = class_palette[20], 'GABAergic' = class_palette[1], 'Glutamatergic' = class_palette[14], 'Neural_Progenitor' = class_palette[4], 
                  'Dividing_Progenitor' = class_palette[10], 'Intermediate_Progenitor' = class_palette[16], 
                  'other' = 'grey')
fetal_class_palette

```


```{r}
get_celltype_ranked_markers = function(metamarkers, celltype, num_markers, metric = 'rank'){
  
  if(metric != 'rank'){
    celltype_data = filter(metamarkers, cell_type == celltype) %>% arrange(desc(!!as.name(metric)))
    return(celltype_data[1:num_markers, ])}
  else{
    return(filter(metamarkers, cell_type == celltype & rank <= num_markers))
  }
}
```

Fetal markers, datasets in chronological order
when using all the fetal data including the first trimester dataset
```{r}
test_markers = list(
    linnarsson_GW5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW5_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW5-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_6_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-6_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_6_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-6_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_7 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-7_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_3 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_3_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW6_point_9_4 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW6-9_4_fetal_class_markers_v3.csv.gz"), 
    linnarsson_GW7 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW7_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW7_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW7-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_3 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8_3_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_point_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8-1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_point_5_1 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8-5_1_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW8_point_5_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW8-5_2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW9_point_2 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW9-2_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW9_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW9-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW10 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW10_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW11_point_5 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW11-5_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW12 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW12_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW13 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW13_fetal_class_markers_v3.csv.gz"),
    linnarsson_GW14 = read_markers("8_17_23_linnarsson_metaMarkers/linnarsson_GW14_fetal_class_markers_v3.csv.gz"),
  areal_GW14 = read_markers("areal_GW14_fetal_class_markers.csv.gz"),
  poliodakis_1 = read_markers("poliodakis_batch1_fetal_class_markers.csv.gz"),
  poliodakis_2 = read_markers("poliodakis_batch2_fetal_class_markers.csv.gz"),
  areal_GW18_2 = read_markers("areal_GW18_2_fetal_class_markers.csv.gz"),
  areal_GW19 = read_markers("areal_GW19_fetal_class_markers.csv.gz"),
  areal_GW19_2 = read_markers("areal_GW19_2_fetal_class_markers.csv.gz"),
  areal_GW20 = read_markers("areal_GW20_fetal_class_markers.csv.gz"),
  areal_GW20_31 = read_markers("areal_GW20_31_fetal_class_markers.csv.gz"),
  areal_GW20_34 = read_markers("areal_GW20_34_fetal_class_markers.csv.gz"),
  areal_GW25 = read_markers("areal_GW25_fetal_class_markers.csv.gz"),
  fan_fu = read_markers("fan_fu_fetal_class_markers.csv.gz"))

fetal_meta_markers = make_meta_markers(test_markers, detailed_stats = TRUE)

fetal_time_names = c('GW5','GW5-5','GW6','GW6_2','GW6-6','GW6-6_2','GW6-7','GW6-9','GW6-9_2','GW6-9_3','GW6-9_4','GW7','GW7-5','GW8','GW8_2',
                     'GW8_3','GW8-1','GW8-5_1','GW8-5_2','GW9-2','GW9-5','GW10','GW11-5','GW12','GW13','GW14','GW14_2','GW17-18','GW17-18_2',
                     'GW18','GW19','GW19_2','GW20','GW20_2','GW20_3', 'GW25', 'GW7-28')

gaba_markers = get_celltype_ranked_markers(fetal_meta_markers, 'GABAergic',100, 'rank')
glut_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Glutamatergic',100, 'rank')
nProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Neural_Progenitor',100, 'rank')
nonN_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Non-neuronal',100, 'rank')
intProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Intermediate_Progenitor',100, 'rank')
divProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Dividing_Progenitor',100, 'rank')


table(gaba_markers$gene %in% glut_markers$gene)
table(gaba_markers$gene %in% nonN_markers$gene)
table(gaba_markers$gene %in% intProg_markers$gene)
table(gaba_markers$gene %in% divProg_markers$gene)
table(gaba_markers$gene %in% nProg_markers$gene)
table(glut_markers$gene %in% nonN_markers$gene)
table(glut_markers$gene %in% intProg_markers$gene)
table(glut_markers$gene %in% divProg_markers$gene)
table(glut_markers$gene %in% nProg_markers$gene)
table(nonN_markers$gene %in% intProg_markers$gene)
table(nonN_markers$gene %in% divProg_markers$gene)
table(nonN_markers$gene %in% nProg_markers$gene)
table(intProg_markers$gene %in% divProg_markers$gene)
table(intProg_markers$gene %in% nProg_markers$gene)
table(divProg_markers$gene %in% nProg_markers$gene)
```



Celltype AUC metamarker functions

```{r}
get_ranked_genes = function(de_list, celltype, metric, num_markers){
  
  #If ordering by metamarker rank, should not be descending, 1 is at the top
  if(metric == 'rank'){
    celltype_de = filter(de_list, celltype == cell_type) %>% arrange(!!as.name(metric)) 
  }else{ celltype_de = filter(de_list, celltype == cell_type) %>% arrange(desc(!!as.name(metric)))}
  
  top_markers = celltype_de$gene[1:num_markers]
  return(top_markers)
}


compute_auc = function(scores, label){
  label = as.logical(label)
  n1 = as.numeric(sum(label))
  n2 = as.numeric(sum(!label))
  R1 = sum(rank(scores)[label])
  U1 = R1 - n1 * (n1 + 1)/2
  auc = U1/(n1 * n2)
  return(auc)
}


auc_agg_predictor = function(dataset, metaMarkers, celltype, metric, num_markers){

  #get a marker set from the metamarkers, based on the metamarkers ranking
  marker_set = get_ranked_genes(metaMarkers, celltype, metric , num_markers )
  #Get an aggregate predictor from those markers
  agg_predictor = suppressWarnings(rowSums(FetchData(dataset ,marker_set )))
  #Get labels for the celltype identity
  cell_type_label = dataset[[]][ ,'labeled_classes'] == celltype
  #Calculate the AUC
  auc = compute_auc(agg_predictor, cell_type_label)
  
  return(auc)
}


```



organoid dataset metadata
```{r}

load('../data/seurat_objs/all_data_just_meta_seurat.Rdata')
dim(all_sample_meta)

all_sample_meta
```
Arlotta dataset is the 99 - 124 organoid datasets
Use the sample_ids as the dataset name

```{r}
org_dataset_paths = all_sample_meta$processed_seurat_path[99:124]
org_dataset_names = all_sample_meta$sample_ids[99:124]
names(org_dataset_paths) = all_sample_meta$sample_ids[99:124]

```



Barplot of the time points from the arlotta dataset
```{r}

time_palette = met.brewer("Tam", 8)
organoid_time_palette = c('23days' = time_palette[1],'1month' = time_palette[2],'1_5month' = time_palette[3],'2month' = time_palette[4],'3month' = time_palette[5],
                          '4month' = time_palette[6],'5month' = time_palette[7],'6month' = time_palette[8])

org_time_df = data.frame(timepoint = c('23days','1month','1_5month','2month','3month','4month','5month','6month'), 
                         num_datasets = c(2, 4, 2, 2, 6, 2, 2, 6))

org_time_df$timepoint= factor(org_time_df$timepoint, levels = c(org_time_df$timepoint) )
ggplot(org_time_df, aes(x = timepoint, y = num_datasets, fill = timepoint)) + geom_bar( stat = 'identity') +
  scale_fill_manual(values = time_palette, name = 'Organoid age') +
  ylab('# of datasets') + xlab('Organoid age') +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        legend.key.size = unit(.25, 'cm'))
#ggsave(filename = 'organoid_timeseries_barplot.pdf', path = 'graphs/', device = 'pdf', useDingbats = F,
#       height = 2.5 , width = 4.25 )
```







```{r}
n_markers = 100
rank_metric = 'auroc'

nProg_time_celltype_auc_matrix = matrix(nrow = length(org_dataset_paths), ncol = length(test_markers) +1, dimnames = list(org_dataset_names,c(fetal_time_names,'MetaMarkers') ))
divProg_time_celltype_auc_matrix = matrix(nrow = length(org_dataset_paths), ncol = length(test_markers)+1, dimnames = list(org_dataset_names,c(fetal_time_names,'MetaMarkers') ))
glut_time_celltype_auc_matrix = matrix(nrow = length(org_dataset_paths), ncol = length(test_markers)+1, dimnames = list(org_dataset_names,c(fetal_time_names,'MetaMarkers')))
gaba_time_celltype_auc_matrix = matrix(nrow = length(org_dataset_paths), ncol = length(test_markers)+1, dimnames = list(org_dataset_names,c(fetal_time_names,'MetaMarkers')))
nonN_time_celltype_auc_matrix = matrix(nrow = length(org_dataset_paths), ncol = length(test_markers)+1, dimnames = list(org_dataset_names,c(fetal_time_names,'MetaMarkers') ))
intProg_time_celltype_auc_matrix = matrix(nrow = length(org_dataset_paths), ncol = length(test_markers) +1, 
                                          dimnames = list(org_dataset_names,c(fetal_time_names,'MetaMarkers')))

for(j in 1:length(org_dataset_paths)){

  
  start = Sys.time()
  #Load in the dataset, called dataset
  load(org_dataset_paths[j])

  #Run through the marker lists of each individual fetal dataset, get AUC
  for(i in 1:length(test_markers)){
  
    current_de_markers = test_markers[[i]]
    
    #Check that dataset has DE stats for that celltype, some are missing Glut, GABA, and IntProg cell types
    if('Neural_Progenitor' %in% current_de_markers$cell_type){
      nProg_time_celltype_auc_matrix[j, i] = auc_agg_predictor(dataset, current_de_markers, 'Neural_Progenitor', metric = rank_metric, num_markers = n_markers)
    }else{nProg_time_celltype_auc_matrix[j, i] = NA}
    
    if('Dividing_Progenitor' %in% current_de_markers$cell_type){
      divProg_time_celltype_auc_matrix[j, i] = auc_agg_predictor(dataset, current_de_markers, 'Dividing_Progenitor', metric = rank_metric, num_markers = n_markers)
    }else{divProg_time_celltype_auc_matrix[j, i] = NA}
    
    if('Glutamatergic' %in% current_de_markers$cell_type){
      glut_time_celltype_auc_matrix[j, i] = auc_agg_predictor(dataset, current_de_markers, 'Glutamatergic', metric = rank_metric, num_markers = n_markers)
    }else{glut_time_celltype_auc_matrix[j, i] = NA}
    
    if('GABAergic' %in% current_de_markers$cell_type){
      gaba_time_celltype_auc_matrix[j, i] = auc_agg_predictor(dataset, current_de_markers, 'GABAergic', metric = rank_metric, num_markers = n_markers)
    }else{gaba_time_celltype_auc_matrix[j, i] = NA}
    
    if('Non-neuronal' %in% current_de_markers$cell_type){
      nonN_time_celltype_auc_matrix[j, i] = auc_agg_predictor(dataset, current_de_markers, 'Non-neuronal', metric = rank_metric, num_markers = n_markers)
    }else{nonN_time_celltype_auc_matrix[j, i] = NA}
    
    if('Intermediate_Progenitor' %in% current_de_markers$cell_type){
      intProg_time_celltype_auc_matrix[j, i] = auc_agg_predictor(dataset, current_de_markers, 'Intermediate_Progenitor', metric = rank_metric, num_markers = n_markers)
    }else{intProg_time_celltype_auc_matrix[j, i] = NA}
    
  }
  
  #Add the AUCs using the full MetaMarkers
  nProg_time_celltype_auc_matrix[j, length(test_markers) + 1] =  auc_agg_predictor(dataset, fetal_meta_markers, 'Neural_Progenitor', metric = 'rank', num_markers = n_markers)
  divProg_time_celltype_auc_matrix[j, length(test_markers) + 1] =  auc_agg_predictor(dataset, fetal_meta_markers, 'Dividing_Progenitor', metric = 'rank', num_markers = n_markers)
  glut_time_celltype_auc_matrix[j, length(test_markers) + 1] =  auc_agg_predictor(dataset, fetal_meta_markers, 'Glutamatergic', metric = 'rank', num_markers = n_markers)
  gaba_time_celltype_auc_matrix[j, length(test_markers) + 1] =  auc_agg_predictor(dataset, fetal_meta_markers, 'GABAergic', metric = 'rank', num_markers = n_markers)
  nonN_time_celltype_auc_matrix[j, length(test_markers) + 1] =  auc_agg_predictor(dataset, fetal_meta_markers, 'Non-neuronal', metric = 'rank', num_markers = n_markers)
  intProg_time_celltype_auc_matrix[j,length(test_markers) + 1] = auc_agg_predictor(dataset, fetal_meta_markers, 'Intermediate_Progenitor', metric = 'rank', num_markers = n_markers)
  
  end = Sys.time()
  print(end - start)
  print(sprintf('Done with %i datasets...', j))
}




```





vizualize the results

```{r}
time_palette = met.brewer("Tam", 8)
organoid_time_palette = c('23days' = time_palette[1],'1month' = time_palette[2],'1_5month' = time_palette[3],'2month' = time_palette[4],'3month' = time_palette[5],
                          '4month' = time_palette[6],'5month' = time_palette[7],'6month' = time_palette[8])


nProg_time_df = data.frame( nProg_time_celltype_auc_matrix)
nProg_time_df  = reshape2::melt(t(nProg_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'AUC')
divProg_time_df = data.frame( divProg_time_celltype_auc_matrix)
divProg_time_df  = reshape2::melt(t(divProg_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'AUC')
intProg_time_df = data.frame( intProg_time_celltype_auc_matrix)
intProg_time_df  = reshape2::melt(t(intProg_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'AUC')
glut_time_df = data.frame( glut_time_celltype_auc_matrix)
glut_time_df  = reshape2::melt(t(glut_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'AUC')
gaba_time_df = data.frame( gaba_time_celltype_auc_matrix)
gaba_time_df  = reshape2::melt(t(gaba_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'AUC')
nonN_time_df = data.frame( nonN_time_celltype_auc_matrix)
nonN_time_df  = reshape2::melt(t(nonN_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'AUC')

time_label = vector(mode = 'character', length = nrow(nProg_time_df))
time_label[grepl('org_23days', as.character(nProg_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(nProg_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(nProg_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(nProg_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(nProg_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(nProg_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(nProg_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(nProg_time_df$Organoid_timepoint))] = '6month'
nProg_time_df$time_label = time_label

time_label = vector(mode = 'character', length = nrow(divProg_time_df))
time_label[grepl('org_23days', as.character(divProg_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(divProg_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(divProg_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(divProg_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(divProg_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(divProg_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(divProg_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(divProg_time_df$Organoid_timepoint))] = '6month'
divProg_time_df$time_label = time_label

time_label = vector(mode = 'character', length = nrow(intProg_time_df))
time_label[grepl('org_23days', as.character(intProg_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(intProg_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(intProg_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(intProg_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(intProg_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(intProg_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(intProg_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(intProg_time_df$Organoid_timepoint))] = '6month'
intProg_time_df$time_label = time_label

time_label = vector(mode = 'character', length = nrow(glut_time_df))
time_label[grepl('org_23days', as.character(glut_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(glut_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(glut_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(glut_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(glut_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(glut_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(glut_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(glut_time_df$Organoid_timepoint))] = '6month'
glut_time_df$time_label = time_label

time_label = vector(mode = 'character', length = nrow(gaba_time_df))
time_label[grepl('org_23days', as.character(gaba_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(gaba_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(gaba_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(gaba_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(gaba_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(gaba_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(gaba_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(gaba_time_df$Organoid_timepoint))] = '6month'
gaba_time_df$time_label = time_label

time_label = vector(mode = 'character', length = nrow(nonN_time_df))
time_label[grepl('org_23days', as.character(nonN_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(nonN_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(nonN_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(nonN_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(nonN_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(nonN_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(nonN_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(nonN_time_df$Organoid_timepoint))] = '6month'
nonN_time_df$time_label = time_label

ggplot(nProg_time_df , aes(x = Fetal_timepoint, y = AUC, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ylab('Predicting Organoid celltypes (AUC)') + xlab('Fetal markers') + ylim(.25, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Neural Progenitors') + theme(axis.text.x = element_text(size = 7))
ggsave(filename = 'organoid_nProg_celltype_AUC_timeseries_with_firstTri_fetal_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)

ggplot(divProg_time_df , aes(x = Fetal_timepoint, y = AUC, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ylab('Predicting Organoid celltypes (AUC)') + xlab('Fetal markers') + ylim(.25, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Dividing Progenitors') + theme(axis.text.x = element_text(size = 7))
ggsave(filename = 'organoid_divProg_celltype_AUC_timeseries_with_firstTri_fetal_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)

ggplot(glut_time_df , aes(x = Fetal_timepoint, y = AUC, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ylab('Predicting Organoid celltypes (AUC)') + xlab('Fetal markers') + ylim(.25, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Glutamatergic Neurons') + theme(axis.text.x = element_text(size = 7))
ggsave(filename = 'organoid_glut_celltype_AUC_timeseries_with_firstTri_fetal_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
      height = 4, width = 10)


ggplot(gaba_time_df , aes(x = Fetal_timepoint, y = AUC, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ylab('Predicting Organoid celltypes (AUC)') + xlab('Fetal markers') + ylim(.25, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('GABAergic Neurons') + theme(axis.text.x = element_text(size = 7))
ggsave(filename = 'organoid_gaba_celltype_AUC_timeseries_with_firstTri_fetal_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)

ggplot(nonN_time_df , aes(x = Fetal_timepoint, y = AUC, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ylab('Predicting Organoid celltypes (AUC)') + xlab('Fetal markers') + ylim(.25, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Non-neuronal') + theme(axis.text.x = element_text(size = 7))
ggsave(filename = 'organoid_nonN_celltype_AUC_timeseries_with_firstTri_fetal_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)

ggplot(intProg_time_df , aes(x = Fetal_timepoint, y = AUC, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ylab('Predicting Organoid celltypes (AUC)') + xlab('Fetal markers') + ylim(.25, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Intermediate Progenitors') + theme(axis.text.x = element_text(size = 7))
ggsave(filename = 'organoid_intProg_celltype_AUC_timeseries_with_firstTri_fetal_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)

```


save results and get summary stats for the paper

```{r}

save(divProg_time_df, nProg_time_df, intProg_time_df, gaba_time_df, glut_time_df, nonN_time_df, 
     file = '../data/coexpression/org_timeseries_celltypeAUROC_dataframes.Rdata')


```


Difference in performance from GW5 and GW25 datasets
```{r}
divProg_time_df %>% group_by(Organoid_timepoint) %>% summarize(time_diff = AUC[Fetal_timepoint == 'GW5'] - AUC[Fetal_timepoint == 'GW25']) %>% 
  summarize(mean = abs(mean(time_diff)), sd = sd(time_diff))
nProg_time_df %>% group_by(Organoid_timepoint) %>% summarize(time_diff = AUC[Fetal_timepoint == 'GW5'] - AUC[Fetal_timepoint == 'GW25']) %>% 
  summarize(mean = abs(mean(time_diff)), sd = sd(time_diff))
glut_time_df %>% group_by(Organoid_timepoint) %>% summarize(time_diff = AUC[Fetal_timepoint == 'GW5'] - AUC[Fetal_timepoint == 'GW25']) %>% 
  summarize(mean = abs(mean(time_diff, na.rm = T)), sd = sd(time_diff, na.rm = T))
gaba_time_df %>% group_by(Organoid_timepoint) %>% summarize(time_diff = AUC[Fetal_timepoint == 'GW5'] - AUC[Fetal_timepoint == 'GW25']) %>% 
  summarize(mean = abs(mean(time_diff, na.rm = T)), sd = sd(time_diff, na.rm = T))
nonN_time_df %>% group_by(Organoid_timepoint) %>% summarize(time_diff = AUC[Fetal_timepoint == 'GW5'] - AUC[Fetal_timepoint == 'GW25']) %>% 
  summarize(mean = abs(mean(time_diff, na.rm = T)), sd = sd(time_diff, na.rm = T))
  
  
```


Get the variance of scores for each fetal timpoint across the organoid timepoints, compare to the variance of the MetaMarkers
```{r}

glut_time_df %>% filter(Fetal_timepoint != 'MetaMarkers') %>% group_by(Fetal_timepoint) %>% summarize(var = var(AUC, na.rm = T)) %>% summarize(mean_var = mean(var, na.rm = T))
glut_time_df %>% filter(Fetal_timepoint == 'MetaMarkers') %>% group_by(Fetal_timepoint) %>% summarize(var = var(AUC, na.rm = T))

gaba_time_df %>% filter(Fetal_timepoint != 'MetaMarkers') %>% group_by(Fetal_timepoint) %>% summarize(var = var(AUC, na.rm = T)) %>% summarize(mean_var = mean(var, na.rm = T))
gaba_time_df %>% filter(Fetal_timepoint == 'MetaMarkers') %>% group_by(Fetal_timepoint) %>% summarize(var = var(AUC, na.rm = T))

nonN_time_df %>% filter(Fetal_timepoint != 'MetaMarkers') %>% group_by(Fetal_timepoint) %>% summarize(var = var(AUC, na.rm = T)) %>% summarize(mean_var = mean(var, na.rm = T))
nonN_time_df %>% filter(Fetal_timepoint == 'MetaMarkers') %>% group_by(Fetal_timepoint) %>% summarize(var = var(AUC, na.rm = T))

```



##########################################
Time series for conserved coexpression

Same type of analysis as for the celltype AUCs, for each individual organoid network, use the individual fetal coexpression networks as the fetal reference to test conserved coexpression

Get the same normalized AUC metric across the marker sets


Use the unannotated fetal datasets too, at least all from the kreigstein dataset
And make an aggregate network with 

###########################################


```{r}

get_conserved_coexp = function(network1, network2, test_gene, num_top = 10){

  #Get the top 10 coexpressed genes
  test_gene_coexp = network1[test_gene, ]
  test_gene_coexp = test_gene_coexp[names(test_gene_coexp) != test_gene]
  top_coexp = names(test_gene_coexp[order(test_gene_coexp, decreasing = T)][1:num_top])
  
  #Calculate the AUC using the organoid data
  scores = network2[test_gene, ]
  scores = scores[names(scores) != test_gene]
  labels = names(scores) %in% top_coexp
  
  #Get the auc
  auc = compute_auc(scores, labels)
  return(auc)
}


```

```{r}
library(org.Hs.eg.db)
library(AnnotationDbi)

#GO database from GOSOURCEDATE: 2020-09-10, it's tied to the version of R. current version of R is 4.0.5
org.Hs.eg.db #running this will print out the GO database version information
go_table <- as.data.frame(org.Hs.egGO2ALLEGS) #gene mapping to the direct GO term and that term's children
go_table$gene_symbol = mapIds(org.Hs.eg.db, go_table$gene_id, "SYMBOL","ENTREZID") #Add gene symbol 

go_genes = unique(go_table$gene_symbol)
length(go_genes)
go_terms = unique(go_table$go_id)
length(go_terms)
```

fetal ranked coexp file paths

first and second trimester data
```{r}

fetal_ranked_coexp_paths = c(
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW5_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW5-5_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6_1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-6_1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-6_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-7_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_3_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_4_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW7_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW7-5_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_3_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-5_1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-5_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW9-2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW9-5_coexp.Rdata',  
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW10_coexp.Rdata',  
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW11-5_coexp.Rdata',  
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW12_coexp.Rdata',  
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW13_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW14_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW14_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_poliodakis_batch1_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_poliodakis_batch2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW18_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW19_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW19_2_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_31_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_34_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW25_coexp.Rdata',
  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_fan_fu_coexp.Rdata'
)

fetal_time_names = c('GW5','GW5-5','GW6_1','GW6_2','GW6-6_1','GW6-6_2','GW6-7','GW6-9_1','GW6-9_2','GW6-9_3','GW6-9_4','GW7','GW7-5','GW8_1','GW8_2',
                     'GW8_3','GW8-1','GW8-5_1','GW8-5_2','GW9-2','GW9-5','GW10','GW11-5','GW12','GW13','GW14_1','GW14_2','GW17-18_1','GW17-18_2','GW18_2','GW19',
                     'GW19_2','GW20','GW20_2','GW20_3','GW25', 'GW7-28')


```




```{r}
top_genes = 10

org_nProg_time_cons_coexp_matrix = matrix(nrow = length(org_dataset_names), ncol = length(fetal_ranked_coexp_paths), 
                                          dimnames = list(org_dataset_names, c(fetal_time_names)))
org_divProg_time_cons_coexp_matrix = matrix(nrow = length(org_dataset_names), ncol = length(fetal_ranked_coexp_paths), 
                                          dimnames = list(org_dataset_names, c(fetal_time_names)))
org_intProg_time_cons_coexp_matrix = matrix(nrow = length(org_dataset_names), ncol = length(fetal_ranked_coexp_paths), 
                                          dimnames = list(org_dataset_names, c(fetal_time_names)))
org_glut_time_cons_coexp_matrix = matrix(nrow = length(org_dataset_names), ncol = length(fetal_ranked_coexp_paths), 
                                          dimnames = list(org_dataset_names, c(fetal_time_names)))
org_gaba_time_cons_coexp_matrix = matrix(nrow = length(org_dataset_names), ncol = length(fetal_ranked_coexp_paths), 
                                          dimnames = list(org_dataset_names, c(fetal_time_names)))
org_nonN_time_cons_coexp_matrix = matrix(nrow = length(org_dataset_names), ncol = length(fetal_ranked_coexp_paths), 
                                          dimnames = list(org_dataset_names, c(fetal_time_names)))



for(j in 1:length(org_dataset_names)){
  
  start = Sys.time()
  corr_path = sprintf('../data/coexpression/organoid/8_17_23_GO_coexp/ranked_%s_coexp.Rdata', org_dataset_names[j])
  x = load(corr_path)
  organoid_rank_corr_matrix = get(x)
  rm(x, rank_corr_matrix)
  gc()
  
  for(k in 1:length(fetal_ranked_coexp_paths)){
  
    y = load(fetal_ranked_coexp_paths[k])
    fetal_rank_corr_matrix = get(y)
    rm(y, rank_corr_matrix)
    gc()
  
    current_de_markers = test_markers[[k]]

    #Get the conserved coexpression AUCs for the gene set and then the normalized AUC score for each geneset
    #some datasets dont have the annotated cell types
    #Grab the top 100 markers from each data and filter for the GO genes
    if('Neural_Progenitor' %in% current_de_markers$cell_type){
    nProg_markers_curr_dataset = get_celltype_ranked_markers(current_de_markers, 'Neural_Progenitor',100, 'auroc')
    go_nProg_markers_curr_dataset = nProg_markers_curr_dataset$gene[nProg_markers_curr_dataset$gene %in% go_genes]
    
    fetal_nProg_cons_coexp = sapply(1:length(go_nProg_markers_curr_dataset), 
                                    function(i) get_conserved_coexp(fetal_rank_corr_matrix, organoid_rank_corr_matrix, go_nProg_markers_curr_dataset[i],top_genes ) )
    org_nProg_time_cons_coexp_matrix[j,k] = sum(fetal_nProg_cons_coexp) /length(go_nProg_markers_curr_dataset)
    }else{org_nProg_time_cons_coexp_matrix[j,k] = NA}
    
    #Dividing progenitors
    if('Dividing_Progenitor' %in% current_de_markers$cell_type){
    divProg_markers_curr_dataset = get_celltype_ranked_markers(current_de_markers, 'Dividing_Progenitor',100, 'auroc')
    go_divProg_markers_curr_dataset = divProg_markers_curr_dataset$gene[divProg_markers_curr_dataset$gene %in% go_genes]    
    
    fetal_divProg_cons_coexp = sapply(1:length(go_divProg_markers_curr_dataset), 
                                      function(i) get_conserved_coexp(fetal_rank_corr_matrix, organoid_rank_corr_matrix, go_divProg_markers_curr_dataset[i],top_genes ) )
    org_divProg_time_cons_coexp_matrix[j,k] = sum(fetal_divProg_cons_coexp) /length(go_divProg_markers_curr_dataset)
    }else{org_divProg_time_cons_coexp_matrix[j,k] = NA}
    
    #Intermediate Progenitors
    if('Intermediate_Progenitor' %in% current_de_markers$cell_type){
    intProg_markers_curr_dataset = get_celltype_ranked_markers(current_de_markers, 'Intermediate_Progenitor',100, 'auroc')
    go_intProg_markers_curr_dataset = intProg_markers_curr_dataset$gene[intProg_markers_curr_dataset$gene %in% go_genes]      
    
    fetal_intProg_cons_coexp = sapply(1:length(go_intProg_markers_curr_dataset), 
                                      function(i) get_conserved_coexp(fetal_rank_corr_matrix, organoid_rank_corr_matrix, go_intProg_markers_curr_dataset[i],top_genes ) )
    org_intProg_time_cons_coexp_matrix[j,k] = sum(fetal_intProg_cons_coexp) /length(go_intProg_markers_curr_dataset)
    }else{org_intProg_time_cons_coexp_matrix[j,k] = NA}
    
    #Glutamatergic neurons
    if('Glutamatergic' %in% current_de_markers$cell_type){
    glut_markers_curr_dataset = get_celltype_ranked_markers(current_de_markers, 'Glutamatergic',100, 'auroc')
    go_glut_markers_curr_dataset = glut_markers_curr_dataset$gene[glut_markers_curr_dataset$gene %in% go_genes]      
    
    fetal_glut_cons_coexp = sapply(1:length(go_glut_markers_curr_dataset), 
                                   function(i) get_conserved_coexp(fetal_rank_corr_matrix, organoid_rank_corr_matrix, go_glut_markers_curr_dataset[i],top_genes ) )
    org_glut_time_cons_coexp_matrix[j,k] = sum(fetal_glut_cons_coexp) /length(go_glut_markers_curr_dataset)
    }else{org_glut_time_cons_coexp_matrix[j,k] = NA}
    
    #GABAergic neurons
    if('GABAergic' %in% current_de_markers$cell_type){
    gaba_markers_curr_dataset = get_celltype_ranked_markers(current_de_markers, 'GABAergic',100, 'auroc')
    go_gaba_markers_curr_dataset = gaba_markers_curr_dataset$gene[gaba_markers_curr_dataset$gene %in% go_genes]         
    
    fetal_gaba_cons_coexp = sapply(1:length(go_gaba_markers_curr_dataset), 
                                   function(i) get_conserved_coexp(fetal_rank_corr_matrix, organoid_rank_corr_matrix, go_gaba_markers_curr_dataset[i],top_genes ) )
    org_gaba_time_cons_coexp_matrix[j,k] = sum(fetal_gaba_cons_coexp) /length(go_gaba_markers_curr_dataset)
    }else{org_gaba_time_cons_coexp_matrix[j,k] = NA}
    
    #Non-neuronal 
    if('Non-neuronal' %in% current_de_markers$cell_type){
    nonN_markers_curr_dataset = get_celltype_ranked_markers(current_de_markers, 'Non-neuronal',100, 'auroc')
    go_nonN_markers_curr_dataset = nonN_markers_curr_dataset$gene[nonN_markers_curr_dataset$gene %in% go_genes]     
    
    fetal_nonN_cons_coexp = sapply(1:length(go_nonN_markers_curr_dataset), 
                                   function(i) get_conserved_coexp(fetal_rank_corr_matrix, organoid_rank_corr_matrix, go_nonN_markers_curr_dataset[i],top_genes ) )
    org_nonN_time_cons_coexp_matrix[j,k] = sum(fetal_nonN_cons_coexp) /length(go_nonN_markers_curr_dataset)
    }else{org_nonN_time_cons_coexp_matrix[j,k] = NA}
  }

  
  end = Sys.time()
  print(end - start)
  print(sprintf('Done with %i datasets...', j))
}
```


save the results with just the second trimester data
save the results including the first trimester data
```{r}

save(org_nProg_time_cons_coexp_matrix, file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_nProg_v3.Rdata')
save(org_divProg_time_cons_coexp_matrix, file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_divProg_v3.Rdata')
save(org_intProg_time_cons_coexp_matrix, file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_intProg_v3.Rdata')
save(org_gaba_time_cons_coexp_matrix, file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_gaba_v3.Rdata')
save(org_glut_time_cons_coexp_matrix, file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_glut_v3.Rdata')
save(org_nonN_time_cons_coexp_matrix, file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_nonN_v3.Rdata')


```


```{r}

load( file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_nProg_v3.Rdata')
load( file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_divProg_v3.Rdata')
load( file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_intProg_v3.Rdata')
load( file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_gaba_v3.Rdata')
load( file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_glut_v3.Rdata')
load( file = '../data/coexpression/org_timeseries_consCoexp_results_df_with_1st_trimester_nonN_v3.Rdata')
org_nProg_time_cons_coexp_matrix
```

```{r}
#Actually drop the aggregate score, there is a temporal trend and we want to highlight it
org_nProg_time_cons_coexp_matrix = org_nProg_time_cons_coexp_matrix[, !colnames(org_nProg_time_cons_coexp_matrix) %in% c('aggregate', 'GW7-28')]
org_divProg_time_cons_coexp_matrix = org_divProg_time_cons_coexp_matrix[, !colnames(org_divProg_time_cons_coexp_matrix) %in% c('aggregate', 'GW7-28')]
org_intProg_time_cons_coexp_matrix = org_intProg_time_cons_coexp_matrix[, !colnames(org_intProg_time_cons_coexp_matrix)%in% c('aggregate', 'GW7-28')]
org_gaba_time_cons_coexp_matrix = org_gaba_time_cons_coexp_matrix[, !colnames(org_gaba_time_cons_coexp_matrix) %in% c('aggregate', 'GW7-28')]
org_glut_time_cons_coexp_matrix = org_glut_time_cons_coexp_matrix[, !colnames(org_glut_time_cons_coexp_matrix) %in% c('aggregate', 'GW7-28')]
org_nonN_time_cons_coexp_matrix = org_nonN_time_cons_coexp_matrix[, !colnames(org_nonN_time_cons_coexp_matrix) %in% c('aggregate', 'GW7-28')]


org_nProg_time_cons_coexp_matrix 

```

```{r}
time_palette = met.brewer("Tam", 8)
organoid_time_palette = c('23days' = time_palette[1],'1month' = time_palette[2],'1_5month' = time_palette[3],'2month' = time_palette[4],'3month' = time_palette[5],
                          '4month' = time_palette[6],'5month' = time_palette[7],'6month' = time_palette[8])


nProg_time_df = data.frame( org_nProg_time_cons_coexp_matrix)
nProg_time_df  = reshape2::melt(t(nProg_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'Conserved_Coexpression_score')

time_label = vector(mode = 'character', length = nrow(nProg_time_df))
time_label[grepl('org_23days', as.character(nProg_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(nProg_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(nProg_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(nProg_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(nProg_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(nProg_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(nProg_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(nProg_time_df$Organoid_timepoint))] = '6month'
nProg_time_df$time_label = time_label
nProg_time_df$time_label = factor(nProg_time_df$time_label, levels = c('23days','1month','1_5month','2month','3month','4month','5month', '6month'))

ggplot(nProg_time_df , aes(x = Fetal_timepoint, y = Conserved_Coexpression_score, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  ylab('Conserved Coexpression score') + xlab('Fetal coexpression networks (Gestational Week)') + ylim(.5, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Neural Progenitors')
ggsave(filename = 'organoid_nProg_consCoexp_AUC_timeseries_with_1st_tri_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)



divProg_time_df = data.frame( org_divProg_time_cons_coexp_matrix)
divProg_time_df  = reshape2::melt(t(divProg_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'Conserved_Coexpression_score')

time_label = vector(mode = 'character', length = nrow(divProg_time_df))
time_label[grepl('org_23days', as.character(divProg_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(divProg_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(divProg_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(divProg_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(divProg_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(divProg_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(divProg_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(divProg_time_df$Organoid_timepoint))] = '6month'
divProg_time_df$time_label = time_label
divProg_time_df$time_label = factor(divProg_time_df$time_label, levels = c('23days','1month','1_5month','2month','3month','4month','5month', '6month'))

ggplot(divProg_time_df , aes(x = Fetal_timepoint, y = Conserved_Coexpression_score, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  ylab('Conserved Coexpression score') + xlab('Fetal coexpression networks (Gestational Week)') + ylim(.5, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Dividing Progenitors')
ggsave(filename = 'organoid_divProg_consCoexp_AUC_timeseries_with_1st_tri_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)


intProg_time_df = data.frame( org_intProg_time_cons_coexp_matrix)
intProg_time_df  = reshape2::melt(t(intProg_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'Conserved_Coexpression_score')

time_label = vector(mode = 'character', length = nrow(intProg_time_df))
time_label[grepl('org_23days', as.character(intProg_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(intProg_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(intProg_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(intProg_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(intProg_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(intProg_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(intProg_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(intProg_time_df$Organoid_timepoint))] = '6month'
intProg_time_df$time_label = time_label
intProg_time_df$time_label = factor(intProg_time_df$time_label, levels = c('23days','1month','1_5month','2month','3month','4month','5month', '6month'))

ggplot(intProg_time_df , aes(x = Fetal_timepoint, y = Conserved_Coexpression_score, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  ylab('Conserved Coexpression score') + xlab('Fetal coexpression networks (Gestational Week)') + ylim(.5, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Intermediate Progenitors')
ggsave(filename = 'organoid_intProg_consCoexp_AUC_timeseries_with_1st_tri_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)


glut_time_df = data.frame( org_glut_time_cons_coexp_matrix)
glut_time_df  = reshape2::melt(t(glut_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'Conserved_Coexpression_score')

time_label = vector(mode = 'character', length = nrow(glut_time_df))
time_label[grepl('org_23days', as.character(glut_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(glut_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(glut_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(glut_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(glut_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(glut_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(glut_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(glut_time_df$Organoid_timepoint))] = '6month'
glut_time_df$time_label = time_label
glut_time_df$time_label = factor(glut_time_df$time_label, levels = c('23days','1month','1_5month','2month','3month','4month','5month', '6month'))

ggplot(glut_time_df , aes(x = Fetal_timepoint, y = Conserved_Coexpression_score, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  ylab('Conserved Coexpression score') + xlab('Fetal coexpression networks (Gestational Week)') + ylim(.5, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Glutamatergic Neurons')
ggsave(filename = 'organoid_glut_consCoexp_AUC_timeseries_with_1st_tri_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)


gaba_time_df = data.frame( org_gaba_time_cons_coexp_matrix)
gaba_time_df  = reshape2::melt(t(gaba_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'Conserved_Coexpression_score')

time_label = vector(mode = 'character', length = nrow(gaba_time_df))
time_label[grepl('org_23days', as.character(gaba_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(gaba_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(gaba_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(gaba_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(gaba_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(gaba_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(gaba_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(gaba_time_df$Organoid_timepoint))] = '6month'
gaba_time_df$time_label = time_label
gaba_time_df$time_label = factor(gaba_time_df$time_label, levels = c('23days','1month','1_5month','2month','3month','4month','5month', '6month'))

ggplot(gaba_time_df , aes(x = Fetal_timepoint, y = Conserved_Coexpression_score, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  ylab('Conserved Coexpression score') + xlab('Fetal coexpression networks (Gestational Week)') + ylim(.5, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('GABAergic Neurons')
ggsave(filename = 'organoid_gaba_consCoexp_AUC_timeseries_with_1st_tri_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)


nonN_time_df = data.frame( org_nonN_time_cons_coexp_matrix)
nonN_time_df  = reshape2::melt(t(nonN_time_df), varnames = c('Fetal_timepoint','Organoid_timepoint'), value.name = 'Conserved_Coexpression_score')

time_label = vector(mode = 'character', length = nrow(nonN_time_df))
time_label[grepl('org_23days', as.character(nonN_time_df$Organoid_timepoint))] = '23days'
time_label[grepl('org_1month', as.character(nonN_time_df$Organoid_timepoint))] = '1month'
time_label[grepl('org_1_5month', as.character(nonN_time_df$Organoid_timepoint))] = '1_5month'
time_label[grepl('org_2month', as.character(nonN_time_df$Organoid_timepoint))] = '2month'
time_label[grepl('org_3month', as.character(nonN_time_df$Organoid_timepoint))] = '3month'
time_label[grepl('org_4month', as.character(nonN_time_df$Organoid_timepoint))] = '4month'
time_label[grepl('org_5month', as.character(nonN_time_df$Organoid_timepoint))] = '5month'
time_label[grepl('org_6month', as.character(nonN_time_df$Organoid_timepoint))] = '6month'
nonN_time_df$time_label = time_label
nonN_time_df$time_label = factor(nonN_time_df$time_label, levels = c('23days','1month','1_5month','2month','3month','4month','5month', '6month'))

ggplot(nonN_time_df , aes(x = Fetal_timepoint, y = Conserved_Coexpression_score, color = time_label, group = Organoid_timepoint)) + geom_point() + geom_line() +
  ylab('Conserved Coexpression score') + xlab('Fetal coexpression networks (Gestational Week)') + ylim(.5, 1) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + scale_color_manual(values = organoid_time_palette) +
  ggtitle('Non-neuronal')
ggsave(filename = 'organoid_nonN_consCoexp_AUC_timeseries_with_1st_tri_v3.pdf', path = 'graphs/organoid_timeseries/', device = 'pdf', useDingbats = F,
       height = 4, width = 10)


```





















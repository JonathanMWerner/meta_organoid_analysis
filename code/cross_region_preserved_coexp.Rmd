


Testing the preservation of co-expression across the different primary tissue brain regions

Really can only do this across the Bhaduri and Braun datasets, since they sample numerous brain regions

Exclude a dataset
Learn MetaMarkers from the rest
Aggregate the co-expression networks
Compute the preserved co-expression scores for the top 100 markers, but stratify by brain region.
So each brain region in the left out dataset gets its own co-expression network

Grab the cell number, median feature, median mitochondria for each brain region as well

Save results as: dataset_region as rows, scores and QC metrics as columns

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/home/werner/projects/meta_qc_organoid/code/')
```



```{r}
library(Seurat)
library(data.table)
library(ggplot2)
library(MetaMarkers)
library(dplyr)
library(MetBrewer)
library(parallel)


Sys.setenv(RETICULATE_PYTHON = "/usr/bin/python3.6")
library(reticulate)
np <- reticulate::import("numpy")

```

```{r}
source_python('python_coexpression.py')
```



Dataset paths

Datasets to test
```{r}


human_fetal_dataset_names = c( 
                               'linnarsson_GW5','linnarsson_GW5_point_5','linnarsson_GW6_1','linnarsson_GW6_2','linnarsson_GW6_point_6_1',
                               'linnarsson_GW6_point_6_2','linnarsson_GW6_point_7','linnarsson_GW6_point_9_1','linnarsson_GW6_point_9_2','linnarsson_GW6_point_9_3',
                               'linnarsson_GW6_point_9_4','linnarsson_GW7','linnarsson_GW7_point_5','linnarsson_GW8_1','linnarsson_GW8_2',
                               'linnarsson_GW8_3','linnarsson_GW8_point_1','linnarsson_GW8_point_5_1','linnarsson_GW8_point_5_2','linnarsson_GW9_point_2',
                               'linnarsson_GW9_point_5','linnarsson_GW10','linnarsson_GW11_point_5','linnarsson_GW12','linnarsson_GW13', 'linnarsson_GW14',
                               'areal_GW14','poliodakis_1', 'poliodakis_2','areal_GW18_2','areal_GW19','areal_GW19_2',
                               'areal_GW20','areal_GW20_31','areal_GW20_34','areal_GW25','fan_fu')

human_fetal_dataset_paths = list(
                                 '../data/seurat_objs/individual/linnarsson_GW5_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW5-5_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6_1_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6_2_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-6_1_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-6_2_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-7_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-9_1_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-9_2_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-9_3_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW6-9_4_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW7_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW7-5_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW8_1_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW8_2_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW8_3_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW8-1_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW8-5_1_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW8-5_2_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW9-2_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW9-5_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW10_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW11-5_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW12_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW13_processed.Rdata',
                                 '../data/seurat_objs/individual/linnarsson_GW14_processed.Rdata',
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW14.Rdata',
                                 '../data/seurat_objs/individual/poliodakis_geschwind_batch1_seurat_processed.Rdata',
                                 '../data/seurat_objs/individual/poliodakis_geschwind_batch2_seurat_processed.Rdata',
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW18_2.Rdata', 
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW19.Rdata', 
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW19_2.Rdata', 
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20.Rdata', 
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20_31.Rdata', 
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20_34.Rdata',
                                 '../data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW25.Rdata',
                                 '../data/seurat_objs/individual/fan_fu_seurat_processed.Rdata')


names(human_fetal_dataset_paths)= human_fetal_dataset_names 

fetal_ages = c('GW5','GW5-5','GW6_1','GW6_2','GW6-6_1','GW6-6_2','GW6-7','GW6-9_1','GW6-9_2','GW6-9_3','GW6-9_4','GW7','GW7-5','GW8_1','GW8_2','GW8_3','GW8-1','GW8-5_1','GW8-5_2','GW9-2',
               'GW9-5','GW10','GW11-5','GW12','GW13','GW14_1','GW14_2','GW17-18_1','GW17-18_2','GW18','GW19_1','GW19_2','GW20_1','GW20_2','GW20_3','GW25','GW7-28')

```


Dataset specific cell-type markers

```{r}
test_markers = list(
    fan_fu = read_markers("6_26_24_annot_metaMarkers/fan_fu_fetal_class_markers.csv.gz"), 
    poliodakis_1 = read_markers("6_26_24_annot_metaMarkers/poliodakis_batch1_fetal_class_markers.csv.gz"),
    poliodakis_2 = read_markers("6_26_24_annot_metaMarkers/poliodakis_batch2_fetal_class_markers.csv.gz"),
    GW14 = read_markers("6_26_24_annot_metaMarkers/areal_GW14_fetal_class_markers.csv.gz"),
    GW18_2 = read_markers("6_26_24_annot_metaMarkers/areal_GW18_2_fetal_class_markers.csv.gz"),
    GW19 = read_markers("6_26_24_annot_metaMarkers/areal_GW19_fetal_class_markers.csv.gz"),
    GW19_2 = read_markers("6_26_24_annot_metaMarkers/areal_GW19_2_fetal_class_markers.csv.gz"),
    GW20 = read_markers("6_26_24_annot_metaMarkers/areal_GW20_fetal_class_markers.csv.gz"),
    GW20_31 = read_markers("6_26_24_annot_metaMarkers/areal_GW20_31_fetal_class_markers.csv.gz"),
    GW20_34 = read_markers("6_26_24_annot_metaMarkers/areal_GW20_34_fetal_class_markers.csv.gz"),
    GW25 = read_markers("6_26_24_annot_metaMarkers/areal_GW25_fetal_class_markers.csv.gz"),
    linnarsson_GW5 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW5_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW5_point_5 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW5-5_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_1 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6_1_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_2 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6_2_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_6_1 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-6_1_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_6_2 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-6_2_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_7 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-7_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_9_1 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-9_1_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_9_2 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-9_2_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_9_3 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-9_3_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW6_point_9_4 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW6-9_4_fetal_class_markers_v4.csv.gz"), 
    linnarsson_GW7 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW7_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW7_point_5 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW7-5_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW8_1 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW8_1_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW8_2 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW8_2_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW8_3 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW8_3_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW8_point_1 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW8-1_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW8_point_5_1 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW8-5_1_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW8_point_5_2 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW8-5_2_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW9_point_2 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW9-2_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW9_point_5 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW9-5_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW10 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW10_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW11_point_5 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW11-5_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW12 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW12_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW13 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW13_fetal_class_markers_v4.csv.gz"),
    linnarsson_GW14 = read_markers("6_26_24_linnarsson_metaMarkers/linnarsson_GW14_fetal_class_markers_v4.csv.gz")
    )

```

Ranked co-expression networks

```{r}
ranked_go_coexp_paths =list(linnarsson_GW5 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW5_coexp.Rdata',
                 linnarsson_GW5_point_5 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW5-5_coexp.Rdata',
                 linnarsson_GW6_1 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6_1_coexp.Rdata',
                 linnarsson_GW6_2 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6_2_coexp.Rdata',
                 linnarsson_GW6_point_6_1 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-6_1_coexp.Rdata',
                 linnarsson_GW6_point_6_2 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-6_2_coexp.Rdata',
                 linnarsson_GW6_point_7 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-7_coexp.Rdata',
                 linnarsson_GW6_point_9_1 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_1_coexp.Rdata',
                 linnarsson_GW6_point_9_2 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_2_coexp.Rdata',
                 linnarsson_GW6_point_9_3 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_3_coexp.Rdata',
                 linnarsson_GW6_point_9_4 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW6-9_4_coexp.Rdata',
                 linnarsson_GW7 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW7_coexp.Rdata',
                 linnarsson_GW7_point_5 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW7-5_coexp.Rdata',
                 linnarsson_GW8_1 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_1_coexp.Rdata',
                 linnarsson_GW8_2 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_2_coexp.Rdata',
                 linnarsson_GW8_3 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8_3_coexp.Rdata',
                 linnarsson_GW8_point_1 =  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-1_coexp.Rdata',
                 linnarsson_GW8_point_5_1 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-5_1_coexp.Rdata',
                 linnarsson_GW8_point_5_2 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW8-5_2_coexp.Rdata',
                 linnarsson_GW9_point_2 =  '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW9-2_coexp.Rdata',
                 linnarsson_GW9_point_5 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW9-5_coexp.Rdata',
                 linnarsson_GW10 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW10_coexp.Rdata',
                 linnarsson_GW11_point_5 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW11-5_coexp.Rdata',
                 linnarsson_GW12 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW12_coexp.Rdata',
                 linnarsson_GW13 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW13_coexp.Rdata',
                 linnarsson_GW14 ='../data/coexpression/fetal/8_17_23_GO_coexp/ranked_linnarsson_GW14_coexp.Rdata',
                 GW14 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW14_coexp.Rdata',
                 poliodakis_1 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_poliodakis_batch1_coexp.Rdata',
                 poliodakis_2 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_poliodakis_batch2_coexp.Rdata',
                 GW18_2 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW18_2_coexp.Rdata',
                 GW19 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW19_coexp.Rdata',
                 GW19_2 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW19_2_coexp.Rdata',
                 GW20 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_coexp.Rdata',
                 GW20_31 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_31_coexp.Rdata',
                 GW20_34 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW20_34_coexp.Rdata',
                 GW25 = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_arealization_GW25_coexp.Rdata',
                 fan_fu = '../data/coexpression/fetal/8_17_23_GO_coexp/ranked_fan_fu_coexp.Rdata')


```

```{r}

#Get colors
class_palette = met.brewer("Archambault", 20)
class_marker_palette = c('Fetal Non-neuronal marker' = class_palette[20], 'Fetal GABAergic marker' = class_palette[1], 
                         'Fetal Glutamatergic marker' = class_palette[14], 
                         'Fetal Neural Progenitor marker' = class_palette[4],
                         'Fetal Intermediate Progenitor marker' = class_palette[16],
                         'Fetal Dividing Progenitor marker' = class_palette[10],
                         'Fetal Microglia/Immune marker' = class_palette[18],
                         'non-marker' = 'white')

class_celltype_palette = c('Non-neuronal' = class_palette[20], 'GABAergic' = class_palette[1], 
                         'Glutamatergic' = class_palette[14], 
                         'Neural_Progenitor' = class_palette[4],
                         'Intermediate_Progenitor' = class_palette[16],
                         'Dividing_Progenitor' = class_palette[10],
                         'Microglia/Immune' = class_palette[18],
                         'other' = 'white')

```


```{r}
get_celltype_ranked_markers = function(metamarkers, celltype, num_markers, metric = 'rank'){
  
  if(metric != 'rank'){
    celltype_data = filter(metamarkers, cell_type == celltype) %>% arrange(desc(!!as.name(metric)))
    return(celltype_data[1:num_markers, ])}
  else{
    return(filter(metamarkers, cell_type == celltype & rank <= num_markers))
  }
}


compute_auc = function(scores, label){
  label = as.logical(label)
  n1 = as.numeric(sum(label))
  n2 = as.numeric(sum(!label))
  R1 = sum(rank(scores)[label])
  U1 = R1 - n1 * (n1 + 1)/2
  auc = U1/(n1 * n2)
  return(auc)
}


get_conserved_coexp = function(network1, network2, test_gene, num_top = 10){

  #Get the top 10 coexpressed genes
  test_gene_coexp = network1[test_gene, ]
  test_gene_coexp = test_gene_coexp[names(test_gene_coexp) != test_gene]
  top_coexp = names(test_gene_coexp[order(test_gene_coexp, decreasing = T)][1:num_top])
  
  #Calculate the AUC using the organoid data
  scores = network2[test_gene, ]
  scores = scores[names(scores) != test_gene]
  labels = names(scores) %in% top_coexp
  
  #Get the auc
  auc = compute_auc(scores, labels)
  return(auc)
}

```

```{r}
load('../data/go_annotations/go_annotations.Rdata')
length(go_genes)


```



Leave a dataset out
Learn metamarkers and get the aggregate co-expression network
build co-expression networks for each region of the leaft out dataset
score preservation of co-expression for each region network

first trimester data regions are labeled as 'regions'
second trimester data regions are labeled as 'structures'




```{r}
#Only grab the cross regional altas datasets
dataset_index = which(grepl('linnarsson',human_fetal_dataset_names) | grepl('areal',human_fetal_dataset_names) )
top_genes = 10

all_region_df = data.frame(dataset_id = character(), region = character(), num_cells = numeric(),
                          median_feature =  numeric(), median_mito =  numeric(),
                          nProg_presCoexp =  numeric(), intProg_presCoexp =  numeric(), divProg_presCoexp =  numeric(),
                          gaba_presCoexp =  numeric(), glut_presCoexp =  numeric(), nonN_presCoexp =  numeric())


for(j in dataset_index){

  start = Sys.time()
  current_dataset = human_fetal_dataset_names[j]
  
  #Redo the metamarkers and get the top 100 cell type markers
  fetal_meta_markers = make_meta_markers(test_markers[names(test_markers) != current_dataset], detailed_stats = TRUE)
  
  gaba_markers = get_celltype_ranked_markers(fetal_meta_markers, 'GABAergic',100, 'rank')
  glut_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Glutamatergic',100, 'rank')
  nProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Neural_Progenitor',100, 'rank')
  nonN_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Non-neuronal',100, 'rank')
  intProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Intermediate_Progenitor',100, 'rank')
  divProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Dividing_Progenitor',100, 'rank')
  micro_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Microglia/Immune',100, 'rank')
  
  go_nProg = nProg_markers$gene[nProg_markers$gene %in% go_genes]
  go_nonN = nonN_markers$gene[nonN_markers$gene %in% go_genes]
  go_gaba = gaba_markers$gene[gaba_markers$gene %in% go_genes]
  go_glut = glut_markers$gene[glut_markers$gene %in% go_genes]
  go_intProg = intProg_markers$gene[intProg_markers$gene %in% go_genes]
  go_divProg = divProg_markers$gene[divProg_markers$gene %in% go_genes]
  go_micro = micro_markers$gene[micro_markers$gene %in% go_genes]
  
  #Ignore any duplicated markers
  all_markers = c(go_nProg, go_nonN, go_gaba, go_glut, go_intProg, go_divProg, go_micro)
  dup_genes = all_markers[duplicated(all_markers)]
  go_nProg = go_nProg[!go_nProg %in% dup_genes]
  go_divProg = go_divProg[!go_divProg %in% dup_genes]
  go_intProg = go_intProg[!go_intProg %in% dup_genes]
  go_gaba = go_gaba[!go_gaba %in% dup_genes]
  go_glut = go_glut[!go_glut %in% dup_genes]
  go_nonN = go_nonN[!go_nonN %in% dup_genes]
  go_micro = go_micro[!go_micro %in% dup_genes]
  
  #Leave one out and get the new aggregated fetal network
  sum_rank_corr_genes = matrix(rep(0, length(go_genes)^2), nrow = length(go_genes), ncol = length(go_genes), dimnames = list(go_genes, go_genes))
  current_ranked_go_coexp_paths = ranked_go_coexp_paths[names(ranked_go_coexp_paths) != current_dataset]
  
  for(i in 1:length(current_ranked_go_coexp_paths)){
    x = load(current_ranked_go_coexp_paths[[i]])
    rank_mat = get(x)
    rm(x)
    #Reorder to match the same gene order
    index = match(go_genes, rownames(rank_mat))
    rank_mat = rank_mat[index, index]
    sum_rank_corr_genes = sum_rank_corr_genes + rank_mat
  }
  #Divide sums by the number of datasets to get averages
  agg_rank_mat = sum_rank_corr_genes / length(current_ranked_go_coexp_paths)
  #Rank and normalize the network
  rank_corr_matrix = frank(c(agg_rank_mat), ties.method = 'min') - 1
  #Divide by max rank squeezes everything between 0 and 1
  norm_rank_corr = rank_corr_matrix / max(rank_corr_matrix)
  #Put back into a matrix
  agg_rank_mat = matrix(norm_rank_corr, nrow = nrow(agg_rank_mat), ncol = ncol(agg_rank_mat), 
                            dimnames = list(rownames(agg_rank_mat), colnames(agg_rank_mat)))
  #Set diagonal to 1
  diag(agg_rank_mat) = 1
  rm(rank_corr_matrix, norm_rank_corr)
  gc()
  print(Sys.time() - start)
  print('Done aggregating networks...')

  
  #Now load up the left out dataset and get region specific co-expression networks
  x = load(human_fetal_dataset_paths[[j]])
  current_exp_data = get(x)
  suppressWarnings(rm(x,seurat_object, GW14_merged_dataset, 
                      GW17_merged_dataset, GW18_2_merged_dataset, GW19_merged_dataset,
                      GW20_merged_dataset, GW20_31_merged_dataset, 
                      GW20_34_merged_dataset, GW25_merged_dataset, sum_rank_corr_genes))
  gc()
  
  
  # split the dataset into a list of seurat objects by region
  if(grepl('linnarsson',current_dataset)){
  regions_vec <- unique(current_exp_data$region)
  }else if(grepl('areal',current_dataset)){
    regions_vec <- unique(current_exp_data$structure)
  }
  
  num_cells_vec = vector(mode = 'numeric', length = length(regions_vec))
  median_feature_vec = vector(mode = 'numeric', length = length(regions_vec))
  median_mito_vec = vector(mode = 'numeric', length = length(regions_vec))
  nProg_scores = vector(mode = 'numeric', length = length(regions_vec))
  intProg_scores = vector(mode = 'numeric', length = length(regions_vec))
  divProg_scores = vector(mode = 'numeric', length = length(regions_vec))
  gaba_scores = vector(mode = 'numeric', length = length(regions_vec))
  glut_scores = vector(mode = 'numeric', length = length(regions_vec))
  nonN_scores = vector(mode = 'numeric', length = length(regions_vec))
  micro_scores = vector(mode = 'numeric', length = length(regions_vec))
  
  #Gene filtering for the dataset
  dataset_genes = rownames(current_exp_data)
  #Filter for the GO gene universe
  dataset_genes_in_go = dataset_genes[dataset_genes %in% go_genes]
  dataset_genes_missing_from_go = go_genes[! go_genes %in% dataset_genes]
  #Subset the gene expression for the genes present in GO
  dataset_gene_index = dataset_genes %in% dataset_genes_in_go
  

  #Now build a co-expression network for a region and compute the scores
  print('Starting region specific coexpression networks...')
  #Loop through...
  for(i in 1:length(regions_vec)){
    
  #Cells for the current region
  if(grepl('linnarsson',current_dataset)){
  cell_filt = current_exp_data$region == regions_vec[i]
  }else if(grepl('areal',current_dataset)){
    cell_filt = current_exp_data$structure == regions_vec[i]
  }
  
  num_cells_vec[i] = sum(cell_filt)
  median_feature_vec[i] = median(current_exp_data$nFeature_RNA[cell_filt])
  median_mito_vec[i] = median(current_exp_data$percent.mt[cell_filt])
  
  #Make the co-expression network
  exp_data = as.matrix(current_exp_data@assays$RNA@data[dataset_gene_index, cell_filt ])
  #Add zero counts for the missing GO genes
  go_missing = matrix(0, nrow = length(dataset_genes_missing_from_go), ncol = ncol(exp_data), 
                      dimnames = list(dataset_genes_missing_from_go, colnames(exp_data)))
  exp_data = rbind(exp_data, go_missing)
  r_genes = rownames(exp_data)

  #Get coexpression data
  test_py_exp = np$array(exp_data) #Turn R matrix into numpy array
  python_script_test = get_coexpression(test_py_exp, r_genes) #Python method for spearman correlations, coexpression
  corr_matrix = as.matrix(python_script_test) #Turn to matrix
  rm(exp_data, test_py_exp, python_script_test, go_missing )
  gc()
  
  #Convert Nans to 0, these are genes with 0 expression in any cells
  corr_matrix[!is.finite(corr_matrix)] = 0
  
  #Rank and normalize the network
  rank_corr_matrix = frank(c(corr_matrix), ties.method = 'min') - 1
  #Divide by max rank squeezes everything between 0 and 1
  norm_rank_corr = rank_corr_matrix / max(rank_corr_matrix)
  #Put back into a matrix
  dim(corr_matrix)
  corr_matrix = matrix(norm_rank_corr, nrow = nrow(corr_matrix), ncol = ncol(corr_matrix), 
                            dimnames = list(rownames(corr_matrix), colnames(corr_matrix)))
  diag(corr_matrix) = 1
  rm(rank_corr_matrix, norm_corr_matrix)
  gc()
  
  #And score the preservation of co-expression for the metamarker gene sets
  nProg_scores[i] = mean(unlist(mclapply(1:length(go_nProg), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_nProg[k],top_genes ), mc.cores = 10 )))
  intProg_scores[i] = mean(unlist(mclapply(1:length(go_intProg), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_intProg[k],top_genes), mc.cores = 10 )))
  divProg_scores[i] = mean(unlist(mclapply(1:length(go_divProg), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_divProg[k],top_genes ), mc.cores = 10 )))
  gaba_scores[i] = mean(unlist(mclapply(1:length(go_gaba), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_gaba[k],top_genes), mc.cores = 10 )))
  glut_scores[i] = mean(unlist(mclapply(1:length(go_glut), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_glut[k],top_genes), mc.cores = 10 )))
  nonN_scores[i] = mean(unlist(mclapply(1:length(go_nonN), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_nonN[k],top_genes), mc.cores = 10 )))
  micro_scores[i] = mean(unlist(mclapply(1:length(go_micro), function(k) get_conserved_coexp(agg_rank_mat, corr_matrix, go_micro[k],top_genes), mc.cores = 10 )))
  
  rm(corr_matrix, rank_corr_matrix, norm_rank_corr)
  gc()
  print(sprintf('Done with %i out of %i regions...', i, length(regions_vec)))
  
  }
  
  #And add everything to the main dataframe once done with all the regions
  current_df = data.frame(dataset_id = paste(current_dataset, regions_vec, sep = '_'), region = regions_vec, num_cells = num_cells_vec,
                          median_feature = median_feature_vec, median_mito = median_mito_vec,
                          nProg_presCoexp = nProg_scores, intProg_presCoexp = intProg_scores, divProg_presCoexp = divProg_scores,
                          gaba_presCoexp = gaba_scores, glut_presCoexp = glut_scores, nonN_presCoexp = nonN_scores, micro_presCoexp = micro_scores)

  all_region_df = rbind(all_region_df, current_df)
  rm(current_exp_data, agg_rank_mat)
  gc()
  print(Sys.time() - start)
  print(sprintf('Done with %i datasets', j))
  
}
```


```{r}
all_region_df
save(all_region_df, file = '../data/regional_marker_exp/region_presCoexp/all_region_presCoexp_v2.Rdata')

```


```{r}

load('../../../data/regional_marker_exp/region_presCoexp/all_region_presCoexp_v2.Rdata')
all_region_df
```






Load up the organoid metadata and plot similarly

```{r}

all_sample_meta = read.csv('../../../data/seurat_objs/all_data_just_meta_seurat_with_addl_features_v2.csv')
all_sample_meta
```


make bins to plot against with box plots for cell number and number of features

```{r}

fetal_cell_num_bins = rep('[100, 2500)', length = nrow(all_region_df))
fetal_cell_num_bins[all_region_df$num_cells >=2500 & all_region_df$num_cells < 5000 ] = '[2500, 5000)'
fetal_cell_num_bins[all_region_df$num_cells >=5000 & all_region_df$num_cells < 7500 ] = '[5000, 7500)'
fetal_cell_num_bins[all_region_df$num_cells >=7500 & all_region_df$num_cells < 10000 ] = '[7500, 10000)'
fetal_cell_num_bins[all_region_df$num_cells >=10000 & all_region_df$num_cells < 20000 ] = '[10000, 20000)'
fetal_cell_num_bins[all_region_df$num_cells >=20000 & all_region_df$num_cells < 30000 ] = '[20000, 30000)'
fetal_cell_num_bins[all_region_df$num_cells >=30000 & all_region_df$num_cells < 40000 ] = '[30000, 40000)'
fetal_cell_num_bins[all_region_df$num_cells >=40000 & all_region_df$num_cells < 80000 ] = '[40000, 80000)'

all_region_df$fetal_cell_num_bins = fetal_cell_num_bins


org_cell_num_bins = rep('[100, 2500)', length = nrow(all_sample_meta))
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=2500 & all_sample_meta$post_qc_cell_number < 5000 ] = '[2500, 5000)'
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=5000 & all_sample_meta$post_qc_cell_number < 7500 ] = '[5000, 7500)'
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=7500 & all_sample_meta$post_qc_cell_number < 10000 ] = '[7500, 10000)'
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=10000 & all_sample_meta$post_qc_cell_number < 20000 ] = '[10000, 20000)'
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=20000 & all_sample_meta$post_qc_cell_number < 30000 ] = '[20000, 30000)'
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=30000 & all_sample_meta$post_qc_cell_number < 40000 ] = '[30000, 40000)'
org_cell_num_bins[all_sample_meta$post_qc_cell_number >=40000 & all_sample_meta$post_qc_cell_number < 80000 ] = '[40000, 80000)'

all_sample_meta$org_cell_num_bins = org_cell_num_bins


all_region_df$fetal_cell_num_bins = factor(all_region_df$fetal_cell_num_bins, levels = c('[100, 2500)','[2500, 5000)','[5000, 7500)', '[7500, 10000)','[10000, 20000)', '[20000, 30000)',
                                                                                         '[30000, 40000)','[40000, 80000)' ))
all_sample_meta$org_cell_num_bins = factor(all_sample_meta$org_cell_num_bins, levels = c('[100, 2500)','[2500, 5000)','[5000, 7500)', '[7500, 10000)','[10000, 20000)', '[20000, 30000)',
                                                                                         '[30000, 40000)','[40000, 80000)' ))

table(all_region_df$fetal_cell_num_bins)
table(all_sample_meta$org_cell_num_bins)
```

```{r}

cell_num_df = data.frame(bins = c(all_region_df$fetal_cell_num_bins, all_sample_meta$org_cell_num_bins), 
                         nProg_scores = c(all_region_df$nProg_presCoexp, all_sample_meta$nProg_cons_coexp_metric),
                         divProg_scores = c(all_region_df$divProg_presCoexp, all_sample_meta$dividing_cons_coexp_metric),
                         intProg_scores = c(all_region_df$intProg_presCoexp, all_sample_meta$intProg_cons_coexp_metric),
                         gaba_scores = c(all_region_df$gaba_presCoexp, all_sample_meta$gaba_cons_coexp_metric),
                         glut_scores = c(all_region_df$glut_presCoexp, all_sample_meta$glut_cons_coexp_metric),
                         nonN_scores = c(all_region_df$nonN_presCoexp, all_sample_meta$nonN_cons_coexp_metric),
                         micro_scores = c(all_region_df$micro_presCoexp, all_sample_meta$micro_cons_coexp_metric),
                         labels = c(rep('Primary tissue', length = nrow(all_region_df)), rep('Organoid', length = nrow(all_sample_meta)))
                         ) 

ggplot(cell_num_df, aes(x = bins, y = nProg_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('Neural Prog. preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_nProg_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)

ggplot(cell_num_df, aes(x = bins, y = divProg_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('Dividing Prog. preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_divProg_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(cell_num_df, aes(x = bins, y = intProg_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('Intermediate Prog. preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_intProg_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(cell_num_df, aes(x = bins, y = glut_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('Glutamatergic preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_glut_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(cell_num_df, aes(x = bins, y = gaba_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('GABAergic preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_gaba_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(cell_num_df, aes(x = bins, y = nonN_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('Non-neuronal preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_nonN_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)

ggplot(cell_num_df, aes(x = bins, y = micro_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Number of cells') + ylab('Microglia/Immune preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_micro_presCoexp_num_cells_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


```

```{r}


fetal_feature_bins = rep('[100, 1000)', length = nrow(all_region_df))
fetal_feature_bins[all_region_df$median_feature >=1000 & all_region_df$median_feature < 2000 ] = '[1000, 2000)'
fetal_feature_bins[all_region_df$median_feature >=2000 & all_region_df$median_feature < 3000 ] = '[2000, 3000)'
fetal_feature_bins[all_region_df$median_feature >=3000 & all_region_df$median_feature < 4000 ] = '[3000, 4000)'
fetal_feature_bins[all_region_df$median_feature >=4000 & all_region_df$median_feature < 5000 ] = '[4000, 5000)'
fetal_feature_bins[all_region_df$median_feature >=5000 & all_region_df$median_feature < 6000 ] = '[5000, 6000)'
all_region_df$fetal_feature_bins = fetal_feature_bins


org_feature_bins = rep('[100, 1000)', length = nrow(all_sample_meta))
org_feature_bins[all_sample_meta$median_feature >=1000 & all_sample_meta$median_feature < 2000 ] = '[1000, 2000)'
org_feature_bins[all_sample_meta$median_feature >=2000 & all_sample_meta$median_feature < 3000 ] = '[2000, 3000)'
org_feature_bins[all_sample_meta$median_feature >=3000 & all_sample_meta$median_feature < 4000 ] = '[3000, 4000)'
org_feature_bins[all_sample_meta$median_feature >=4000 & all_sample_meta$median_feature < 5000 ] = '[4000, 5000)'
org_feature_bins[all_sample_meta$median_feature >=5000 & all_sample_meta$median_feature < 6000 ] = '[5000, 6000)'
all_sample_meta$org_feature_bins = org_feature_bins




all_region_df$fetal_feature_bins = factor(all_region_df$fetal_feature_bins, levels = c('[100, 1000)','[1000, 2000)','[2000, 3000)', '[3000, 4000)','[4000, 5000)', '[5000, 6000)'))
all_sample_meta$org_feature_bins = factor(all_sample_meta$org_feature_bins, levels = c('[100, 1000)','[1000, 2000)','[2000, 3000)', '[3000, 4000)','[4000, 5000)', '[5000, 6000)'))

table(all_region_df$fetal_feature_bins)
table(all_sample_meta$org_feature_bins)
```

```{r}

feature_num_df = data.frame(bins = c(all_region_df$fetal_feature_bins, all_sample_meta$org_feature_bins), 
                         nProg_scores = c(all_region_df$nProg_presCoexp, all_sample_meta$nProg_cons_coexp_metric),
                         divProg_scores = c(all_region_df$divProg_presCoexp, all_sample_meta$dividing_cons_coexp_metric),
                         intProg_scores = c(all_region_df$intProg_presCoexp, all_sample_meta$intProg_cons_coexp_metric),
                         gaba_scores = c(all_region_df$gaba_presCoexp, all_sample_meta$gaba_cons_coexp_metric),
                         glut_scores = c(all_region_df$glut_presCoexp, all_sample_meta$glut_cons_coexp_metric),
                         nonN_scores = c(all_region_df$nonN_presCoexp, all_sample_meta$nonN_cons_coexp_metric),
                         micro_scores = c(all_region_df$micro_presCoexp, all_sample_meta$micro_cons_coexp_metric),
                         labels = c(rep('Primary tissue', length = nrow(all_region_df)), rep('Organoid', length = nrow(all_sample_meta)))
                         ) 

ggplot(feature_num_df, aes(x = bins, y = nProg_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('Neural Prog. preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_nProg_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)

ggplot(feature_num_df, aes(x = bins, y = divProg_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('Dividing Prog. preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_divProg_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(feature_num_df, aes(x = bins, y = intProg_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('Intermediate Prog. preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_intProg_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(feature_num_df, aes(x = bins, y = glut_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('Glutamatergic preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_glut_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(feature_num_df, aes(x = bins, y = gaba_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('GABAergic preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_gaba_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)


ggplot(feature_num_df, aes(x = bins, y = nonN_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('Non-neuronal preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_nonN_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)

ggplot(feature_num_df, aes(x = bins, y = micro_scores, fill = labels)) + geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0, jitter.height = 0), alpha = .5, pch = 21) +
  scale_fill_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'grey')) +
  scale_color_manual(values = c('Organoid' = 'red', 'Primary tissue' = 'black')) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  xlab('Median detected genes') + ylab('Microglia/Immune preserved co-expression (AUROC)')
#ggsave(filename = 'xRegion_micro_presCoexp_num_feature_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 6)

```



```{r}
#Intermediate progenitors
temp_df = all_region_df %>% select(dataset_id, region, intProg_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue Intermediate progenitors') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_intProg_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)

#Neural progenitors
temp_df = all_region_df %>% select(dataset_id, region, nProg_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue Neural progenitors') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_nProg_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)

#Dividing progenitors
temp_df = all_region_df %>% select(dataset_id, region, divProg_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue Dividing progenitors') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_divProg_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)

#Glutamatergic
temp_df = all_region_df %>% select(dataset_id, region, glut_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue Glutamatergic neurons') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_glut_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)

#GABAergic
temp_df = all_region_df %>% select(dataset_id, region, gaba_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue GABAergic neurons') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_gaba_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)

#Non-neuronal
temp_df = all_region_df %>% select(dataset_id, region, nonN_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue Non-neuronal') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_nonN_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)

#Microglia/Immune
temp_df = all_region_df %>% select(dataset_id, region, micro_presCoexp)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ylim(.45, 1) + geom_hline(yintercept = .5, color = 'red', linetype = 'dashed') +
  ggtitle('Primary tissue Microglia/Immunel') + ylab('Preserved Co-expression score')
#ggsave(filename = 'fetal_regionSpecific_micro_scores_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)




#Cell number by region
temp_df = all_region_df %>% select(dataset_id, region, num_cells)
temp_df = reshape2::melt(temp_df)

summary_df = temp_df %>% group_by(region) %>% summarize(mean = mean(value)) %>% arrange(desc(mean))
temp_df$region = factor(temp_df$region, levels = c(summary_df$region))

ggplot(temp_df, aes(x = region, y = value)) + geom_violin(scale = 'width', width = .5) + 
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  geom_point(position = position_jitter(seed = 1, width = 0.05)) +
  ggtitle('All regions') + ylab('Cell number')
#ggsave(filename = 'fetal_regionSpecific_cell_nums_v2.pdf', path = 'graphs/cross_regional_presCoexp/', device = 'pdf', useDingbats = F, height = 4, width = 8)


```












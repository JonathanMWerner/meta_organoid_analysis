

Using the primary tissue metamarkers to generate broad cell-type annotations for the organoid datasets
Quantify the compositional variation across the protocols
Check out the arlotta datasets first since they have annotations, see how well the MetaMarker based annotations line up with the author provided annotations.


```{r}
library(Seurat)
library(matrixStats)
library(data.table)
library(ggplot2)
library(MetaMarkers)
library(dplyr)
library(MetBrewer)
library(ComplexHeatmap)
library(circlize)
library(tidyr)

```


```{r}

#Get colors
class_palette = met.brewer("Archambault", 20)
class_marker_palette = c('Non-neuronal' = class_palette[20], 'GABAergic' = class_palette[1], 
                         'Glutamatergic' = class_palette[14], 
                         'Neural_Progenitor' = class_palette[4],
                         'Intermediate_Progenitor' = class_palette[16],
                         'Dividing_Progenitor' = class_palette[10],
                         'Microglia/Immune' = class_palette[18],
                         'other' = 'white',
                         'unassigned' = 'grey')
  
```


```{r}
get_celltype_ranked_markers = function(metamarkers, celltype, num_markers, metric = 'rank'){
  
  if(metric != 'rank'){
    celltype_data = filter(metamarkers, cell_type == celltype) %>% arrange(desc(!!as.name(metric)))
    return(celltype_data[1:num_markers, ])}
  else{
    return(filter(metamarkers, cell_type == celltype & rank <= num_markers))
  }
}

```


```{r}
fetal_meta_markers = read_meta_markers("../../../data/metamarkers/fetal_meta_markers_v2.csv.gz")
fetal_meta_markers %>% filter(rank <= 20)



gaba_markers = get_celltype_ranked_markers(fetal_meta_markers, 'GABAergic',100, 'rank')
glut_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Glutamatergic',100, 'rank')
nProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Neural_Progenitor',100, 'rank')
nonN_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Non-neuronal',100, 'rank')
intProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Intermediate_Progenitor',100, 'rank')
divProg_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Dividing_Progenitor',100, 'rank')
micro_markers = get_celltype_ranked_markers(fetal_meta_markers, 'Microglia/Immune',100, 'rank')

#Ignore duplicates
all_markers = c( intProg_markers$gene, gaba_markers$gene, glut_markers$gene, nProg_markers$gene, divProg_markers$gene, nonN_markers$gene, micro_markers$gene )
dups = all_markers[duplicated(all_markers)]

intProg_markers = intProg_markers %>% filter(!gene %in% dups)
nProg_markers = nProg_markers %>% filter(!gene %in% dups)
divProg_markers = divProg_markers %>% filter(!gene %in% dups)
nonN_markers = nonN_markers %>% filter(!gene %in% dups)
gaba_markers = gaba_markers %>% filter(!gene %in% dups)
glut_markers = glut_markers %>% filter(!gene %in% dups)
micro_markers = micro_markers %>% filter(!gene %in% dups)

dim(intProg_markers)
dim(nProg_markers)
dim(divProg_markers)
dim(nonN_markers)
dim(gaba_markers)
dim(glut_markers)
dim(micro_markers)




```










organoid dataset metadata

```{r}

all_sample_meta = read.csv('../../../data/seurat_objs/all_data_just_meta_seurat_with_addl_features_v2.csv')
all_sample_meta


```


~/projects/meta_qc_organoid/code/scripts_final/6_26_24/organoid_composition.Rmd
```{r}

cell_types = c('Dividing_Progenitor','Neural_Progenitor','Intermediate_Progenitor','Glutamatergic','GABAergic','Non-neuronal', 'other')

#Ignoring duplicates
top_markers = filter(fetal_meta_markers, rank <= 15 & !cell_type %in% c('other','Microglia/Immune') )
dups = top_markers$gene[duplicated(top_markers$gene)]
top_markers = top_markers[!top_markers$gene %in% dups, ]
top_markers %>% group_by(cell_type) %>% summarize(n = n())

all_comp_df = data.frame(true_label = c(), true_label_percent = c(), predicted_percent = c(), dataset = c())
all_labeled_cellnum_df = data.frame(true_label = cell_types)

full_cellnum_mat = data.frame(true_label = cell_types, Dividing_Progenitor = 0, Glutamatergic = 0, Intermediate_Progenitor = 0, Neural_Progenitor = 0, 
                              `Non-neuronal` = 0, unassigned = 0, GABAergic = 0, check.names = F )

#The annotated organoid atlas datasets
for(i in 1:26){

  x = load(all_sample_meta$processed_seurat_path[i])
  dataset = get(x)
  
  ct_scores = score_cells(log1p(dataset@assays$RNA@data[]), top_markers)
  ct_enrichment = compute_marker_enrichment(ct_scores)
  ct_pred = assign_cells(ct_scores)
  ct_pred = ct_pred %>%
      mutate(true_label = dataset$labeled_classes)
  
  #Dataframe holding all the cell-type predictions
  dataset_all_nums_mat = ct_pred %>% group_by(true_label, predicted) %>% summarize(num_predicted = n()) %>% pivot_wider(names_from = predicted, values_from = num_predicted)
  missing = cell_types[!cell_types %in% dataset_all_nums_mat$true_label] 
  
  if(length(missing) != 0 ){
    temp_df = data.frame(true_label = missing, Dividing_Progenitor = 0, Glutamatergic = 0, Intermediate_Progenitor = 0, 
                         Neural_Progenitor = 0, `Non-neuronal` = 0, unassigned = 0, GABAergic = 0, check.names = F  )
    dataset_all_nums_mat = rbind(dataset_all_nums_mat, temp_df)
  }
  
  r_index = match(full_cellnum_mat$true_label,dataset_all_nums_mat$true_label )
  c_index = match(colnames(full_cellnum_mat), colnames(dataset_all_nums_mat))
  dataset_all_nums_mat = dataset_all_nums_mat[r_index, c_index ]
  dataset_all_nums_mat[is.na(dataset_all_nums_mat)] = 0
  full_cellnum_mat[ , 2:8]  = full_cellnum_mat[ , 2:8] + dataset_all_nums_mat[ ,2:8]
  
  #Dataframe to hold the number of cells per celltype for each dataset
  dataset_cellnum = ct_pred %>% group_by(true_label) %>% summarize(num_celltype = n())
  missing = cell_types[!cell_types %in% dataset_cellnum$true_label] 
  if(length(missing) !=0){
    temp_df = data.frame(true_label = missing, num_celltype = rep(0, length = length(missing)))
    dataset_cellnum = rbind(dataset_cellnum, temp_df)
  }
  index = match(all_labeled_cellnum_df$true_label, dataset_cellnum$true_label)
  all_labeled_cellnum_df = all_labeled_cellnum_df %>% mutate(!!all_sample_meta$sample_id[i] := dataset_cellnum$num_celltype[index])
  

  pred_comp_df = ct_pred %>% group_by(predicted) %>% summarize(predicted_percent = n()/nrow(ct_pred))
  true_comp_df = ct_pred %>% group_by(true_label) %>% summarize(true_label_percent = n()/nrow(ct_pred)) %>% add_row(true_label = 'unassigned', true_label_percent = 0)
  
  missing = cell_types[!cell_types %in% true_comp_df$true_label] 
  if(length(missing) != 0){
    temp_df = data.frame(true_label = missing, true_label_percent = rep(0, length = length(missing)))
    true_comp_df = rbind(true_comp_df, temp_df)
  }
  
  missing = cell_types[!cell_types %in% pred_comp_df$predicted] 
  if(length(missing) != 0){
    temp_df = data.frame(predicted = missing, predicted_percent = rep(0, length = length(missing)))
    pred_comp_df = rbind(pred_comp_df, temp_df)
  }
  
  index = match(true_comp_df$true_label, pred_comp_df$predicted)
  true_comp_df$predicted_percent = pred_comp_df$predicted_percent[index]
  
  true_comp_df$dataset = rep(all_sample_meta$sample_ids[i] , length = nrow(true_comp_df))
  
  
  all_comp_df = rbind(all_comp_df,true_comp_df )
  rm(dataset)
  gc()
  print(i)
}

all_comp_df
```


```{r}


ggplot(filter(all_comp_df, true_label == 'Dividing_Progenitor'),aes(x = true_label_percent, y = predicted_percent)) + geom_point() +
  xlim(0, .90) + ylim(0, .90) + xlab('Dividing_Progenitor %: Author annotations') + ylab('Dividing_Progenitor %: MetaMarker annotations') +
  ggtitle('Dividing Progenitors') + geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'red')
#ggsave(filename = 'arlotta_celltype_comp_divProg.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', device = 'pdf',
#       useDingbats = F, height = 4, width = 4)


ggplot(filter(all_comp_df, true_label == 'Neural_Progenitor'),aes(x = true_label_percent, y = predicted_percent)) + geom_point() +
  xlim(0, .90) + ylim(0, .90) + xlab('Neural_Progenitor %: Author annotations') + ylab('Neural_Progenitor %: MetaMarker annotations') +
  ggtitle('Neural Progenitors') + geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'red')
#ggsave(filename = 'arlotta_celltype_comp_nProg.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', device = 'pdf',
#       useDingbats = F, height = 4, width = 4)

ggplot(filter(all_comp_df, true_label == 'Intermediate_Progenitor'),aes(x = true_label_percent, y = predicted_percent)) + geom_point() +
  xlim(0, .90) + ylim(0, .90) + xlab('Intermediate_Progenitor %: Author annotations') + ylab('Intermediate_Progenitor %: MetaMarker annotations') +
  ggtitle('Intermediate Progenitors') + geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'red')
#ggsave(filename = 'arlotta_celltype_comp_intProg.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', device = 'pdf',
#       useDingbats = F, height = 4, width = 4)

ggplot(filter(all_comp_df, true_label == 'Glutamatergic'),aes(x = true_label_percent, y = predicted_percent)) + geom_point() +
  xlim(0, .90) + ylim(0, .90) + xlab('Glutamatergic %: Author annotations') + ylab('Glutamatergic %: MetaMarker annotations') +
  ggtitle('Glutamatergic') + geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'red')
#ggsave(filename = 'arlotta_celltype_comp_glut.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', device = 'pdf',
#       useDingbats = F, height = 4, width = 4)

ggplot(filter(all_comp_df, true_label == 'GABAergic'),aes(x = true_label_percent, y = predicted_percent)) + geom_point() +
  xlim(0, .90) + ylim(0, .90) + xlab('GABAergic %: Author annotations') + ylab('GABAergic %: MetaMarker annotations') +
  ggtitle('GABAergic') + geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'red')
#ggsave(filename = 'arlotta_celltype_comp_gaba.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', device = 'pdf',
#       useDingbats = F, height = 4, width = 4)

ggplot(filter(all_comp_df, true_label == 'Non-neuronal'),aes(x = true_label_percent, y = predicted_percent)) + geom_point() +
  xlim(0, .90) + ylim(0, .90) + xlab('Non-neuronal %: Author annotations') + ylab('Non-neuronal %: MetaMarker annotations') +
  ggtitle('Non-neuronal') + geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'red')
#ggsave(filename = 'arlotta_celltype_comp_nonN.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', device = 'pdf',
#       useDingbats = F, height = 4, width = 4)

```

```{r}
save(all_comp_df,all_labeled_cellnum_df,full_cellnum_mat,  
     file = '/home/werner/projects/meta_qc_organoid/data/organoid_composition/org_atlas_predicted_cell_type_data.Rdata')

```

```{r}
#Contains the all_comp_df,all_labeled_cellnum_df,full_cellnum_mat data
load( file = '/home/werner/projects/meta_qc_organoid/data/organoid_composition/org_atlas_predicted_cell_type_data.Rdata')

```


Confusion matrix of the predicted percentages of cell-types


```{r}
all_sums_df = data.frame(true_label = all_labeled_cellnum_df$true_label, cell_sums = rowSums(all_labeled_cellnum_df[ ,2:ncol(all_labeled_cellnum_df)]) )

percent_cellnum_mat = full_cellnum_mat
r_index = full_cellnum_mat$true_label == 'Dividing_Progenitor'
percent_cellnum_mat[r_index,2:8 ] = full_cellnum_mat[r_index,2:8 ] / all_sums_df$cell_sums[all_sums_df$true_label == 'Dividing_Progenitor']
r_index = full_cellnum_mat$true_label == 'Neural_Progenitor'
percent_cellnum_mat[r_index,2:8 ] = full_cellnum_mat[r_index,2:8 ] / all_sums_df$cell_sums[all_sums_df$true_label == 'Neural_Progenitor']
r_index = full_cellnum_mat$true_label == 'Intermediate_Progenitor'
percent_cellnum_mat[r_index,2:8 ] = full_cellnum_mat[r_index,2:8 ] / all_sums_df$cell_sums[all_sums_df$true_label == 'Intermediate_Progenitor']
r_index = full_cellnum_mat$true_label == 'Glutamatergic'
percent_cellnum_mat[r_index,2:8 ] = full_cellnum_mat[r_index,2:8 ] / all_sums_df$cell_sums[all_sums_df$true_label == 'Glutamatergic']
r_index = full_cellnum_mat$true_label == 'GABAergic'
percent_cellnum_mat[r_index,2:8 ] = full_cellnum_mat[r_index,2:8 ] / all_sums_df$cell_sums[all_sums_df$true_label == 'GABAergic']
r_index = full_cellnum_mat$true_label == 'Non-neuronal'
percent_cellnum_mat[r_index,2:8 ] = full_cellnum_mat[r_index,2:8 ] / all_sums_df$cell_sums[all_sums_df$true_label == 'Non-neuronal']

percent_cellnum_mat = percent_cellnum_mat[1:6, ]
r_names = percent_cellnum_mat$true_label
percent_cellnum_mat  = as.matrix(percent_cellnum_mat[ ,2:8])
rownames(percent_cellnum_mat ) = r_names
percent_cellnum_mat = percent_cellnum_mat[ ,c('Dividing_Progenitor','Neural_Progenitor','Intermediate_Progenitor','Glutamatergic','GABAergic','Non-neuronal','unassigned')]



col_fun = colorRamp2(c(0, .425, .85), c("blue", "white", "red"))
Heatmap(percent_cellnum_mat, show_row_dend = F, show_column_dend = F, cluster_rows = F, cluster_columns = F, col = col_fun, name = 'predicted percentage')


#pdf(file = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/confusion_matrix_arlotta.pdf', useDingbats = F, height = 4, width = 6)
#Heatmap(percent_cellnum_mat, show_row_dend = F, show_column_dend = F, cluster_rows = F, cluster_columns = F, col = col_fun, name = 'predicted percentage')
#dev.off()
```



Looks good, now run through all the organoid datasets and get the cell-type proportions
For the organoid datasets that do not use CPM, just use the author provided normalizations


```{r}


all_pred_comp_df = data.frame(predicted = c(), predicted_percent = c(), dataset = c())

for(i in 1:nrow(all_sample_meta)){
  
  start = Sys.time()
  x = load(all_sample_meta$processed_seurat_path[i])
  dataset = get(x)
  
  #Use log1p for the CPM datasets, otherwise just use the normalization already present
  if(all_sample_meta$Normalization.for.this.study[i] != 'CPM'){
    ct_scores = score_cells(dataset@assays$RNA@data[], top_markers)
  }else{
    ct_scores = score_cells(log1p(dataset@assays$RNA@data[]), top_markers)
  }
  #Get enrichments
  ct_enrichment = compute_marker_enrichment(ct_scores)
  #Assign cell-type annotations
  ct_pred = assign_cells(ct_scores)

  #Get percent annotation
  pred_comp_df = ct_pred %>% group_by(predicted) %>% summarize(predicted_percent = n()/nrow(ct_pred))
  #For any missing cell-types in the dataset
  missing = cell_types[!cell_types %in% pred_comp_df$predicted] 
  if(length(missing) != 0){
    temp_df = data.frame(predicted = missing, predicted_percent = rep(0, length = length(missing)))
    pred_comp_df = rbind(pred_comp_df, temp_df)
  }
  #Combine for all datasets
  pred_comp_df$dataset = rep(all_sample_meta$sample_ids[i] , length = nrow(pred_comp_df))
  all_pred_comp_df = rbind(all_pred_comp_df, pred_comp_df)
  end = Sys.time()
  print(end - start)
  print(sprintf('Done with %i datasets...', i))
  
}

```


```{r}
save(all_pred_comp_df, file = '/home/werner/projects/meta_qc_organoid/data/organoid_composition/predicted_celltype_comp_df.Rdata')

```

```{r}
load( file = '/home/werner/projects/meta_qc_organoid/data/organoid_composition/predicted_celltype_comp_df.Rdata')
all_pred_comp_df
```



```{r}


comp_for_clustering = all_pred_comp_df %>% tidyr::pivot_wider(names_from = predicted, values_from = predicted_percent) %>% select(-c('other'))
r_names = comp_for_clustering$dataset
comp_for_clustering = as.matrix(comp_for_clustering[ ,2:8])
rownames(comp_for_clustering) = r_names

comp_for_clustering[is.na(comp_for_clustering)] = 0
```

```{r}

unassigned_df = all_pred_comp_df %>% filter(predicted == 'unassigned') %>% arrange(desc(predicted_percent))


index = match(unassigned_df$dataset, all_sample_meta$sample_ids)
unassigned_df$normalization = all_sample_meta$Normalization.for.this.study[index]
unassigned_df$normalization = factor(unassigned_df$normalization , levels = c('CPM','log(CPM+1)','Default Seurat log normalization  ',
                                                                              'Seurat SCTransform','Default Seurat log normalization and UMI regression'))

ggplot(unassigned_df, aes(x = normalization, y = predicted_percent)) + geom_boxplot() +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) + ylab('Unassigned percentage')

ggsave(filename = 'unassigned_percent_normalizations.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
```



```{r}

#Get palette for the grouped described protocols
table(all_sample_meta$Protocol.classification.region)

sample_region_grouped_palette = met.brewer('Renoir', n = 14)
names(sample_region_grouped_palette) = names(table(all_sample_meta$Protocol.classification.region))

dataset_annot = HeatmapAnnotation(organoid = all_sample_meta$Protocol.classification.region, 
                                  col = list(organoid = sample_region_grouped_palette))





h1 = Heatmap(t(comp_for_clustering),clustering_distance_rows = "euclidean",clustering_distance_columns = "euclidean",
        show_column_names = F, show_row_dend = F, name = 'Cell-type composition',
         clustering_method_columns = "ward.D2" , top_annotation = dataset_annot)
h1 = draw(h1)


pdf(file = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/composition_heatmap.pdf', useDingbats = F, height = 4, width = 8)
h1 = Heatmap(t(comp_for_clustering),clustering_distance_rows = "euclidean",clustering_distance_columns = "euclidean",
        show_column_names = F, show_row_dend = F, name = 'Cell-type composition',
         clustering_method_columns = "ward.D2" , top_annotation = dataset_annot)
h1 = draw(h1)
dev.off()





```







Determine groups of datasets by composition and explore the preservation of co-expression scores across the groups

Also see how the preservation scores track as composition increases/decreases for each cell-type

```{r}
par(pty = 's')
plot(filter(all_pred_comp_df, predicted == 'Dividing_Progenitor')$predicted_percent, all_sample_meta$dividing_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'Dividing Progenitors')

plot(filter(all_pred_comp_df, predicted == 'Neural_Progenitor')$predicted_percent, all_sample_meta$nProg_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'Neural Progenitors')

plot(filter(all_pred_comp_df, predicted == 'Intermediate_Progenitor')$predicted_percent, all_sample_meta$intProg_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'Intermediate Progenitors')

plot(filter(all_pred_comp_df, predicted == 'GABAergic')$predicted_percent, all_sample_meta$gaba_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'GABAergic')

plot(filter(all_pred_comp_df, predicted == 'Glutamatergic')$predicted_percent, all_sample_meta$glut_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'Glutamatergic')

plot(filter(all_pred_comp_df, predicted == 'Non-neuronal')$predicted_percent, all_sample_meta$nonN_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'Non-neuronal')

plot(filter(all_pred_comp_df, predicted == 'Microglia/Immune')$predicted_percent, all_sample_meta$micro_cons_coexp_metric,
     ylab = 'Preserved co-expression score', xlab = 'Cell-type percent', main = 'Microglia/Immune')
```


```{r}
library(gridExtra)

```



```{r}

#Filtering out the normalizations that pretty much failed with MetaMarker annotations
keep_samples = all_sample_meta$sample_ids[!all_sample_meta$Normalization.for.this.study %in% c('Seurat SCTransform','Default Seurat log normalization and UMI regression')]
comp_for_clustering = comp_for_clustering[rownames(comp_for_clustering) %in% keep_samples, ]

meta_index = match(rownames(comp_for_clustering), all_sample_meta$sample_ids)



comp_scores = comp_for_clustering[ ,'Glutamatergic']
#range(comp_scores)
decile_label = rep('NA', length = nrow(comp_for_clustering))
decile_label[comp_scores <= .10] = '[0-10%]'
decile_label[comp_scores > .10 & comp_scores <= .20] = '(10-20%]'
decile_label[comp_scores > .20 & comp_scores <= .30] = '(20-30%]'
decile_label[comp_scores > .30 & comp_scores <= .40] = '(30-40%]'
decile_label[comp_scores > .40 & comp_scores <= .50] = '(40-50%]'
decile_label[comp_scores > .50 & comp_scores <= .60] = '(50-60%]'
decile_label[comp_scores > .60 & comp_scores <= .70] = '(60-70%]'
decile_label[comp_scores > .70 & comp_scores <= .80] = '(70-80%]'
decile_label[comp_scores > .80 & comp_scores <= .90] = '(80-90%]'
#Grab the preserved co-expression scores of that cell-type and add the celltype percentage of the datasets
temp_comp_df = data.frame(sample_id = all_sample_meta$sample_ids[meta_index], pres_score = all_sample_meta$glut_cons_coexp_metric[meta_index], 
                          egad_score = all_sample_meta$egad_auc_glut_markers[meta_index],
                          decile_label = decile_label, comp_scores = comp_scores)
temp_comp_df$decile_label = factor(temp_comp_df$decile_label, levels = c('[0-10%]','(10-20%]','(20-30%]','(30-40%]','(40-50%]','(50-60%]','(60-70%]','(70-80%]','(80-90%]'))

g1 = ggplot(temp_comp_df, aes(x = decile_label, y = pres_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Glutamatergic Preserved co-expression score') +
  xlab('Glutamatergic percentage') 
g2 = ggplot(temp_comp_df, aes(x = decile_label, y = comp_scores)) + geom_boxplot() + ylim(0, 1) + ylab('Glutamatergic %') +
  xlab('Glutamatergic percentage')
g3 = ggplot(temp_comp_df, aes(x = decile_label, y = egad_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Glutamatergic Co-expression module score') +
  xlab('Glutamatergic percentage')

g4 = grid.arrange(g2, g1, nrow = 2)
ggsave(plot = g4, filename = 'glut_comp_and_pres_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
g5 = grid.arrange(g2, g3, nrow = 2)
ggsave(plot = g5, filename = 'glut_comp_and_egad_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)

print('Glutamatergic preserved co-expression ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(pres_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(pres_score))

print('Glutamatergic EGAD ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(egad_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(egad_score))



comp_scores = comp_for_clustering[ ,'GABAergic']
#range(comp_scores)
decile_label = rep('NA', length = nrow(comp_for_clustering))
decile_label[comp_scores <= .10] = '[0-10%]'
decile_label[comp_scores > .10 & comp_scores <= .20] = '(10-20%]'
decile_label[comp_scores > .20 & comp_scores <= .30] = '(20-30%]'
decile_label[comp_scores > .30 & comp_scores <= .40] = '(30-40%]'
decile_label[comp_scores > .40 & comp_scores <= .50] = '(40-50%]'
decile_label[comp_scores > .50 & comp_scores <= .60] = '(50-60%]'
decile_label[comp_scores > .60 & comp_scores <= .70] = '(60-70%]'
decile_label[comp_scores > .70 & comp_scores <= .80] = '(70-80%]'
decile_label[comp_scores > .80 & comp_scores <= .90] = '(80-90%]'
#Grab the preserved co-expression scores of that cell-type and add the celltype percentage of the datasets
temp_comp_df = data.frame(sample_id = all_sample_meta$sample_ids[meta_index], pres_score = all_sample_meta$gaba_cons_coexp_metric[meta_index], 
                          egad_score = all_sample_meta$egad_auc_gaba_markers[meta_index],
                          decile_label = decile_label, comp_scores = comp_scores)
temp_comp_df$decile_label = factor(temp_comp_df$decile_label, levels = c('[0-10%]','(10-20%]','(20-30%]','(30-40%]','(40-50%]','(50-60%]','(60-70%]','(70-80%]','(80-90%]'))

g1 = ggplot(temp_comp_df, aes(x = decile_label, y = pres_score)) + geom_boxplot() + ylim(.4, 1) + ylab('GABAergic Preserved co-expression score') +
  xlab('GABAergic percentage') 
g2 = ggplot(temp_comp_df, aes(x = decile_label, y = comp_scores)) + geom_boxplot() + ylim(0, 1) + ylab('GABAergic %') +
  xlab('GABAergic percentage')
g3 = ggplot(temp_comp_df, aes(x = decile_label, y = egad_score)) + geom_boxplot() + ylim(.4, 1) + ylab('GABAergic Co-expression module score') +
  xlab('GABAergic percentage')

g4 = grid.arrange(g2, g1, nrow = 2)
ggsave(plot = g4, filename = 'gaba_comp_and_pres_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
g5 = grid.arrange(g2, g3, nrow = 2)
ggsave(plot = g5, filename = 'gaba_comp_and_egad_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)

print('GABAergic preserved co-expression ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(pres_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(pres_score))

print('GABAergic EGAD ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(egad_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(egad_score))



comp_scores = comp_for_clustering[ ,'Non-neuronal']
#range(comp_scores)
decile_label = rep('NA', length = nrow(comp_for_clustering))
decile_label[comp_scores <= .10] = '[0-10%]'
decile_label[comp_scores > .10 & comp_scores <= .20] = '(10-20%]'
decile_label[comp_scores > .20 & comp_scores <= .30] = '(20-30%]'
decile_label[comp_scores > .30 & comp_scores <= .40] = '(30-40%]'
decile_label[comp_scores > .40 & comp_scores <= .50] = '(40-50%]'
decile_label[comp_scores > .50 & comp_scores <= .60] = '(50-60%]'
#Grab the preserved co-expression scores of that cell-type and add the celltype percentage of the datasets
temp_comp_df = data.frame(sample_id = all_sample_meta$sample_ids[meta_index], pres_score = all_sample_meta$nonN_cons_coexp_metric[meta_index], 
                          egad_score = all_sample_meta$egad_auc_nonN_markers[meta_index],
                          decile_label = decile_label, comp_scores = comp_scores)
temp_comp_df$decile_label = factor(temp_comp_df$decile_label, levels = c('[0-10%]','(10-20%]','(20-30%]','(30-40%]','(40-50%]','(50-60%]'))

g1 = ggplot(temp_comp_df, aes(x = decile_label, y = pres_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Non-neuronal Preserved co-expression score') +
  xlab('Non-neuronal percentage') 
g2 = ggplot(temp_comp_df, aes(x = decile_label, y = comp_scores)) + geom_boxplot() + ylim(0, 1) + ylab('Non-neuronal %') +
  xlab('Non-neuronal percentage')
g3 = ggplot(temp_comp_df, aes(x = decile_label, y = egad_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Non-neuronal Co-expression module score') +
  xlab('Non-neuronal percentage')

g4 = grid.arrange(g2, g1, nrow = 2)
ggsave(plot = g4, filename = 'nonN_comp_and_pres_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
g5 = grid.arrange(g2, g3, nrow = 2)
ggsave(plot = g5, filename = 'nonN_comp_and_egad_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)

print('Non-neuronal preserved co-expression ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(pres_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(pres_score))

print('Non-neuronal EGAD ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(egad_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(egad_score))
```


And now the progenitor cell-types

```{r}

comp_scores = comp_for_clustering[ ,'Intermediate_Progenitor']
#range(comp_scores)
decile_label = rep('NA', length = nrow(comp_for_clustering))
decile_label[comp_scores <= .05] = '[0-5%]'
decile_label[comp_scores > .05 & comp_scores <= .10] = '(5-10%]'
decile_label[comp_scores > .10 & comp_scores <= .15] = '(10-15%]'
decile_label[comp_scores > .15 & comp_scores <= .20] = '(15-20%]'
#Grab the preserved co-expression scores of that cell-type and add the celltype percentage of the datasets
temp_comp_df = data.frame(sample_id = all_sample_meta$sample_ids[meta_index], pres_score = all_sample_meta$intProg_cons_coexp_metric[meta_index], 
                          egad_score = all_sample_meta$egad_auc_intProg_markers[meta_index],
                          decile_label = decile_label, comp_scores = comp_scores)
temp_comp_df$decile_label = factor(temp_comp_df$decile_label, levels = c('[0-5%]','(5-10%]','(10-15%]','(15-20%]'))

g1 = ggplot(temp_comp_df, aes(x = decile_label, y = pres_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Intermediate Progenitor Preserved co-expression score') +
  xlab('Intermediate Progenitor percentage') 
g2 = ggplot(temp_comp_df, aes(x = decile_label, y = comp_scores)) + geom_boxplot() + ylim(0, 1) + ylab('Intermediate Progenitor %') +
  xlab('Intermediate Progenitor percentage')
g3 = ggplot(temp_comp_df, aes(x = decile_label, y = egad_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Intermediate Progenitor Co-expression module score') +
  xlab('Intermediate Progenitor percentage')

g4 = grid.arrange(g2, g1, nrow = 2)
ggsave(plot = g4, filename = 'intProg_comp_and_pres_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
g5 = grid.arrange(g2, g3, nrow = 2)
ggsave(plot = g5, filename = 'intProg_comp_and_egad_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)

print('Intermediate Progenitor preserved co-expression ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-5%]') %>% pull(pres_score))
range(temp_comp_df %>% filter(decile_label != '[0-5%]') %>% pull(pres_score))

print('Intermediate Progenitor EGAD ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-5%]') %>% pull(egad_score))
range(temp_comp_df %>% filter(decile_label != '[0-5%]') %>% pull(egad_score))



comp_scores = comp_for_clustering[ ,'Neural_Progenitor']
#range(comp_scores)
decile_label = rep('NA', length = nrow(comp_for_clustering))
decile_label[comp_scores <= .10] = '[0-10%]'
decile_label[comp_scores > .10 & comp_scores <= .20] = '(10-20%]'
decile_label[comp_scores > .20 & comp_scores <= .30] = '(20-30%]'
decile_label[comp_scores > .30 & comp_scores <= .40] = '(30-40%]'
decile_label[comp_scores > .40 & comp_scores <= .50] = '(40-50%]'
decile_label[comp_scores > .50 & comp_scores <= .60] = '(50-60%]'
decile_label[comp_scores > .60 & comp_scores <= .70] = '(60-70%]'
decile_label[comp_scores > .70 & comp_scores <= .80] = '(70-80%]'
#Grab the preserved co-expression scores of that cell-type and add the celltype percentage of the datasets
temp_comp_df = data.frame(sample_id = all_sample_meta$sample_ids[meta_index], pres_score = all_sample_meta$nProg_cons_coexp_metric[meta_index], 
                          egad_score = all_sample_meta$egad_auc_nProg_markers[meta_index],
                          decile_label = decile_label, comp_scores = comp_scores)
temp_comp_df$decile_label = factor(temp_comp_df$decile_label, levels = c('[0-10%]','(10-20%]','(20-30%]','(30-40%]','(40-50%]','(50-60%]','(60-70%]','(70-80%]'))

g1 = ggplot(temp_comp_df, aes(x = decile_label, y = pres_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Neural Progenitor Preserved co-expression score') +
  xlab('Neural Progenitor percentage') 
g2 = ggplot(temp_comp_df, aes(x = decile_label, y = comp_scores)) + geom_boxplot() + ylim(0, 1) + ylab('Neural Progenitor %') +
  xlab('Neural Progenitor percentage')
g3 = ggplot(temp_comp_df, aes(x = decile_label, y = egad_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Neural Progenitor Co-expression module score') +
  xlab('Neural Progenitor percentage')

g4 = grid.arrange(g2, g1, nrow = 2)
ggsave(plot = g4, filename = 'nProg_comp_and_pres_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
g5 = grid.arrange(g2, g3, nrow = 2)
ggsave(plot = g5, filename = 'nProg_comp_and_egad_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)

print('Neural Progenitor preserved co-expression ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(pres_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(pres_score))

print('Neural Progenitor EGAD ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(egad_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(egad_score))



comp_scores = comp_for_clustering[ ,'Dividing_Progenitor']
#range(comp_scores)
decile_label = rep('NA', length = nrow(comp_for_clustering))
decile_label[comp_scores <= .10] = '[0-10%]'
decile_label[comp_scores > .10 & comp_scores <= .20] = '(10-20%]'
decile_label[comp_scores > .20 & comp_scores <= .30] = '(20-30%]'
decile_label[comp_scores > .30 & comp_scores <= .40] = '(30-40%]'
decile_label[comp_scores > .40 & comp_scores <= .50] = '(40-50%]'
decile_label[comp_scores > .50 & comp_scores <= .60] = '(50-60%]'
decile_label[comp_scores > .60 & comp_scores <= .70] = '(60-70%]'
decile_label[comp_scores > .70 & comp_scores <= .80] = '(70-80%]'
decile_label[comp_scores > .80 & comp_scores <= .90] = '(80-90%]'
decile_label[comp_scores > .90 & comp_scores <= 1] = '(90-100%]'
#Grab the preserved co-expression scores of that cell-type and add the celltype percentage of the datasets
temp_comp_df = data.frame(sample_id = all_sample_meta$sample_ids[meta_index], pres_score = all_sample_meta$dividing_cons_coexp_metric[meta_index], 
                          egad_score = all_sample_meta$egad_auc_divProg_markers[meta_index],
                          decile_label = decile_label, comp_scores = comp_scores)
temp_comp_df$decile_label = factor(temp_comp_df$decile_label, levels = c('[0-10%]','(10-20%]','(20-30%]','(30-40%]','(40-50%]','(50-60%]','(60-70%]','(70-80%]','(80-90%]','(90-100%]'))

g1 = ggplot(temp_comp_df, aes(x = decile_label, y = pres_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Dividing Progenitor Preserved co-expression score') +
  xlab('Dividing Progenitor percentage') 
g2 = ggplot(temp_comp_df, aes(x = decile_label, y = comp_scores)) + geom_boxplot() + ylim(0, 1) + ylab('Dividing Progenitor %') +
  xlab('Dividing Progenitor percentage')
g3 = ggplot(temp_comp_df, aes(x = decile_label, y = egad_score)) + geom_boxplot() + ylim(.4, 1) + ylab('Dividing Progenitor Co-expression module score') +
  xlab('Dividing Progenitor percentage')

g4 = grid.arrange(g2, g1, nrow = 2)
ggsave(plot = g4, filename = 'divProg_comp_and_pres_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)
g5 = grid.arrange(g2, g3, nrow = 2)
ggsave(plot = g5, filename = 'divProg_comp_and_egad_scores_v2.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 5, width = 7, useDingbats = F)

print('Dividing Progenitor preserved co-expression ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(pres_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(pres_score))

print('Dividing Progenitor EGAD ranges...')
range(temp_comp_df %>% filter(decile_label == '[0-10%]') %>% pull(egad_score))
range(temp_comp_df %>% filter(decile_label != '[0-10%]') %>% pull(egad_score))
```



Neural lineage cell-types compared to the Microglia/Immune cell types


```{r}


non_neural_organoid_df = all_sample_meta %>% select(Protocol.classification.region, intProg_cons_coexp_metric, nProg_cons_coexp_metric, glut_cons_coexp_metric, gaba_cons_coexp_metric, nonN_cons_coexp_metric, micro_cons_coexp_metric )

non_neural_organoid_df = reshape2::melt(non_neural_organoid_df)

non_neural_organoid_df$data_label = as.character(non_neural_organoid_df$Protocol.classification.region)
non_neural_organoid_df$data_label[as.character(non_neural_organoid_df$Protocol.classification.region) %in% c('vascular organoid','iPSC-microglia')] = 'Non-neural organoid'
non_neural_organoid_df$data_label[!as.character(non_neural_organoid_df$Protocol.classification.region) %in% c('vascular organoid','iPSC-microglia')] = 'Neural organoid'

non_neural_organoid_df$marker_label = as.character(non_neural_organoid_df$variable)
non_neural_organoid_df$marker_label[as.character(non_neural_organoid_df$variable) == 'micro_cons_coexp_metric'] = 'Microglia/Immune'
non_neural_organoid_df$marker_label[as.character(non_neural_organoid_df$variable) != 'micro_cons_coexp_metric'] = 'Neural lineage cell-type'


ggplot(non_neural_organoid_df, aes(x = data_label, y = value)) + facet_wrap(~factor(marker_label, c('Neural lineage cell-type','Microglia/Immune'))) + 
  geom_boxplot() + ylab('Preserved co-expression score')


ggsave(filename = 'neural_non_neural_presCoexp_boxplots.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 2.5, width = 4.5, useDingbats = F)



non_neural_organoid_df = all_sample_meta %>% select(Protocol.classification.region, egad_auc_gaba_markers, egad_auc_glut_markers, egad_auc_nonN_markers,
                                                    egad_auc_intProg_markers, egad_auc_nProg_markers, egad_auc_micro_markers)

non_neural_organoid_df = reshape2::melt(non_neural_organoid_df)

non_neural_organoid_df$data_label = as.character(non_neural_organoid_df$Protocol.classification.region)
non_neural_organoid_df$data_label[as.character(non_neural_organoid_df$Protocol.classification.region) %in% c('vascular organoid','iPSC-microglia')] = 'Non-neural organoid'
non_neural_organoid_df$data_label[!as.character(non_neural_organoid_df$Protocol.classification.region) %in% c('vascular organoid','iPSC-microglia')] = 'Neural organoid'

non_neural_organoid_df$marker_label = as.character(non_neural_organoid_df$variable)
non_neural_organoid_df$marker_label[as.character(non_neural_organoid_df$variable) == 'egad_auc_micro_markers'] = 'Microglia/Immune'
non_neural_organoid_df$marker_label[as.character(non_neural_organoid_df$variable) != 'egad_auc_micro_markers'] = 'Neural lineage cell-type'


ggplot(non_neural_organoid_df, aes(x = data_label, y = value)) + facet_wrap(~factor(marker_label, c('Neural lineage cell-type','Microglia/Immune'))) + 
  geom_boxplot() + ylab('Co-expression module score')


ggsave(filename = 'neural_non_neural_egadCoexp_boxplots.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/organoid_composition/', 
       device = 'pdf', height = 2.5, width = 4.5, useDingbats = F)


```






























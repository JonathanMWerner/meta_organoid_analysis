



```{r}
library(Seurat)
library(data.table)
library(ggplot2)
library(ggrepel)
library(MetaMarkers)
library(dplyr)
library(ggridges)
library(gridExtra)
library(MetBrewer)
library(parallel)
library(ggExtra)
```


Get an AUC for a gene's expression
```{r}

gene_auc = function(gene_expression, label){
  label = as.logical(label)
  n1 = sum(label)
  n2 = sum(!label)
  R1 = sum(rank(gene_expression)[label])
  U1 = R1 - n1 * (n1 + 1)/2
  auc = U1/(n1 * n2)
  return(auc)
}
```

Human BICCN metamarkers
Stephan got the top 1000 markers at each level of classification

```{r}
human_class_path = '/data/fischer/biccn_markers/human/class_markers_top1000.csv.gz'
human_subclass_path = '/data/fischer/biccn_markers/human/subclass_markers_top1000.csv.gz'
human_type_path = '/data/fischer/biccn_markers/human/type_markers_top1000.csv.gz'

human_class_markers = fread(human_class_path)

human_subclass_markers = fread(human_subclass_path)

human_type_markers = fread(human_type_path)
```

Human DE generated from the adult_BICCN_singlecell_data_MetaMarker_exploration notebook

```{r}
load(file = '/home/werner/projects/meta_qc_organoid/data/human_biccn/human_biccn_class_markers_seurat.Rdata')
human_DE = all_seurat_de_with_MM_stats
human_DE
```


These genes were generated later in the notebook, just checking whether they are strong markers for specific types later in the adult data

```{r}
strong_adult_fetal_gaba = c('DLX6-AS1','DLX1','ERBB4','SOX2-OT','ARX','GAD2','GAD1', 'MAF')
strong_fetal_gaba = c('DCX','PLS3','DLX2','DLX5','SOX4','PDE4DIP','TCF4','CCDC88A','PFN2','MALAT1','MEG3','CXCR4')


strong_adult_fetal_glut = c('NEUROD6','NEUROD2','SATB2','NELL2')
strong_fetal_glut = c('SLA','GPM6A','ZBTB18','STMN2','MLLT3','TUBA1A','RTN1','MYT1L','GRIA2','TMSB10','STMN1','CSRP2','BCL11A','SRGAP1','RBFOX1','FOXG1')

```

```{r}
table(human_subclass_markers$cell_type)


```



```{r}
marker_num = 6

filter(human_class_markers, gene == strong_fetal_glut[marker_num] ) %>% arrange(rank)
filter(human_subclass_markers, gene == strong_fetal_glut[marker_num] ) %>% arrange(rank)
filter(human_type_markers, gene == strong_fetal_glut[marker_num] ) %>% arrange(rank)
```






```{r}

table(human_class_markers$cell_type)
filter(human_class_markers, rank <= 10)

```

Set colors for the class labels



```{r}
class_palette = met.brewer("Archambault", 20)
class_palette

class_palette = c('Non-neuronal' = class_palette[20], 'GABAergic' = class_palette[1], 'Glutamatergic' = class_palette[14], 'Neural_Progenitor' = class_palette[4], 
                  'Dividing_Progenitor' = class_palette[10], 'Intermediate_Progenitor' = class_palette[16], 'Microglia/Immune' = class_palette[18],
                  'other' = 'grey', 'unassigned' = 'grey')
class_palette

```





Start with the human feta datasets first, get a sense of exactly how well developmental data captures the adult markers

processed human fetal datasets
```{r}

#Perlman_antel is trash data

human_fetal_dataset_names = c( 'fan_fu', 'perlman_antel','poliodakis_geschwind_batch1', 'poliodakis_geschwind_batch2','shi_wang','zhou_lu','yu_sun',
                              'areal_GW14', 'areal_GW17','areal_GW18_2','areal_GW19', 'areal_GW19_2','areal_GW20','areal_GW20_31','areal_GW20_34','areal_GW25')
human_fetal_dataset_paths = list('/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/fan_fu_seurat_processed.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/perlman_antel_seurat_processed.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/poliodakis_geschwind_batch1_seurat_processed.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/poliodakis_geschwind_batch2_seurat_processed.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/shi_wang_seurat_processed.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/zhou_lu_seurat_processed.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/yu_sun_integrated_seurat_processed.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW14.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW17.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW18_2.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW19.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW19_2.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20_31.Rdata', 
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20_34.Rdata',
                                 '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW25.Rdata')

names(human_fetal_dataset_paths)= human_fetal_dataset_names 


```



```{r}
human_fetal_dataset_paths[[1]]

```



Get the datasets with annotations
See how well the adult markers do in classifying the fetal cells
Do a per gene assessment, pull out the genes that are actually driving the performance


How many of these are top adult markers?

Get the fetal MetaMarkers
  Can't pull out really strong fetal metamarkers
  My thought is temporal variability across the fetal datasets
  
Can we borrow the idea of metamarkers, compile lists of markers that classify well in the fetal data, just the best in each dataset.
What is the overlap? Do these fetal markers do a better job identifying cell populations in the non annotated fetal data than the adult markers?

Eventually in the organoids, do they recapitulate the small adult signature that's present in the fetal? How well do the fetal markers do in identifying organoid cell populations?



```{r}

load(human_fetal_dataset_paths$fan_fu)
load(human_fetal_dataset_paths$poliodakis_geschwind_batch1)
load(human_fetal_dataset_paths$poliodakis_geschwind_batch2)

#areal datasets, labeled as GW14_merged_dataset, GW17_merged_dataset, ect
load(human_fetal_dataset_paths$areal_GW14)
load(human_fetal_dataset_paths$areal_GW17)
load(human_fetal_dataset_paths$areal_GW18_2)

load(human_fetal_dataset_paths$areal_GW19)
load(human_fetal_dataset_paths$areal_GW19_2)
load(human_fetal_dataset_paths$areal_GW20)
load(human_fetal_dataset_paths$areal_GW20_31)

load(human_fetal_dataset_paths$areal_GW20_34)
load(human_fetal_dataset_paths$areal_GW25)
```

```{r}

rm(GW14_merged_dataset, GW17_merged_dataset, GW18_2_merged_dataset, fan_fu_dataset, poliodakis_dataset_batch1, poliodakis_dataset_batch2, GW19_merged_dataset, GW20_merged_dataset, GW20_31_merged_dataset, GW25_merged_dataset, fan_fu_dataset, poliodakis_dataset_batch1, poliodakis_dataset_batch2)
gc()
```



Add the class level annotations to each dataset
For fan_fu, which doesnt have dividing progenitor annotations, use Seurat's default cell cycle assignment. Label the progenitors that are in S or G2/M phase as the dividing progenitors 

```{r}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes

fan_fu_dataset <- CellCycleScoring(fan_fu_dataset, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)
DimPlot(fan_fu_dataset, group.by = 'type')
DimPlot(fan_fu_dataset, group.by = 'Phase')
```



```{r}
fan_glutamatergic = c('EX_cor')
fan_nonNeuronal = c('Astro','Oligo')
fan_progenitor = c('NPC')
fan_gabaergic = c('IN_cor')
fan_other = c('CR', 'PONS_neu', 'Endo', 'Blood', 'Immune')

labeled_classes = rep('other', length = ncol(fan_fu_dataset))
labeled_classes[fan_fu_dataset[[]]$type %in% fan_nonNeuronal] = 'Non-neuronal'
labeled_classes[fan_fu_dataset[[]]$type %in% fan_gabaergic] = 'GABAergic'
labeled_classes[fan_fu_dataset[[]]$type %in% fan_glutamatergic] = 'Glutamatergic'
labeled_classes[fan_fu_dataset[[]]$type %in% fan_progenitor] = 'Neural_Progenitor'
labeled_classes[fan_fu_dataset[[]]$type %in% fan_progenitor & fan_fu_dataset$Phase %in% c('S','G2M')] = 'Dividing_Progenitor'

table(labeled_classes)

fan_fu_dataset[['labeled_classes']] = labeled_classes
DimPlot(fan_fu_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(fan_fu_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/fan_fu_seurat_processed.Rdata')
```

```{r}
table(poliodakis_dataset_batch1$Cluster)

```


```{r}
poliodakis_glutamatergic = c('ExDp1','ExDp2','ExM','ExM-U','ExN')
poliodakis_nonNeuronal = c('OPC')
poliodakis_micro = c('Mic')
poliodakis_gabaergic = c('InCGE','InMGE')
poliodakis_progenitor = c('vRG','oRG')
poliodakis_Intprogenitor = c('IP')
poliodakis_Divprogenitor = c('PgG2M','PgS')

labeled_classes = rep('other', length = ncol(poliodakis_dataset_batch1))
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_nonNeuronal] = 'Non-neuronal'
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_micro] = 'Microglia/Immune'
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_gabaergic] = 'GABAergic'
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_glutamatergic] = 'Glutamatergic'
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_progenitor] = 'Neural_Progenitor'
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[poliodakis_dataset_batch1[[]]$Cluster %in% poliodakis_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)


poliodakis_dataset_batch1[['labeled_classes']] = labeled_classes
DimPlot(poliodakis_dataset_batch1, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(poliodakis_dataset_batch1, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/poliodakis_geschwind_batch1_seurat_processed.Rdata')

labeled_classes = rep('other', length = ncol(poliodakis_dataset_batch2))
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_nonNeuronal] = 'Non-neuronal'
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_micro] = 'Microglia/Immune'
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_gabaergic] = 'GABAergic'
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_glutamatergic] = 'Glutamatergic'
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_progenitor] = 'Neural_Progenitor'
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[poliodakis_dataset_batch2[[]]$Cluster %in% poliodakis_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)


poliodakis_dataset_batch2[['labeled_classes']] = labeled_classes
DimPlot(poliodakis_dataset_batch2, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(poliodakis_dataset_batch2, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/poliodakis_geschwind_batch2_seurat_processed.Rdata')

```


Areal datasets

```{r}
table(GW14_merged_dataset$cell.type)

gw14_glutamtergic = c('Neuron')
gw14_gabaergic = c('Interneuron')
gw14_nonNeuronal = c('Astrocyte')
gw14_micro = c('Microglia')
gw14_progenitor = c('RG')
gw14_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW14_merged_dataset))
labeled_classes[GW14_merged_dataset$cell.type %in% gw14_glutamtergic] = 'Glutamatergic'
labeled_classes[GW14_merged_dataset$cell.type %in% gw14_gabaergic] = 'GABAergic'
labeled_classes[GW14_merged_dataset$cell.type %in% gw14_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW14_merged_dataset$cell.type %in% gw14_micro] = 'Microglia/Immune'
labeled_classes[GW14_merged_dataset$cell.type %in% gw14_progenitor] = 'Neural_Progenitor'
labeled_classes[GW14_merged_dataset$cell.type %in% gw14_Divprogenitor] = 'Dividing_Progenitor'

GW14_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW14_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW14_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW14.Rdata')
```

```{r}
table(GW17_merged_dataset$cell.type)

GW17_glutamtergic = c('Neuron')
GW17_gabaergic = c('Interneuron')
GW17_nonNeuronal = c()
GW17_progenitor = c('RG')
GW17_Intprogenitor = c('IPC')
GW17_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW17_merged_dataset))
labeled_classes[GW17_merged_dataset$cell.type %in% GW17_glutamtergic] = 'Glutamatergic'
labeled_classes[GW17_merged_dataset$cell.type %in% GW17_gabaergic] = 'GABAergic'
labeled_classes[GW17_merged_dataset$cell.type %in% GW17_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW17_merged_dataset$cell.type %in% GW17_progenitor] = 'Neural_Progenitor'
labeled_classes[GW17_merged_dataset$cell.type %in% GW17_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW17_merged_dataset$cell.type %in% GW17_Divprogenitor] = 'Dividing_Progenitor'

GW17_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW17_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW17_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW17.Rdata')
```

```{r}
table(GW18_2_merged_dataset$cell.type)

GW18_2_glutamtergic = c('Neuron')
GW18_2_gabaergic = c('Interneuron')
GW18_2_nonNeuronal = c('Astrocyte', 'Oligo')
GW18_2_micro = c( 'Microglia')
GW18_2_progenitor = c('RG')
GW18_2_Intprogenitor = c('IPC')
GW18_2_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW18_2_merged_dataset))
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_glutamtergic] = 'Glutamatergic'
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_gabaergic] = 'GABAergic'
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_micro] = 'Microglia/Immune'
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_progenitor] = 'Neural_Progenitor'
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW18_2_merged_dataset$cell.type %in% GW18_2_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW18_2_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW18_2_merged_dataset, group.by = 'labeled_classes', raster = F) + scale_color_manual(values = class_palette)
save(GW18_2_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW18_2.Rdata')
```


```{r}
table(GW19_merged_dataset$cell.type)

GW19_glutamtergic = c('Neuron')
GW19_gabaergic = c('Interneuron')
GW19_nonNeuronal = c('Astrocyte', 'Oligo')
GW19_micro = c( 'Microglia')
GW19_progenitor = c('RG')
GW19_Intprogenitor = c('IPC')
GW19_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW19_merged_dataset))
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_glutamtergic] = 'Glutamatergic'
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_gabaergic] = 'GABAergic'
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_micro] = 'Microglia/Immune'
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_progenitor] = 'Neural_Progenitor'
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW19_merged_dataset$cell.type %in% GW19_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW19_merged_dataset$labeled_classes = labeled_classes

DimPlot(GW19_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW19_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW19.Rdata')
```



```{r}
table(GW19_2_merged_dataset$cell.type)

GW19_2_glutamtergic = c('Neuron')
GW19_2_gabaergic = c('Interneuron')
GW19_2_nonNeuronal = c('Astrocyte', 'Oligo')
GW19_2_micro = c( 'Microglia')
GW19_2_progenitor = c('RG')
GW19_2_Intprogenitor = c('IPC')
GW19_2_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW19_2_merged_dataset))
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_glutamtergic] = 'Glutamatergic'
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_gabaergic] = 'GABAergic'
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_micro] = 'Microglia/Immune'
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_progenitor] = 'Neural_Progenitor'
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW19_2_merged_dataset$cell.type %in% GW19_2_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW19_2_merged_dataset$labeled_classes = labeled_classes

DimPlot(GW19_2_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW19_2_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW19_2.Rdata')
```



```{r}
table(GW20_merged_dataset$cell.type)

GW20_glutamtergic = c('Neuron')
GW20_gabaergic = c('Interneuron')
GW20_nonNeuronal = c('Astrocyte', 'Oligo')
GW20_micro = c( 'Microglia')
GW20_progenitor = c('RG')
GW20_Intprogenitor = c('IPC')
GW20_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW20_merged_dataset))
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_glutamtergic] = 'Glutamatergic'
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_gabaergic] = 'GABAergic'
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_micro] = 'Microglia/Immune'
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_progenitor] = 'Neural_Progenitor'
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW20_merged_dataset$cell.type %in% GW20_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW20_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW20_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW20_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20.Rdata')

```


```{r}
table(GW20_31_merged_dataset$cell.type)

GW20_31_glutamtergic = c('Neuron')
GW20_31_gabaergic = c('Interneuron')
GW20_31_nonNeuronal = c('Astrocyte', 'Oligo')
GW20_31_micro = c( 'Microglia')
GW20_31_progenitor = c('RG')
GW20_31_Intprogenitor = c('IPC')
GW20_31_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW20_31_merged_dataset))
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_glutamtergic] = 'Glutamatergic'
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_gabaergic] = 'GABAergic'
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_micro] = 'Microglia/Immune'
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_progenitor] = 'Neural_Progenitor'
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW20_31_merged_dataset$cell.type %in% GW20_31_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW20_31_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW20_31_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW20_31_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20_31.Rdata')

```

```{r}
table(GW20_34_merged_dataset$cell.type)

GW20_34_glutamtergic = c('Neuron')
GW20_34_gabaergic = c('Interneuron')
GW20_34_nonNeuronal = c('Astrocyte', 'Oligo')
GW20_34_micro = c( 'Microglia')
GW20_34_progenitor = c('RG')
GW20_34_Intprogenitor = c( 'IPC')
GW20_34_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW20_34_merged_dataset))
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_glutamtergic] = 'Glutamatergic'
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_gabaergic] = 'GABAergic'
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_micro] = 'Microglia/Immune'
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_progenitor] = 'Neural_Progenitor'
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW20_34_merged_dataset$cell.type %in% GW20_34_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW20_34_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW20_34_merged_dataset, group.by = 'labeled_classes') + scale_color_manual(values = class_palette)
save(GW20_34_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW20_34.Rdata')

```



```{r}
table(GW25_merged_dataset$cell.type)

GW25_glutamtergic = c('Neuron')
GW25_gabaergic = c('Interneuron')
GW25_nonNeuronal = c('Astrocyte',  'Oligo')
GW25_micro = c( 'Microglia')
GW25_progenitor = c('RG')
GW25_Intprogenitor = c( 'IPC')
GW25_Divprogenitor = c('Dividing')

labeled_classes = rep('other', length = ncol(GW25_merged_dataset))
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_glutamtergic] = 'Glutamatergic'
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_gabaergic] = 'GABAergic'
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_nonNeuronal] = 'Non-neuronal'
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_micro] = 'Microglia/Immune'
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_progenitor] = 'Neural_Progenitor'
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_Intprogenitor] = 'Intermediate_Progenitor'
labeled_classes[GW25_merged_dataset$cell.type %in% GW25_Divprogenitor] = 'Dividing_Progenitor'
table(labeled_classes)

GW25_merged_dataset$labeled_classes = labeled_classes
DimPlot(GW25_merged_dataset, group.by = 'labeled_classes', raster = F) + scale_color_manual(values = class_palette)
save(GW25_merged_dataset, file = '/home/werner/projects/meta_qc_organoid/data/seurat_objs/individual/areal_kreigstein_dataset/merged_with_metadata/GW25.Rdata')

```





Run metamarkers and test the accuracy of the default greedy assignment method

```{r}

test_MM_accuracy = function(num_markers, dataset, meta_markers){

  dataset_classes = names(table(dataset$labeled_classes))
  
  accuracy_matrix = matrix(nrow = num_markers, ncol = length(dataset_classes) + 1)
  colnames(accuracy_matrix) = c('all_classes', dataset_classes)
  rownames(accuracy_matrix) = as.character(1:num_markers)
  
  for(marker_set in 1:num_markers){
    
    filt_markers = filter(meta_markers, rank<=marker_set)
    
    #Run MetaMarker functions
    class_test = score_cells(dataset@assays$RNA@data,filt_markers)
    class_enrichment_test = compute_marker_enrichment(class_test)
    class_pred_test = assign_cells(class_test)
    
    #Get the accuracy of the simple MM assignment, add the true label to the metamarkers results
    class_pred_test = class_pred_test %>%
        mutate(true_label = dataset[[]]$labeled_classes)
    
    #Overall accuracy
    accuracy_matrix[marker_set, 'all_classes']  = mean(class_pred_test$predicted == class_pred_test$true_label)
    #For each class label, get the accuracy of that class
    for(class in 2:ncol(accuracy_matrix)){
      class_index = class_pred_test$true_label == colnames(accuracy_matrix)[class]
      accuracy_matrix[marker_set, class] = mean(class_pred_test$predicted[class_index] == class_pred_test$true_label[class_index])
    }
  }
  
  return(accuracy_matrix)
}


```




```{r}
test_markers = 200

poliodakis_mm_acc = test_MM_accuracy(test_markers, poliodakis_dataset, human_class_markers)
melt_poliodakis_matrix = reshape2::melt(poliodakis_mm_acc, varnames = c('num_adult_markers', 'class_label'), value.name = 'accuracy')

fan_fu_mm_acc = test_MM_accuracy(test_markers, fan_fu_dataset, human_class_markers)
melt_fan_fu_matrix = reshape2::melt(fan_fu_mm_acc, varnames = c('num_adult_markers', 'class_label'), value.name = 'accuracy')

areal_gw14_mm_acc = test_MM_accuracy(test_markers, GW14_merged_dataset, human_class_markers)
melt_areal_gw14_matrix = reshape2::melt(areal_gw14_mm_acc, varnames = c('num_adult_markers', 'class_label'), value.name = 'accuracy')

areal_gw17_mm_acc = test_MM_accuracy(test_markers, GW17_merged_dataset, human_class_markers)
melt_areal_gw17_matrix = reshape2::melt(areal_gw17_mm_acc, varnames = c('num_adult_markers', 'class_label'), value.name = 'accuracy')

areal_gw18_2_mm_acc = test_MM_accuracy(test_markers, GW18_2_merged_dataset, human_class_markers)
melt_areal_gw18_2_matrix = reshape2::melt(areal_gw18_2_mm_acc, varnames = c('num_adult_markers', 'class_label'), value.name = 'accuracy')

ggplot(melt_poliodakis_matrix , aes(x = num_adult_markers, y = accuracy)) + geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Poliodakis fetal dataset') + ylim(0,1)
ggplot(melt_fan_fu_matrix , aes(x = num_adult_markers, y = accuracy)) + geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Fan_fu fetal dataset')+ ylim(0,1)

ggplot(melt_areal_gw14_matrix , aes(x = num_adult_markers, y = accuracy)) + geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Areal GW14 dataset') + ylim(0,1)
ggplot(melt_areal_gw17_matrix , aes(x = num_adult_markers, y = accuracy)) + geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Areal GW17 dataset') + ylim(0,1)
ggplot(melt_areal_gw18_2_matrix , aes(x = num_adult_markers, y = accuracy)) + geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Areal GW18_2 dataset') + ylim(0,1)
```




```{r}

ggplot(filter(melt_poliodakis_matrix, class_label %in% c('GABAergic','Glutamatergic')), aes(x = num_adult_markers, y = accuracy)) +
  geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Poliodakis fetal dataset') + ylim(0,1)
ggplot(filter(melt_fan_fu_matrix, class_label %in% c('GABAergic','Glutamatergic')), aes(x = num_adult_markers, y = accuracy)) +
geom_point(size = .5, alpha = .5) + facet_wrap(~class_label) + ggtitle('Fan_fu fetal dataset') + ylim(0,1) 

```




For 50 and 100 adult markers, just get the stacked barplots of class assignments for the Glutamatergic and GABAergic cells

```{r}
filt_markers = filter(human_class_markers, rank<=200)

#Run MetaMarker functions
class_test = score_cells(poliodakis_dataset@assays$RNA@data,filt_markers)
class_enrichment_test = compute_marker_enrichment(class_test)
class_pred_test = assign_cells(class_test)

#Get the accuracy of the simple MM assignment, add the true label to the metamarkers results
class_pred_test = class_pred_test %>%
    mutate(true_label = poliodakis_dataset[[]]$labeled_classes)

predicted_class_summary = class_pred_test %>% filter(true_label %in% c('GABAergic','Glutamatergic')) %>% group_by(true_label, predicted ) %>% summarise(n = n())

ggplot(predicted_class_summary, aes(x = true_label, y = n, fill = predicted)) + geom_bar(position = 'fill', stat = 'identity') +
  scale_fill_manual(values = class_palette, breaks = c('GABAergic','Glutamatergic','Non-neuronal','unassigned')) +
  ylab('percent') + xlab('Fetal annotations') + ggtitle('Cortical fetal dataset 1: 200 adult MetaMarkers')

#ggsave(filename = 'poliodakis_adult_MM_predict_fetal_class_stackedBarplot.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/', 
#       device = 'pdf', height = 5, width = 6, useDingbats = F)

predicted_class_summary




#Run MetaMarker functions
class_test = score_cells(fan_fu_dataset@assays$RNA@data,filt_markers)
class_enrichment_test = compute_marker_enrichment(class_test)
class_pred_test = assign_cells(class_test)

#Get the accuracy of the simple MM assignment, add the true label to the metamarkers results
class_pred_test = class_pred_test %>%
    mutate(true_label = fan_fu_dataset[[]]$labeled_classes)

predicted_class_summary = class_pred_test %>% filter(true_label %in% c('GABAergic','Glutamatergic')) %>% group_by(true_label, predicted ) %>% summarise(n = n())

ggplot(predicted_class_summary, aes(x = true_label, y = n, fill = predicted)) + geom_bar(position = 'fill', stat = 'identity') +
  scale_fill_manual(values = class_palette, breaks = c('GABAergic','Glutamatergic','Non-neuronal','unassigned')) +
  ylab('percent') + xlab('Fetal annotations') + ggtitle('Cortical fetal dataset 2: 200 adult MetaMarkers')

#ggsave(filename = 'fan_fu_adult_MM_predict_fetal_class_stackedBarplot.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/', 
#       device = 'pdf', height = 5, width = 6, useDingbats = F)
predicted_class_summary
```

```{r}

enrichment_df = data.frame(t(class_enrichment_test))
ggplot(enrichment_df, aes(x = all.Glutamatergic, y = all.GABAergic)) + geom_point(alpha = .5, size = .5)
```


Now do a per gene assessment, get the AUC per metamarker for classifying the class labels in each fetal dataset
```{r}

gene_specific_aucs = function(adult_markers,adult_marker_label, dataset){

  #Adult markers present in the fetal dataset
  fetal_glut_markers = rownames(dataset)[rownames(dataset) %in% adult_markers$gene]
  adult_marker_label_vec = rep(adult_marker_label, length = length(fetal_glut_markers))
  
  #Get the adult rank of these genes
  adult_subset = adult_markers[adult_markers$gene %in% fetal_glut_markers, ]
  index = match(fetal_glut_markers, adult_subset$gene)
  adult_subset = adult_subset[index, ]
  adult_ranks = adult_subset$rank
  adult_auroc = adult_subset$auroc
  
  #Classes of the dataset
  dataset_classes = names(table(dataset$labeled_classes))
  
  #Matrix to hold everything
  auc_matrix = matrix(nrow = length(fetal_glut_markers), ncol = length(dataset_classes) + 4)
  colnames(auc_matrix) = c('gene','adult_class','adult_ranks', 'adult_auroc', dataset_classes)
  
  auc_matrix[ ,'gene'] = fetal_glut_markers
  auc_matrix[ , 'adult_class'] = adult_marker_label_vec
  auc_matrix[ , 'adult_ranks'] = adult_ranks
  auc_matrix[ , 'adult_auroc'] = adult_auroc
  
  for(i in 1:length(dataset_classes)){
    class = dataset_classes[i]
    
    class_labels = dataset$labeled_classes == class
    aucs_for_adult_markers = sapply(1:length(fetal_glut_markers), function(j) gene_auc(FetchData(dataset,fetal_glut_markers[j] )[ ,1], class_labels))
    auc_matrix[ ,class] = aucs_for_adult_markers
  
  }
  
  return(auc_matrix)

}
```


```{r}
top_adult_markers = filter(human_class_markers, rank <= 200 )
adult_glut_markers = filter(top_adult_markers, cell_type == 'Glutamatergic')
adult_gaba_markers = filter(top_adult_markers, cell_type == 'GABAergic')
adult_nonN_markers = filter(top_adult_markers, cell_type == 'Non-neuronal')


polio_adult_glut_performance = gene_specific_aucs(adult_glut_markers, 'Glutamatergic', poliodakis_dataset)
polio_adult_glut_performance = data.frame(polio_adult_glut_performance)
polio_adult_gaba_performance = gene_specific_aucs(adult_gaba_markers, 'GABAergic', poliodakis_dataset)
polio_adult_gaba_performance = data.frame(polio_adult_gaba_performance)
polio_adult_nonN_performance = gene_specific_aucs(adult_nonN_markers, 'Non-neuronal', poliodakis_dataset)
polio_adult_nonN_performance = data.frame(polio_adult_nonN_performance)


polio_adult_performance = rbind(polio_adult_glut_performance, polio_adult_gaba_performance, polio_adult_nonN_performance)
polio_adult_performance = reshape2::melt(polio_adult_performance, id.vars = c('gene', 'adult_class','adult_ranks', 'adult_auroc'), 
                                         measure.vars = c('GABAergic','Glutamatergic','Neural_Progenitor','Non.neuronal'), 
                                         value.name = 'AUC', variable.name = 'predicting_fetal_class')
polio_adult_performance$adult_ranks = as.numeric(polio_adult_performance$adult_ranks)
polio_adult_performance$AUC = as.numeric(polio_adult_performance$AUC)
polio_adult_performance$adult_auroc = as.numeric(polio_adult_performance$adult_auroc)

print('Done')
```

```{r}

adult_class_index = polio_adult_performance$adult_class == 'Glutamatergic'
ggplot(polio_adult_performance[adult_class_index, ], aes(x = adult_auroc, y = AUC)) + geom_point(size = .5, alpha = .5) +
  xlab('Adult Glutamatergic marker ranks') + ggtitle('Poliodakis fetal dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = polio_adult_performance$adult_class == 'GABAergic'
ggplot(polio_adult_performance[adult_class_index, ], aes(x = adult_auroc, y = AUC)) + geom_point(size = .5, alpha = .5)  +
  xlab('Adult GABAergic marker ranks') + ggtitle('Poliodakis fetal dataset: Adult GABAergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = polio_adult_performance$adult_class == 'Non-neuronal'
ggplot(polio_adult_performance[adult_class_index, ], aes(x = adult_auroc, y = AUC)) + geom_point(size = .5, alpha = .5)  +
  xlab('Adult Non-neuronal marker ranks') + ggtitle('Poliodakis fetal dataset: Adult Non-neuronal marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

```
Just plot the gaba and glut predictions

```{r}
auc_filter = .6
just_glut_df = filter(polio_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'Glutamatergic')
just_glut_df$label = rep(NA, nrow(just_glut_df))
just_glut_df$label[just_glut_df$AUC >= auc_filter] = just_glut_df$gene[just_glut_df$AUC >= auc_filter]

just_gaba_df = filter(polio_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'GABAergic')
just_gaba_df$label = rep(NA, nrow(just_gaba_df))
just_gaba_df$label[just_gaba_df$AUC >= auc_filter] = just_gaba_df$gene[just_gaba_df$AUC >= auc_filter]

ggplot(just_glut_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult Glutamatergic marker ranks') + 
  ggtitle('poliodakis fetal dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')

ggplot(just_gaba_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult GABAergic marker ranks') + 
  ggtitle('poliodakis fetal dataset: Adult GABAergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')
  


#Just plot the AUC distributions

polio_neuron_marker_df = rbind(just_glut_df, just_gaba_df)

ggplot(polio_neuron_marker_df, aes(x = predicting_fetal_class , y = AUC, label = label)) + geom_boxplot() +
  ggtitle('Cortical fetal dataset 1') + xlab('Fetal annotations') + ylab('Adult marker performance (AUC)' ) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed') +
  geom_label_repel(fill = 'white', box.padding = .25, force = 4, max.overlaps = 30)

#ggsave(filename = 'poliodakis_adult_MM_AUC_fetal_class_boxplot.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/', 
#       device = 'pdf', height = 5, width = 6, useDingbats = F)


```

```{r}
polio_neuron_marker_df$dataset = rep('dataset_1', nrow(polio_neuron_marker_df))
polio_neuron_marker_df
```




```{r}
fan_fu_adult_glut_performance = gene_specific_aucs(adult_glut_markers, 'Glutamatergic', fan_fu_dataset)
fan_fu_adult_glut_performance = data.frame(fan_fu_adult_glut_performance)
fan_fu_adult_gaba_performance = gene_specific_aucs(adult_gaba_markers, 'GABAergic', fan_fu_dataset)
fan_fu_adult_gaba_performance = data.frame(fan_fu_adult_gaba_performance)
fan_fu_adult_nonN_performance = gene_specific_aucs(adult_nonN_markers, 'Non-neuronal', fan_fu_dataset)
fan_fu_adult_nonN_performance = data.frame(fan_fu_adult_nonN_performance)


fan_fu_adult_performance = rbind(fan_fu_adult_glut_performance, fan_fu_adult_gaba_performance, fan_fu_adult_nonN_performance)
fan_fu_adult_performance = reshape2::melt(fan_fu_adult_performance, id.vars = c('gene', 'adult_class','adult_ranks', 'adult_auroc'), 
                                         measure.vars = c('GABAergic','Glutamatergic','Neural_Progenitor','Non.neuronal','other'), 
                                         value.name = 'AUC', variable.name = 'predicting_fetal_class')
fan_fu_adult_performance$adult_ranks = as.numeric(fan_fu_adult_performance$adult_ranks)
fan_fu_adult_performance$AUC = as.numeric(fan_fu_adult_performance$AUC)
fan_fu_adult_performance$adult_auroc = as.numeric(fan_fu_adult_performance$adult_auroc)

```


```{r}

adult_class_index = fan_fu_adult_performance$adult_class == 'Glutamatergic'
ggplot(fan_fu_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult Glutamatergic marker ranks') + ggtitle('fan_fu fetal dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = fan_fu_adult_performance$adult_class == 'GABAergic'
ggplot(fan_fu_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult GABAergic marker ranks') + ggtitle('fan_fu fetal dataset: Adult GABAergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = fan_fu_adult_performance$adult_class == 'Non-neuronal'
ggplot(fan_fu_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult Non-neuronal marker ranks') + ggtitle('fan_fu fetal dataset: Adult Non-neuronal marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

```

Just plot the gaba and glut predictions

```{r}
auc_filter = .6
just_glut_df = filter(fan_fu_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'Glutamatergic')
just_glut_df$label = rep(NA, nrow(just_glut_df))
just_glut_df$label[just_glut_df$AUC >= auc_filter] = just_glut_df$gene[just_glut_df$AUC >= auc_filter]

just_gaba_df = filter(fan_fu_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'GABAergic')
just_gaba_df$label = rep(NA, nrow(just_gaba_df))
just_gaba_df$label[just_gaba_df$AUC >= auc_filter] = just_gaba_df$gene[just_gaba_df$AUC >= auc_filter]

ggplot(just_glut_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult Glutamatergic marker ranks') + 
  ggtitle('fan_fu fetal dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')

ggplot(just_gaba_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult GABAergic marker ranks') + 
  ggtitle('fan_fu fetal dataset: Adult GABAergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')
  
#Just plot the AUC distributions

fan_fu_neuron_marker_df = rbind(just_glut_df, just_gaba_df)

ggplot(fan_fu_neuron_marker_df, aes(x = predicting_fetal_class , y = AUC, label = label)) + geom_boxplot() +
  ggtitle('Cortical fetal dataset 2') + xlab('Fetal annotations') + ylab('Adult marker performance (AUC)' ) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed') +
  geom_label_repel(fill = 'white', box.padding = .25, force = 4, max.overlaps = 30)

#ggsave(filename = 'fan_fu_adult_MM_AUC_fetal_class_boxplot.pdf', path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/', 
#       device = 'pdf', height = 5, width = 6, useDingbats = F)


fan_fu_neuron_marker_df$dataset = rep('dataset_2', nrow(fan_fu_neuron_marker_df))
```



Areal datasets

```{r}
areal_GW14_adult_glut_performance = gene_specific_aucs(adult_glut_markers, 'Glutamatergic', GW14_merged_dataset)
areal_GW14_adult_glut_performance = data.frame(areal_GW14_adult_glut_performance)
areal_GW14_adult_gaba_performance = gene_specific_aucs(adult_gaba_markers, 'GABAergic', GW14_merged_dataset)
areal_GW14_adult_gaba_performance = data.frame(areal_GW14_adult_gaba_performance)
areal_GW14_adult_nonN_performance = gene_specific_aucs(adult_nonN_markers, 'Non-neuronal', GW14_merged_dataset)
areal_GW14_adult_nonN_performance = data.frame(areal_GW14_adult_nonN_performance)


areal_GW14_adult_performance = rbind(areal_GW14_adult_glut_performance, areal_GW14_adult_gaba_performance, areal_GW14_adult_nonN_performance)
areal_GW14_adult_performance = reshape2::melt(areal_GW14_adult_performance, id.vars = c('gene', 'adult_class','adult_ranks', 'adult_auroc'), 
                                         measure.vars = c('GABAergic','Glutamatergic','Neural_Progenitor','Non.neuronal','other'), 
                                         value.name = 'AUC', variable.name = 'predicting_fetal_class')
areal_GW14_adult_performance$adult_ranks = as.numeric(areal_GW14_adult_performance$adult_ranks)
areal_GW14_adult_performance$AUC = as.numeric(areal_GW14_adult_performance$AUC)
areal_GW14_adult_performance$adult_auroc = as.numeric(areal_GW14_adult_performance$adult_auroc)

```


```{r}

adult_class_index = areal_GW14_adult_performance$adult_class == 'Glutamatergic'
ggplot(areal_GW14_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult Glutamatergic marker ranks') + ggtitle('GW14 areal dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index =areal_GW14_adult_performance$adult_class == 'GABAergic'
ggplot(areal_GW14_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult GABAergic marker ranks') + ggtitle('GW14 areal dataset: Adult GABAergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = areal_GW14_adult_performance$adult_class == 'Non-neuronal'
ggplot(areal_GW14_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult Non-neuronal marker ranks') + ggtitle('GW14 areal dataset: Adult Non-neuronal marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

```


Just plot the gaba and glut predictions

```{r}
auc_filter = .6
just_glut_df = filter(areal_GW14_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'Glutamatergic')
just_glut_df$label = rep(NA, nrow(just_glut_df))
just_glut_df$label[just_glut_df$AUC >= auc_filter] = just_glut_df$gene[just_glut_df$AUC >= auc_filter]

just_gaba_df = filter(areal_GW14_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'GABAergic')
just_gaba_df$label = rep(NA, nrow(just_gaba_df))
just_gaba_df$label[just_gaba_df$AUC >= auc_filter] = just_gaba_df$gene[just_gaba_df$AUC >= auc_filter]

ggplot(just_glut_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult Glutamatergic marker ranks') + 
  ggtitle('GW14 dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')

ggplot(just_gaba_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult GABAergic marker ranks') + 
  ggtitle('GW14 dataset: Adult GABAergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')
  
#Just plot the AUC distributions

GW14_areal_neuron_marker_df = rbind(just_glut_df, just_gaba_df)
GW14_areal_neuron_marker_df$dataset = rep('dataset_3', nrow(GW14_areal_neuron_marker_df))
```
```{r}
areal_GW17_adult_glut_performance = gene_specific_aucs(adult_glut_markers, 'Glutamatergic', GW17_merged_dataset)
areal_GW17_adult_glut_performance = data.frame(areal_GW17_adult_glut_performance)
areal_GW17_adult_gaba_performance = gene_specific_aucs(adult_gaba_markers, 'GABAergic', GW17_merged_dataset)
areal_GW17_adult_gaba_performance = data.frame(areal_GW17_adult_gaba_performance)
areal_GW17_adult_nonN_performance = gene_specific_aucs(adult_nonN_markers, 'Non-neuronal', GW17_merged_dataset)
areal_GW17_adult_nonN_performance = data.frame(areal_GW17_adult_nonN_performance)


areal_GW17_adult_performance = rbind(areal_GW17_adult_glut_performance, areal_GW17_adult_gaba_performance, areal_GW17_adult_nonN_performance)
areal_GW17_adult_performance = reshape2::melt(areal_GW17_adult_performance, id.vars = c('gene', 'adult_class','adult_ranks', 'adult_auroc'), 
                                         measure.vars = c('Glutamatergic','Neural_Progenitor','Non.neuronal','other'), 
                                         value.name = 'AUC', variable.name = 'predicting_fetal_class')
areal_GW17_adult_performance$adult_ranks = as.numeric(areal_GW17_adult_performance$adult_ranks)
areal_GW17_adult_performance$AUC = as.numeric(areal_GW17_adult_performance$AUC)
areal_GW17_adult_performance$adult_auroc = as.numeric(areal_GW17_adult_performance$adult_auroc)


auc_filter = .6
just_glut_df = filter(areal_GW17_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'Glutamatergic')
just_glut_df$label = rep(NA, nrow(just_glut_df))
just_glut_df$label[just_glut_df$AUC >= auc_filter] = just_glut_df$gene[just_glut_df$AUC >= auc_filter]

just_gaba_df = filter(areal_GW17_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'GABAergic')
just_gaba_df$label = rep(NA, nrow(just_gaba_df))
just_gaba_df$label[just_gaba_df$AUC >= auc_filter] = just_gaba_df$gene[just_gaba_df$AUC >= auc_filter]

ggplot(just_glut_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult Glutamatergic marker ranks') + 
  ggtitle('GW17 dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')

ggplot(just_gaba_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult GABAergic marker ranks') + 
  ggtitle('GW17 dataset: Adult GABAergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')
  
#Just plot the AUC distributions

GW17_areal_neuron_marker_df = rbind(just_glut_df, just_gaba_df)
GW17_areal_neuron_marker_df$dataset = rep('dataset_4', nrow(GW17_areal_neuron_marker_df))
```

```{r}
areal_GW18_2_adult_glut_performance = gene_specific_aucs(adult_glut_markers, 'Glutamatergic', GW18_2_merged_dataset)
areal_GW18_2_adult_glut_performance = data.frame(areal_GW18_2_adult_glut_performance)
areal_GW18_2_adult_gaba_performance = gene_specific_aucs(adult_gaba_markers, 'GABAergic', GW18_2_merged_dataset)
areal_GW18_2_adult_gaba_performance = data.frame(areal_GW18_2_adult_gaba_performance)
areal_GW18_2_adult_nonN_performance = gene_specific_aucs(adult_nonN_markers, 'Non-neuronal', GW18_2_merged_dataset)
areal_GW18_2_adult_nonN_performance = data.frame(areal_GW18_2_adult_nonN_performance)


areal_GW18_2_adult_performance = rbind(areal_GW18_2_adult_glut_performance, areal_GW18_2_adult_gaba_performance, areal_GW18_2_adult_nonN_performance)
areal_GW18_2_adult_performance = reshape2::melt(areal_GW18_2_adult_performance, id.vars = c('gene', 'adult_class','adult_ranks', 'adult_auroc'), 
                                         measure.vars = c('GABAergic','Glutamatergic','Neural_Progenitor','Non.neuronal'), 
                                         value.name = 'AUC', variable.name = 'predicting_fetal_class')
areal_GW18_2_adult_performance$adult_ranks = as.numeric(areal_GW18_2_adult_performance$adult_ranks)
areal_GW18_2_adult_performance$AUC = as.numeric(areal_GW18_2_adult_performance$AUC)
areal_GW18_2_adult_performance$adult_auroc = as.numeric(areal_GW18_2_adult_performance$adult_auroc)


auc_filter = .6
just_glut_df = filter(areal_GW18_2_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'Glutamatergic')
just_glut_df$label = rep(NA, nrow(just_glut_df))
just_glut_df$label[just_glut_df$AUC >= auc_filter] = just_glut_df$gene[just_glut_df$AUC >= auc_filter]

just_gaba_df = filter(areal_GW18_2_adult_performance, adult_class == predicting_fetal_class & predicting_fetal_class == 'GABAergic')
just_gaba_df$label = rep(NA, nrow(just_gaba_df))
just_gaba_df$label[just_gaba_df$AUC >= auc_filter] = just_gaba_df$gene[just_gaba_df$AUC >= auc_filter]

ggplot(just_glut_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult Glutamatergic marker ranks') + 
  ggtitle('GW18_2 dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')

ggplot(just_gaba_df, aes(x = adult_ranks, y = AUC, label = label)) + 
  geom_point( alpha = .5) + scale_x_reverse() + xlab('Adult GABAergic marker ranks') + 
  ggtitle('GW18_2 dataset: Adult GABAergic marker performance') + ylim(0,1) +
  geom_label_repel(fill = 'white', box.padding = .5) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed')
  
#Just plot the AUC distributions

GW18_2_areal_neuron_marker_df = rbind(just_glut_df, just_gaba_df)
GW18_2_areal_neuron_marker_df$dataset = rep('dataset_5', nrow(GW18_2_areal_neuron_marker_df))
```

```{r}
GW18_2_merged_dataset[[]]


```





```{r}


neuron_marker_df = rbind(polio_neuron_marker_df, fan_fu_neuron_marker_df, GW14_areal_neuron_marker_df, GW17_areal_neuron_marker_df)
neuron_marker_df

ggplot(filter(neuron_marker_df, adult_class == predicting_fetal_class & predicting_fetal_class == 'GABAergic' ), 
       aes(x = dataset , y = AUC, label = label)) + 
  geom_boxplot() +
  ggtitle('Adult GABAergic marker performance') + xlab('Fetal cortical datasets') + ylab('Adult marker performance (AUC)' ) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed') +
  geom_label_repel(fill = 'white', box.padding = .25, force = 4, max.overlaps = 30)

#ggsave(filename = 'fetal_cortical_gaba_adult_MM_AUC_fetal_class_boxplot.pdf', 
#       path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/', 
#       device = 'pdf', height = 5, width = 6, useDingbats = F)

ggplot(filter(neuron_marker_df, adult_class == predicting_fetal_class & predicting_fetal_class == 'Glutamatergic' ), 
       aes(x = dataset , y = AUC, label = label)) + 
  geom_boxplot() +
  ggtitle('Adult Glutamatergic marker performance') + xlab('Fetal cortical datasets') + ylab('Adult marker performance (AUC)' ) +
  geom_hline(yintercept = .6, col = 'red', linetype = 'dashed') +
  geom_label_repel(fill = 'white', box.padding = .25, force = 4, max.overlaps = 30)

#ggsave(filename = 'fetal_cortical_glut_adult_MM_AUC_fetal_class_boxplot.pdf', 
#       path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/', 
#       device = 'pdf', height = 5, width = 6, useDingbats = F)

```






look at the top Gaba ad Glut markers
```{r}

filter(fan_fu_adult_performance, adult_class == predicting_fetal_class & AUC >= .6)

top_adult_fan_fu = filter(fan_fu_adult_performance, adult_class == predicting_fetal_class & AUC >= .6)$gene

top_adult_fan_fu 
```

Commbine the top adult neural markers 

```{r}

top_adult_neural_markers = unique(c(top_adult_fan_fu, top_adult_polio))
top_adult_neural_markers
```

Get feature plots from each dataset for these markers


```{r}
for(i in 1:length(top_adult_neural_markers)){
  
  p1 = FeaturePlot(poliodakis_dataset, features = top_adult_neural_markers[i]) + ggtitle(sprintf('Cortical fetal dataset 1: %s', top_adult_neural_markers[i] ))
  file_name = sprintf('poliodakis_%s_umap.pdf',top_adult_neural_markers[i] )
  ggsave(p1, filename = file_name, path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/gene_umaps/', 
         device = 'pdf', height = 5, width = 6, useDingbats = F)
  
  
  p2 = FeaturePlot(fan_fu_dataset, features = top_adult_neural_markers[i]) + ggtitle(sprintf('Cortical fetal dataset 2: %s', top_adult_neural_markers[i] ))
  file_name = sprintf('fan_fu_%s_umap.pdf',top_adult_neural_markers[i] )
  ggsave(p2, filename = file_name, path = '/home/werner/projects/meta_qc_organoid/code/graphs/fetal_datasets/gene_umaps/', 
         device = 'pdf', height = 5, width = 6, useDingbats = F)
  
  
}


```









```{r}
table(kriegstein_dataset$labeled_classes)

```


```{r}
kriegstein_adult_glut_performance = gene_specific_aucs(adult_glut_markers, 'Glutamatergic', kriegstein_dataset)
kriegstein_adult_glut_performance = data.frame(kriegstein_adult_glut_performance)
kriegstein_adult_gaba_performance = gene_specific_aucs(adult_gaba_markers, 'GABAergic', kriegstein_dataset)
kriegstein_adult_gaba_performance = data.frame(kriegstein_adult_gaba_performance)
kriegstein_adult_nonN_performance = gene_specific_aucs(adult_nonN_markers, 'Non-neuronal', kriegstein_dataset)
kriegstein_adult_nonN_performance = data.frame(kriegstein_adult_nonN_performance)


kriegstein_adult_performance = rbind(kriegstein_adult_glut_performance, kriegstein_adult_gaba_performance, kriegstein_adult_nonN_performance)
kriegstein_adult_performance = reshape2::melt(kriegstein_adult_performance, id.vars = c('gene', 'adult_class','adult_ranks'), 
                                         measure.vars = c('Glutamatergic','Neural_Progenitor','Non.neuronal','other'), 
                                         value.name = 'AUC', variable.name = 'predicting_fetal_class')
kriegstein_adult_performance$adult_ranks = as.numeric(kriegstein_adult_performance$adult_ranks)
kriegstein_adult_performance$AUC = as.numeric(kriegstein_adult_performance$AUC)


```


```{r}

adult_class_index = kriegstein_adult_performance$adult_class == 'Glutamatergic'
ggplot(kriegstein_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult Glutamatergic marker ranks') + ggtitle('kriegstein fetal dataset: Adult Glutamatergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = kriegstein_adult_performance$adult_class == 'GABAergic'
ggplot(kriegstein_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult GABAergic marker ranks') + ggtitle('kriegstein fetal dataset: Adult GABAergic marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

adult_class_index = kriegstein_adult_performance$adult_class == 'Non-neuronal'
ggplot(kriegstein_adult_performance[adult_class_index, ], aes(x = adult_ranks, y = AUC)) + geom_point(size = .5, alpha = .5) + scale_x_reverse() +
  xlab('Adult Non-neuronal marker ranks') + ggtitle('kriegstein fetal dataset: Adult Non-neuronal marker performance') + ylim(0,1) +
  facet_wrap(~predicting_fetal_class)

```












Try and generate Fetal MetaMarkers

cannot use the kriegstein dataset at the moment, not properly normalized


Data is already normalized and the class labels are all in common 
Compute the dataset markers


```{r}

load(human_fetal_dataset_paths$fan_fu)
load(human_fetal_dataset_paths$poliodakis_geschwind_batch1)
load(human_fetal_dataset_paths$poliodakis_geschwind_batch2)

#areal datasets, labeled as GW14_merged_dataset, GW17_merged_dataset, ect
load(human_fetal_dataset_paths$areal_GW14)
load(human_fetal_dataset_paths$areal_GW17)
load(human_fetal_dataset_paths$areal_GW18_2)

load(human_fetal_dataset_paths$areal_GW19)
load(human_fetal_dataset_paths$areal_GW19_2)
load(human_fetal_dataset_paths$areal_GW20)
load(human_fetal_dataset_paths$areal_GW20_31)

load(human_fetal_dataset_paths$areal_GW20_34)
load(human_fetal_dataset_paths$areal_GW25)
```

```{r}

rm(GW14_merged_dataset, GW17_merged_dataset, GW18_2_merged_dataset, fan_fu_dataset, poliodakis_dataset_batch1, poliodakis_dataset_batch2, GW19_merged_dataset, GW19_2_merged_dataset, 
   GW20_merged_dataset, GW20_31_merged_dataset, GW20_34_merged_dataset, GW22_merged_dataset, GW25_merged_dataset)
gc()


```



```{r}
markers_poliodakis_1 = compute_markers(poliodakis_dataset_batch1@assays$RNA@data, poliodakis_dataset_batch1$labeled_classes)
markers_poliodakis_2 = compute_markers(poliodakis_dataset_batch2@assays$RNA@data, poliodakis_dataset_batch2$labeled_classes)
markers_fan_fu = compute_markers(fan_fu_dataset@assays$RNA@data, fan_fu_dataset$labeled_classes)

markers_areal_gw14 = compute_markers(GW14_merged_dataset@assays$RNA@data, GW14_merged_dataset$labeled_classes )
markers_areal_gw17 = compute_markers(GW17_merged_dataset@assays$RNA@data, GW17_merged_dataset$labeled_classes )
markers_areal_gw18_2 = compute_markers(GW18_2_merged_dataset@assays$RNA@data, GW18_2_merged_dataset$labeled_classes )

markers_areal_gw19 = compute_markers(GW19_merged_dataset@assays$RNA@data, GW19_merged_dataset$labeled_classes )
markers_areal_gw19_2 = compute_markers(GW19_2_merged_dataset@assays$RNA@data, GW19_2_merged_dataset$labeled_classes )

markers_areal_gw20 = compute_markers(GW20_merged_dataset@assays$RNA@data, GW20_merged_dataset$labeled_classes )
markers_areal_gw20_31 = compute_markers(GW20_31_merged_dataset@assays$RNA@data, GW20_31_merged_dataset$labeled_classes )

markers_areal_gw20_34 = compute_markers(GW20_34_merged_dataset@assays$RNA@data, GW20_34_merged_dataset$labeled_classes )
markers_areal_gw25 = compute_markers(GW25_merged_dataset@assays$RNA@data, GW25_merged_dataset$labeled_classes )

```



```{r}
table(markers_areal_gw18_2$cell_type)
filter(markers_areal_gw25, auroc >= .85)
```



Save the marker lists
```{r}
setwd("~/projects/meta_qc_organoid/code")

export_markers(markers_poliodakis_1, "6_26_24_annot_metaMarkers/poliodakis_batch1_fetal_class_markers.csv")
export_markers(markers_poliodakis_2, "6_26_24_annot_metaMarkers/poliodakis_batch2_fetal_class_markers.csv")
export_markers(markers_fan_fu, "6_26_24_annot_metaMarkers/fan_fu_fetal_class_markers.csv")
export_markers(markers_areal_gw14, "6_26_24_annot_metaMarkers/areal_GW14_fetal_class_markers.csv")
export_markers(markers_areal_gw17, "6_26_24_annot_metaMarkers/areal_GW17_fetal_class_markers.csv")
export_markers(markers_areal_gw18_2, "6_26_24_annot_metaMarkers/areal_GW18_2_fetal_class_markers.csv")

export_markers(markers_areal_gw19, "6_26_24_annot_metaMarkers/areal_GW19_fetal_class_markers.csv")
export_markers(markers_areal_gw19_2, "6_26_24_annot_metaMarkers/areal_GW19_2_fetal_class_markers.csv")

export_markers(markers_areal_gw20, "6_26_24_annot_metaMarkers/areal_GW20_fetal_class_markers.csv")
export_markers(markers_areal_gw20_31, "6_26_24_annot_metaMarkers/areal_GW20_31_fetal_class_markers.csv")

export_markers(markers_areal_gw20_34, "6_26_24_annot_metaMarkers/areal_GW20_34_fetal_class_markers.csv")
export_markers(markers_areal_gw25, "6_26_24_annot_metaMarkers/areal_GW25_fetal_class_markers.csv")


```


remove some of the datasets, taking up too much space

```{r}
rm(GW14_merged_dataset, GW17_merged_dataset, GW18_2_merged_dataset, GW19_merged_dataset, GW19_2_merged_dataset, GW20_31_merged_dataset, GW20_merged_dataset)
rm(GW20_34_merged_dataset, GW22_merged_dataset, GW25_merged_dataset)
gc()

```



Get the metamarkers
```{r}
markers = list(
    poliodakis_1 = read_markers("6_26_24_annot_metaMarkers/poliodakis_batch1_fetal_class_markers.csv.gz"),
    poliodakis_2 = read_markers("6_26_24_annot_metaMarkers/poliodakis_batch2_fetal_class_markers.csv.gz"),
    fan_fu = read_markers("6_26_24_annot_metaMarkers/fan_fu_fetal_class_markers.csv.gz"), 
    areal_GW14 = read_markers("6_26_24_annot_metaMarkers/areal_GW14_fetal_class_markers.csv.gz"),
    areal_GW18_2 = read_markers("6_26_24_annot_metaMarkers/areal_GW18_2_fetal_class_markers.csv.gz"),
    areal_GW19 = read_markers("6_26_24_annot_metaMarkers/areal_GW19_fetal_class_markers.csv.gz"),
    areal_GW19_2 = read_markers("6_26_24_annot_metaMarkers/areal_GW19_2_fetal_class_markers.csv.gz"),
    areal_GW20 = read_markers("6_26_24_annot_metaMarkers/areal_GW20_fetal_class_markers.csv.gz"),
    areal_GW20_31 = read_markers("6_26_24_annot_metaMarkers/areal_GW20_31_fetal_class_markers.csv.gz"),
    areal_GW20_34 = read_markers("6_26_24_annot_metaMarkers/areal_GW20_34_fetal_class_markers.csv.gz"),
    areal_GW25 = read_markers("6_26_24_annot_metaMarkers/areal_GW25_fetal_class_markers.csv.gz")
)


```


```{r}

fetal_meta_markers = make_meta_markers(markers, detailed_stats = TRUE)

#Ignore the 'other' class
fetal_meta_markers = filter(fetal_meta_markers, cell_type != 'other')

```

```{r}
fetal_meta_markers

```


Explore metamarker results


```{r}
fetal_meta_markers %>%
    filter(cell_type == "GABAergic" & rank <=50)

fetal_meta_markers %>%
    filter(cell_type == "Glutamatergic" & rank <=50)

fetal_meta_markers %>%
    filter(cell_type == "Non-neuronal" & rank <=50) 

fetal_meta_markers %>%
    filter(cell_type == "Neural_Progenitor" & rank <=50) 

fetal_meta_markers %>%
    filter(cell_type == "Intermediate_Progenitor" & rank <=50) 

fetal_meta_markers %>%
    filter(cell_type == "Dividing_Progenitor" & rank <=50) 

fetal_meta_markers %>%
    filter(cell_type == "Microglia/Immune" & rank <=50) 
```





```{r}

plot_pareto_markers(fetal_meta_markers, "Glutamatergic", min_recurrence = 0) + ggtitle(' fetal Glutamatergic Pareto front')
plot_pareto_markers(fetal_meta_markers, "GABAergic", min_recurrence = 0)+ ggtitle(' fetal GABAergic Pareto front')
plot_pareto_markers(fetal_meta_markers, "Non-neuronal", min_recurrence = 0)+ ggtitle(' fetal Non-Neuronal Pareto front')
plot_pareto_markers(fetal_meta_markers, "Neural_Progenitor", min_recurrence = 0)+ ggtitle(' fetal Neural progenitor Pareto front')
plot_pareto_markers(fetal_meta_markers, "Intermediate_Progenitor", min_recurrence = 0)+ ggtitle(' fetal Intermediate progenitor Pareto front')
plot_pareto_markers(fetal_meta_markers, "Dividing_Progenitor", min_recurrence = 0)+ ggtitle(' fetal Dividing progenitor Pareto front')

plot_pareto_markers(fetal_meta_markers, "Microglia/Immune", min_recurrence = 0)+ ggtitle(' fetal Microglia/Immune Pareto front')
```



